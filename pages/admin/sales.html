<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å–ä»¶çµå¸³ - POS ç³»çµ±</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../../config.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #0a84ff;
      --success: #28c76f;
      --danger: #ff3b30;
      --warning: #ff9500;
      --muted: #6b7280;
      --bg: #f5f7fa;
      --card-bg: #ffffff;
      --border: #e5e7eb;
    }

    body {
      font-family: "Microsoft JhengHei", "Noto Sans TC", -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: #1f2937;
      line-height: 1.6;
    }

    /* é ‚éƒ¨å°èˆª */
    .navbar {
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .navbar-brand {
      font-size: 20px;
      font-weight: bold;
      color: var(--primary);
    }

    .navbar-user {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-info {
      text-align: right;
      font-size: 14px;
    }

    .user-name {
      font-weight: 600;
    }

    .store-code {
      color: var(--muted);
      font-size: 12px;
    }

    /* ä¸»å®¹å™¨ */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    /* æœå°‹å€ */
    .search-section {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .search-box {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }

    .search-input {
      flex: 1;
      padding: 14px 16px;
      font-size: 18px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-family: monospace;
      letter-spacing: 1px;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: #0066cc;
    }

    .btn-success {
      background: var(--success);
      color: white;
      font-size: 18px;
      padding: 18px 32px;
    }

    .btn-success:hover {
      background: #22a55e;
    }

    .btn-secondary {
      background: var(--muted);
      color: white;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .search-hint {
      color: var(--muted);
      font-size: 14px;
    }

    /* è³‡è¨Šå¡ç‰‡ */
    .info-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: none;
    }

    .info-card.show {
      display: block;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border);
    }

    .card-title {
      font-size: 20px;
      font-weight: bold;
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }

    .status-å¾…å–ä»¶ {
      background: #fff8e6;
      color: #b86b00;
    }

    .status-åŒ…è£¹å·²é…é”å–ä»¶é–€å¸‚ {
      background: #f0f4ff;
      color: #2b6be6;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    .info-item {
      padding: 12px;
      background: var(--bg);
      border-radius: 8px;
    }

    .info-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .info-value {
      font-size: 16px;
      font-weight: 600;
    }

    .info-value.large {
      font-size: 20px;
      color: var(--primary);
    }

    /* é‡‘é¡å€ */
    .amount-section {
      background: linear-gradient(135deg, var(--success) 0%, #22c55e 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      text-align: center;
    }

    .amount-label {
      font-size: 16px;
      opacity: 0.9;
      margin-bottom: 8px;
    }

    .amount-value {
      font-size: 48px;
      font-weight: bold;
      font-family: "Courier New", monospace;
    }

    .amount-note {
      margin-top: 12px;
      font-size: 14px;
      opacity: 0.9;
    }

    /* æ“ä½œæŒ‰éˆ•å€ */
    .actions {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    /* ç©ºç‹€æ…‹ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    /* è¨Šæ¯æç¤º */
    .message {
      position: fixed;
      top: 80px;
      right: 24px;
      max-width: 400px;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      animation: slideIn 0.3s;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }

    .message.success {
      background: var(--success);
      color: white;
    }

    .message.error {
      background: var(--danger);
      color: white;
    }

    .message.warning {
      background: var(--warning);
      color: white;
    }

    /* ç¢ºèªå°è©±æ¡† */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }

    .modal-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 16px;
    }

    .modal-body {
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .form-input {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* ç™»å…¥é é¢ */
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-box {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 40px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .login-title {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 32px;
      color: var(--primary);
    }

    .hidden {
      display: none !important;
    }

    /* è²¨ä»¶é¸é …å¡ç‰‡ */
    .shipment-option {
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--bg);
    }

    .shipment-option:hover {
      border-color: var(--primary);
      background: white;
      box-shadow: 0 2px 8px rgba(10, 132, 255, 0.1);
    }

    .shipment-option-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .shipment-option-tracking {
      font-size: 16px;
      font-weight: bold;
      color: var(--primary);
    }

    .shipment-option-status {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .shipment-option-body {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      font-size: 14px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <!-- ç™»å…¥é é¢ -->
  <div id="loginPage" class="login-container">
    <div class="login-box">
      <h1 class="login-title">ğŸ›’ POS ç³»çµ±ç™»å…¥</h1>
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label" for="email">å¸³è™Ÿ</label>
          <input type="email" id="email" class="form-input" placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="password">å¯†ç¢¼</label>
          <input type="password" id="password" class="form-input" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">ç™»å…¥</button>
      </form>
    </div>
  </div>

  <!-- ä¸»é é¢ -->
  <div id="mainPage" class="hidden">
    <!-- å°èˆªåˆ— -->
    <nav class="navbar">
      <div class="navbar-brand">ğŸ›’ å–ä»¶çµå¸³ç³»çµ±</div>
      <div class="navbar-user">
        <div class="user-info">
          <div class="user-name" id="userName">åº—å“¡</div>
          <div class="store-code" id="storeCode">é–€å¸‚ä»£è™Ÿï¼šST001</div>
        </div>
        <button class="btn btn-secondary" onclick="logout()">ç™»å‡º</button>
      </div>
    </nav>

    <div class="container">
      <!-- æœå°‹å€ -->
      <div class="search-section">
        <div style="margin-bottom: 16px;">
          <label style="font-weight: 600; margin-bottom: 8px; display: block;">æŸ¥è©¢æ–¹å¼</label>
          <div style="display: flex; gap: 12px;">
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="radio" name="searchType" value="tracking" checked onchange="updateSearchPlaceholder()">
              <span>å–ä»¶å–®è™Ÿ</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="radio" name="searchType" value="phone" onchange="updateSearchPlaceholder()">
              <span>æ‰‹æ©Ÿæœ«ä¸‰ç¢¼</span>
            </label>
          </div>
        </div>
        <div class="search-box">
          <input 
            type="text" 
            id="searchInput" 
            class="search-input" 
            placeholder="è«‹æƒææˆ–è¼¸å…¥å–ä»¶å–®è™Ÿ..."
            autofocus
          >
          <button class="btn btn-primary" onclick="searchShipment()">æŸ¥è©¢</button>
          <button class="btn btn-secondary" onclick="resetSearch()">é‡ç½®</button>
        </div>
        <div class="search-hint" id="searchHint">ğŸ’¡ æç¤ºï¼šå¯ç›´æ¥ä½¿ç”¨æ¢ç¢¼æƒæå™¨æƒæå–ä»¶å–®è™Ÿ</div>
      </div>

      <!-- ç©ºç‹€æ…‹ -->
      <div id="emptyState" class="empty-state">
        <div class="empty-icon">ğŸ“¦</div>
        <h3>è«‹æƒææˆ–è¼¸å…¥å–ä»¶å–®è™Ÿ</h3>
        <p>ç³»çµ±å°‡è‡ªå‹•æŸ¥è©¢è²¨ç‰©è³‡è¨Š</p>
      </div>

      <!-- é¸æ“‡åˆ—è¡¨ï¼ˆæ‰‹æ©Ÿæœ«ä¸‰ç¢¼æŸ¥è©¢çµæœï¼‰ -->
      <div id="selectList" class="info-card" style="display: none;">
        <div class="card-header">
          <div class="card-title">æŸ¥è©¢åˆ°å¤šç­†è²¨ä»¶ï¼Œè«‹é¸æ“‡</div>
        </div>
        <div id="shipmentList" style="display: flex; flex-direction: column; gap: 12px;">
          <!-- å‹•æ…‹ç”Ÿæˆé¸é … -->
        </div>
      </div>

      <!-- è²¨ç‰©è³‡è¨Šå¡ç‰‡ -->
      <div id="infoCard" class="info-card">
        <div class="card-header">
          <div>
            <div class="card-title">è²¨ç‰©è³‡è¨Š</div>
            <div style="color: var(--muted); font-size: 14px; margin-top: 4px;">
              å–®è™Ÿï¼š<span id="displayTrackingNo"></span>
            </div>
          </div>
          <span id="displayStatus" class="status-badge">å¾…å–ä»¶</span>
        </div>

        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">æ”¶ä»¶äººå§“å</div>
            <div class="info-value" id="displayReceiverName">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">æ”¶ä»¶äººé›»è©±</div>
            <div class="info-value" id="displayReceiverPhone">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">å“å</div>
            <div class="info-value" id="displayItemName">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">åˆ°åº—æ™‚é–“</div>
            <div class="info-value" id="displayArrivalTime">-</div>
          </div>
        </div>

        <!-- é‡‘é¡å€ -->
        <div class="amount-section">
          <div class="amount-label">æ‡‰ä»˜é‡‘é¡</div>
          <div class="amount-value">$<span id="displayAmount">0</span></div>
          <div class="amount-note" id="amountNote"></div>
        </div>

        <!-- æ“ä½œæŒ‰éˆ• -->
        <div class="actions">
          <button class="btn btn-success" onclick="checkout()">âœ… çµå¸³å–ä»¶</button>
          <button class="btn btn-secondary" onclick="resetSearch()">ğŸ”„ é‡ç½®</button>
        </div>
      </div>
    </div>
  </div>

  <!-- èº«åˆ†é©—è­‰å°è©±æ¡† -->
  <div id="verifyModal" class="modal">
    <div class="modal-content">
      <div class="modal-title">ğŸªª èº«åˆ†é©—è­‰</div>
      <div class="modal-body">
        <p style="margin-bottom: 16px;">æ­¤ç‚ºå…ä»˜è²»å–ä»¶ï¼Œè«‹ç¢ºèªå–ä»¶äººèº«åˆ†ã€‚</p>
        <div class="form-group">
          <label class="form-label" for="idName">èº«åˆ†è­‰å§“å</label>
          <input 
            type="text" 
            id="idName" 
            class="form-input" 
            placeholder="è«‹è¼¸å…¥å–ä»¶äººèº«åˆ†è­‰å§“å"
          >
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeVerifyModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="confirmVerify()">ç¢ºèª</button>
      </div>
    </div>
  </div>

  <script>
    // Supabase åˆå§‹åŒ–
    const { createClient } = supabase;
    const supabaseClient = createClient(CONFIG.SUPABASE.URL, CONFIG.SUPABASE.ANON_KEY);

    // å…¨åŸŸè®Šæ•¸
    let currentUser = null;
    let currentShipment = null;
    let currentStore = null;

    // é é¢å…ƒç´ 
    const loginPage = document.getElementById('loginPage');
    const mainPage = document.getElementById('mainPage');
    const loginForm = document.getElementById('loginForm');
    const searchInput = document.getElementById('searchInput');
    const emptyState = document.getElementById('emptyState');
    const selectList = document.getElementById('selectList');
    const shipmentList = document.getElementById('shipmentList');
    const infoCard = document.getElementById('infoCard');
    const verifyModal = document.getElementById('verifyModal');

    // åˆå§‹åŒ–
    async function init() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session) {
        currentUser = session.user;
        await loadUserInfo();
        showMainPage();
      } else {
        showLoginPage();
      }

      // ç›£è½ Enter éµè‡ªå‹•æŸ¥è©¢
      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          searchShipment();
        }
      });
    }

    // é¡¯ç¤ºç™»å…¥é é¢
    function showLoginPage() {
      loginPage.classList.remove('hidden');
      mainPage.classList.add('hidden');
    }

    // é¡¯ç¤ºä¸»é é¢
    function showMainPage() {
      loginPage.classList.add('hidden');
      mainPage.classList.remove('hidden');
      searchInput.focus();
    }

    // ç™»å…¥
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email,
          password
        });

        if (error) throw error;

        currentUser = data.user;
        await loadUserInfo();
        showMainPage();
        showMessage('ç™»å…¥æˆåŠŸï¼', 'success');
      } catch (error) {
        showMessage('ç™»å…¥å¤±æ•—ï¼š' + error.message, 'error');
      }
    });

    // è¼‰å…¥ç”¨æˆ¶è³‡è¨Š
    async function loadUserInfo() {
      try {
        const { data: user, error } = await supabaseClient
          .from('users')
          .select('*')
          .eq('id', currentUser.id)
          .single();

        if (error) throw error;

        document.getElementById('userName').textContent = user.name;
        
        // è¼‰å…¥é–€å¸‚è³‡è¨Šï¼ˆé€™è£¡ä½¿ç”¨é è¨­é–€å¸‚ï¼Œå¯¦éš›æ‡‰è©²å¾ç”¨æˆ¶è³‡æ–™è®€å–ï¼‰
        currentStore = { store_code: 'ST001', store_name: 'BaiFa.GRP é«˜é›„ä¸‰æ°‘åº—' };
        document.getElementById('storeCode').textContent = `é–€å¸‚ï¼š${currentStore.store_name}`;
      } catch (error) {
        console.error('è¼‰å…¥ç”¨æˆ¶è³‡è¨Šå¤±æ•—ï¼š', error);
      }
    }

    // ç™»å‡º
    async function logout() {
      await supabaseClient.auth.signOut();
      currentUser = null;
      currentShipment = null;
      showLoginPage();
      showMessage('å·²ç™»å‡º', 'success');
    }

    // æ›´æ–°æœå°‹æ¡†ä½”ä½ç¬¦
    function updateSearchPlaceholder() {
      const searchType = document.querySelector('input[name="searchType"]:checked').value;
      const searchHint = document.getElementById('searchHint');
      
      if (searchType === 'tracking') {
        searchInput.placeholder = 'è«‹æƒææˆ–è¼¸å…¥å–ä»¶å–®è™Ÿ...';
        searchHint.textContent = 'ğŸ’¡ æç¤ºï¼šå¯ç›´æ¥ä½¿ç”¨æ¢ç¢¼æƒæå™¨æƒæå–ä»¶å–®è™Ÿ';
      } else {
        searchInput.placeholder = 'è«‹è¼¸å…¥æ‰‹æ©Ÿæœ«ä¸‰ç¢¼...';
        searchHint.textContent = 'ğŸ’¡ æç¤ºï¼šè¼¸å…¥æ”¶ä»¶äººæ‰‹æ©Ÿè™Ÿç¢¼çš„å¾Œä¸‰ç¢¼ï¼ˆä¾‹å¦‚ï¼š123ï¼‰';
      }
      searchInput.value = '';
      searchInput.focus();
    }

    // æŸ¥è©¢è²¨ç‰©
    async function searchShipment() {
      const searchValue = searchInput.value.trim();
      const searchType = document.querySelector('input[name="searchType"]:checked').value;
      
      if (!searchValue) {
        showMessage(searchType === 'tracking' ? 'è«‹è¼¸å…¥å–ä»¶å–®è™Ÿ' : 'è«‹è¼¸å…¥æ‰‹æ©Ÿæœ«ä¸‰ç¢¼', 'warning');
        return;
      }

      try {
        let shipments;

        if (searchType === 'tracking') {
          // ä½¿ç”¨å–ä»¶å–®è™ŸæŸ¥è©¢
          await logAction('pickup_scan', null, searchValue);

          const { data, error } = await supabaseClient
            .from('shipments')
            .select('*')
            .eq('tracking_no', searchValue)
            .single();

          if (error) throw error;

          if (!data) {
            showMessage('æ‰¾ä¸åˆ°æ­¤å–ä»¶å–®è™Ÿ', 'error');
            return;
          }

          shipments = [data];
        } else {
          // ä½¿ç”¨æ‰‹æ©Ÿæœ«ä¸‰ç¢¼æŸ¥è©¢
          await logAction('pickup_scan_by_phone', null, searchValue);

          const { data, error } = await supabaseClient
            .from('shipments')
            .select('*')
            .like('receiver_phone', `%${searchValue}`)
            .neq('status', 'å–ä»¶æˆåŠŸ')
            .order('created_at', { ascending: false });

          if (error) throw error;

          if (!data || data.length === 0) {
            showMessage('æ‰¾ä¸åˆ°ç¬¦åˆçš„è²¨ä»¶', 'error');
            return;
          }

          shipments = data;
        }

        // å¦‚æœæœ‰å¤šç­†çµæœï¼Œé¡¯ç¤ºé¸æ“‡åˆ—è¡¨
        if (shipments.length > 1) {
          showShipmentList(shipments);
          return;
        }

        // å–®ç­†çµæœï¼Œç›´æ¥é¡¯ç¤º
        const shipment = shipments[0];

        // æª¢æŸ¥ç‹€æ…‹
        if (shipment.status === 'å–ä»¶æˆåŠŸ') {
          showMessage('æ­¤è²¨ä»¶å·²å®Œæˆå–ä»¶', 'warning');
          return;
        }

        // æª¢æŸ¥æ˜¯å¦å·²æœ‰å–ä»¶è¨˜éŒ„
        const { data: existingTransaction } = await supabaseClient
          .from('pickup_transactions')
          .select('*')
          .eq('tracking_no', shipment.tracking_no)
          .eq('status', 'completed')
          .single();

        if (existingTransaction) {
          showMessage('æ­¤è²¨ä»¶å·²å®Œæˆå–ä»¶ï¼Œç„¡æ³•é‡è¤‡çµå¸³', 'error');
          return;
        }

        // é¡¯ç¤ºè²¨ç‰©è³‡è¨Š
        currentShipment = shipment;
        displayShipmentInfo(shipment);
      } catch (error) {
        console.error('æŸ¥è©¢å¤±æ•—ï¼š', error);
        showMessage('æŸ¥è©¢å¤±æ•—ï¼š' + error.message, 'error');
      }
    }

    // é¡¯ç¤ºè²¨ä»¶é¸æ“‡åˆ—è¡¨
    function showShipmentList(shipments) {
      emptyState.style.display = 'none';
      infoCard.classList.remove('show');
      selectList.style.display = 'block';

      shipmentList.innerHTML = shipments.map(shipment => `
        <div class="shipment-option" onclick="selectShipmentFromList(${shipment.id})">
          <div class="shipment-option-header">
            <div class="shipment-option-tracking">${shipment.tracking_no}</div>
            <div class="shipment-option-status status-${shipment.status.replace(/\s+/g, '')}">${shipment.status}</div>
          </div>
          <div class="shipment-option-body">
            <div>æ”¶ä»¶äººï¼š${shipment.receiver_name}</div>
            <div>é›»è©±ï¼š${shipment.receiver_phone}</div>
            <div>å“åï¼š${shipment.item_name || 'ä¸€èˆ¬è²¨ç‰©'}</div>
            <div>ä»£æ”¶ï¼š$${shipment.cod_amount || 0}</div>
          </div>
        </div>
      `).join('');
    }

    // å¾åˆ—è¡¨é¸æ“‡è²¨ä»¶
    async function selectShipmentFromList(shipmentId) {
      try {
        const { data: shipment, error } = await supabaseClient
          .from('shipments')
          .select('*')
          .eq('id', shipmentId)
          .single();

        if (error) throw error;

        // æª¢æŸ¥æ˜¯å¦å·²æœ‰å–ä»¶è¨˜éŒ„
        const { data: existingTransaction } = await supabaseClient
          .from('pickup_transactions')
          .select('*')
          .eq('tracking_no', shipment.tracking_no)
          .eq('status', 'completed')
          .single();

        if (existingTransaction) {
          showMessage('æ­¤è²¨ä»¶å·²å®Œæˆå–ä»¶ï¼Œç„¡æ³•é‡è¤‡çµå¸³', 'error');
          return;
        }

        selectList.style.display = 'none';
        currentShipment = shipment;
        displayShipmentInfo(shipment);
      } catch (error) {
        console.error('é¸æ“‡è²¨ä»¶å¤±æ•—ï¼š', error);
        showMessage('é¸æ“‡è²¨ä»¶å¤±æ•—ï¼š' + error.message, 'error');
      }
    }

    // é¡¯ç¤ºè²¨ç‰©è³‡è¨Š
    function displayShipmentInfo(shipment) {
      emptyState.style.display = 'none';
      infoCard.classList.add('show');

      document.getElementById('displayTrackingNo').textContent = shipment.tracking_no;
      document.getElementById('displayStatus').textContent = shipment.status;
      document.getElementById('displayStatus').className = `status-badge status-${shipment.status.replace(/\s+/g, '')}`;
      document.getElementById('displayReceiverName').textContent = shipment.receiver_name;
      document.getElementById('displayReceiverPhone').textContent = shipment.receiver_phone;
      document.getElementById('displayItemName').textContent = shipment.item_name || 'ä¸€èˆ¬è²¨ç‰©';
      document.getElementById('displayArrivalTime').textContent = formatDate(shipment.updated_at);

      // ä½¿ç”¨ä»£æ”¶é‡‘é¡æ¬„ä½
      const amount = shipment.cod_amount || 0;
      document.getElementById('displayAmount').textContent = amount;

      if (amount === 0) {
        document.getElementById('amountNote').textContent = 'ğŸ’³ å…ä»˜è²»å–ä»¶ï¼ˆé ä»˜æ¬¾ï¼‰';
      } else {
        document.getElementById('amountNote').textContent = 'ğŸ’µ è²¨åˆ°ä»˜æ¬¾';
      }
    }

    // çµå¸³
    async function checkout() {
      if (!currentShipment) return;

      const amount = parseInt(document.getElementById('displayAmount').textContent);

      // å¦‚æœæ˜¯å…ä»˜è²»ï¼Œéœ€è¦é©—è­‰èº«åˆ†
      if (amount === 0) {
        openVerifyModal();
        return;
      }

      // ç›´æ¥çµå¸³
      await completeCheckout(null);
    }

    // æ‰“é–‹èº«åˆ†é©—è­‰å°è©±æ¡†
    function openVerifyModal() {
      verifyModal.classList.add('show');
      document.getElementById('idName').value = '';
      document.getElementById('idName').focus();
    }

    // é—œé–‰èº«åˆ†é©—è­‰å°è©±æ¡†
    function closeVerifyModal() {
      verifyModal.classList.remove('show');
    }

    // ç¢ºèªèº«åˆ†é©—è­‰
    async function confirmVerify() {
      const idName = document.getElementById('idName').value.trim();
      
      if (!idName) {
        showMessage('è«‹è¼¸å…¥èº«åˆ†è­‰å§“å', 'warning');
        return;
      }

      closeVerifyModal();
      await completeCheckout(idName);
    }

    // å®Œæˆçµå¸³
    async function completeCheckout(idName) {
      try {
        const amount = parseInt(document.getElementById('displayAmount').textContent);
        
        // ç”Ÿæˆäº¤æ˜“å–®è™Ÿ
        const { data: transactionNo } = await supabaseClient.rpc('generate_transaction_no');

        // å»ºç«‹å–ä»¶äº¤æ˜“è¨˜éŒ„
        const { data: transaction, error } = await supabaseClient
          .from('pickup_transactions')
          .insert({
            transaction_no: transactionNo,
            shipment_id: currentShipment.id,
            tracking_no: currentShipment.tracking_no,
            receiver_name: currentShipment.receiver_name,
            receiver_phone: currentShipment.receiver_phone,
            receiver_id_name: idName,
            amount: amount,
            payment_method: amount === 0 ? 'free' : 'cash',
            is_cod: amount > 0,
            cashier_id: currentUser.id,
            cashier_name: document.getElementById('userName').textContent,
            store_code: currentStore.store_code,
            status: 'completed',
            print_count: 0
          })
          .select()
          .single();

        if (error) throw error;

        // è¨˜éŒ„çµå¸³å‹•ä½œ
        await logAction('pickup_checkout', transaction.transaction_no, transaction.tracking_no);

        // åˆ—å°æ”¶æ“š
        await printReceipt(transaction);

        // ç™¼é€ LINE æ”¶æ“šçµ¦é¡§å®¢
        await sendLineReceipt(transaction);

        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
        showMessage('âœ… å–ä»¶çµå¸³æˆåŠŸï¼å·²ä¸Šå‚³è‡³ Supabase ä¸¦åˆ—å°æ”¶æ“šã€‚', 'success');

        // é‡ç½®é é¢
        setTimeout(() => {
          resetSearch();
        }, 2000);
      } catch (error) {
        console.error('çµå¸³å¤±æ•—ï¼š', error);
        showMessage('çµå¸³å¤±æ•—ï¼š' + error.message, 'error');
      }
    }

    // åˆ—å°æ”¶æ“š
    async function printReceipt(transaction) {
      // æ›´æ–°åˆ—å°æ¬¡æ•¸
      await supabaseClient
        .from('pickup_transactions')
        .update({ 
          print_count: transaction.print_count + 1,
          last_print_time: new Date().toISOString()
        })
        .eq('id', transaction.id);

      // è¨˜éŒ„åˆ—å°å‹•ä½œ
      await logAction('print_receipt', transaction.transaction_no, transaction.tracking_no);

      // ç”Ÿæˆæ”¶æ“šå…§å®¹
      const receiptContent = generateReceiptContent(transaction);

      // æ‰“é–‹åˆ—å°è¦–çª—
      const printWindow = window.open('', '_blank', 'width=300,height=600');
      printWindow.document.write(receiptContent);
      printWindow.document.close();

      // å»¶é²åˆ—å°ï¼Œç­‰å¾…å…§å®¹è¼‰å…¥
      setTimeout(() => {
        printWindow.print();
        printWindow.close();
      }, 500);
    }

    // ç”Ÿæˆæ”¶æ“šå…§å®¹
    function generateReceiptContent(transaction) {
      const now = new Date();
      const dateStr = formatDate(now);

      return `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>å–ä»¶æ”¶æ“š</title>
          <style>
            @page {
              size: 58mm auto;
              margin: 0;
            }
            * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
            }
            body {
              width: 58mm;
              font-family: "Microsoft JhengHei", "Courier New", monospace;
              font-size: 9pt;
              padding: 5mm;
              line-height: 1.4;
            }
            .center {
              text-align: center;
            }
            .header {
              font-size: 14pt;
              font-weight: bold;
              margin-bottom: 3mm;
            }
            .divider {
              border-top: 1px dashed #000;
              margin: 3mm 0;
            }
            .row {
              display: flex;
              justify-content: space-between;
              margin: 1mm 0;
            }
            .label {
              font-weight: bold;
            }
            .amount {
              font-size: 12pt;
              font-weight: bold;
              margin: 2mm 0;
            }
            .footer {
              font-size: 8pt;
              margin-top: 3mm;
            }
          </style>
        </head>
        <body>
          <div class="center header">â˜… å–ä»¶æ”¶æ“š â˜…</div>
          <div class="center" style="font-size: 12pt; font-weight: bold; margin-bottom: 3mm;">
            ${CONFIG.UI.PRINT.COMPANY.NAME}
          </div>
          <div class="divider"></div>
          
          <div class="row">
            <span class="label">äº¤æ˜“å–®è™Ÿï¼š</span>
            <span>${transaction.transaction_no}</span>
          </div>
          <div class="row">
            <span class="label">å–ä»¶å–®è™Ÿï¼š</span>
            <span>${transaction.tracking_no}</span>
          </div>
          <div class="row">
            <span class="label">æ”¶ä»¶äººï¼š</span>
            <span>${transaction.receiver_name}</span>
          </div>
          <div class="row">
            <span class="label">çµå¸³äººå“¡ï¼š</span>
            <span>${transaction.cashier_name}</span>
          </div>
          <div class="row">
            <span class="label">äº¤æ˜“æ™‚é–“ï¼š</span>
            <span>${dateStr}</span>
          </div>
          <div class="row">
            <span class="label">é–€å¸‚ï¼š</span>
            <span>${currentStore.store_name}</span>
          </div>
          
          <div class="divider"></div>
          
          <div style="margin: 2mm 0;">
            <div class="label">å“é …ï¼š</div>
            <div class="row">
              <span>å–ä»¶ - ${transaction.tracking_no}</span>
              <span>$${transaction.amount}</span>
            </div>
          </div>
          
          <div class="divider"></div>
          
          <div class="row amount">
            <span>åˆè¨ˆé‡‘é¡ï¼š</span>
            <span>$${transaction.amount}</span>
          </div>
          
          ${transaction.amount === 0 ? '<div class="center">å…ä»˜è²»å–ä»¶</div>' : ''}
          ${transaction.receiver_id_name ? `<div class="center">å–ä»¶äººï¼š${transaction.receiver_id_name}</div>` : ''}
          
          <div class="divider"></div>
          
          <div class="center footer">
            æ„Ÿè¬æ‚¨çš„å–ä»¶ï¼Œæ­¡è¿å†åº¦å…‰è‡¨ï¼
          </div>
          <div class="center footer" style="margin-top: 2mm;">
            ${CONFIG.UI.PRINT.COMPANY.PHONE}
          </div>
        </body>
        </html>
      `;
    }

    // è¨˜éŒ„æ“ä½œæ—¥èªŒ
    // ç™¼é€ LINE æ”¶æ“šçµ¦é¡§å®¢
    async function sendLineReceipt(transaction) {
      try {
        console.log('ğŸ“¤ æº–å‚™ç™¼é€ LINE æ”¶æ“šçµ¦:', transaction.receiver_phone);

        // æŸ¥è©¢ LINE ç¶å®šè³‡è¨Š
        const { data: binding, error: bindingError } = await supabaseClient
          .from('line_bindings')
          .select('line_user_id, is_blocked')
          .eq('phone', transaction.receiver_phone)
          .single();

        if (bindingError || !binding) {
          console.log('â„¹ï¸ é¡§å®¢å°šæœªç¶å®š LINEï¼Œè·³éç™¼é€æ”¶æ“š');
          return false;
        }

        if (binding.is_blocked) {
          console.log('âš ï¸ é¡§å®¢å·²å°é–å®˜æ–¹å¸³è™Ÿï¼Œè·³éç™¼é€');
          return false;
        }

        // è¨ˆç®—æ‰¾é›¶
        const cash = transaction.amount > 0 ? Math.ceil(transaction.amount / 100) * 100 : 0;
        const change = cash - transaction.amount;

        // å»ºç«‹æ”¶æ“š Flex Message
        const receiptMessage = {
          type: "flex",
          altText: `ğŸ“® å–ä»¶æ”¶æ“š - ${transaction.transaction_no}`,
          contents: {
            type: "bubble",
            body: {
              type: "box",
              layout: "vertical",
              contents: [
                {
                  type: "text",
                  text: "RECEIPT",
                  weight: "bold",
                  color: "#1DB446",
                  size: "sm"
                },
                {
                  type: "text",
                  text: CONFIG.UI.PRINT.COMPANY.NAME,
                  weight: "bold",
                  size: "xxl",
                  margin: "md"
                },
                {
                  type: "text",
                  text: CONFIG.UI.PRINT.COMPANY.ADDRESS,
                  size: "xs",
                  color: "#aaaaaa",
                  wrap: true
                },
                {
                  type: "separator",
                  margin: "xxl"
                },
                {
                  type: "box",
                  layout: "vertical",
                  margin: "xxl",
                  spacing: "sm",
                  contents: [
                    {
                      type: "box",
                      layout: "horizontal",
                      contents: [
                        {
                          type: "text",
                          text: "å–è²¨æœå‹™",
                          size: "sm",
                          color: "#555555",
                          flex: 0
                        }
                      ]
                    },
                    {
                      type: "box",
                      layout: "horizontal",
                      contents: [
                        {
                          type: "text",
                          text: transaction.tracking_no,
                          size: "sm",
                          color: "#555555",
                          flex: 0
                        },
                        {
                          type: "text",
                          text: `$${transaction.amount}`,
                          size: "sm",
                          color: "#111111",
                          align: "end"
                        }
                      ]
                    },
                    {
                      type: "separator",
                      margin: "xxl"
                    },
                    {
                      type: "box",
                      layout: "horizontal",
                      margin: "xxl",
                      contents: [
                        {
                          type: "text",
                          text: "ITEMS",
                          size: "sm",
                          color: "#555555"
                        },
                        {
                          type: "text",
                          text: "1",
                          size: "sm",
                          color: "#111111",
                          align: "end"
                        }
                      ]
                    },
                    {
                      type: "box",
                      layout: "horizontal",
                      contents: [
                        {
                          type: "text",
                          text: "TOTAL",
                          size: "sm",
                          color: "#555555"
                        },
                        {
                          type: "text",
                          text: `$${transaction.amount}`,
                          size: "sm",
                          color: "#111111",
                          align: "end"
                        }
                      ]
                    },
                    ...(transaction.amount > 0 ? [
                      {
                        type: "box",
                        layout: "horizontal",
                        contents: [
                          {
                            type: "text",
                            text: "CASH",
                            size: "sm",
                            color: "#555555"
                          },
                          {
                            type: "text",
                            text: `$${cash}`,
                            size: "sm",
                            color: "#111111",
                            align: "end"
                          }
                        ]
                      },
                      {
                        type: "box",
                        layout: "horizontal",
                        contents: [
                          {
                            type: "text",
                            text: "CHANGE",
                            size: "sm",
                            color: "#555555"
                          },
                          {
                            type: "text",
                            text: `$${change}`,
                            size: "sm",
                            color: "#111111",
                            align: "end"
                          }
                        ]
                      }
                    ] : [])
                  ]
                },
                {
                  type: "separator",
                  margin: "xxl"
                },
                {
                  type: "box",
                  layout: "horizontal",
                  margin: "md",
                  contents: [
                    {
                      type: "text",
                      text: "PAYMENT ID",
                      size: "xs",
                      color: "#aaaaaa",
                      flex: 0
                    },
                    {
                      type: "text",
                      text: `#${transaction.transaction_no}`,
                      color: "#aaaaaa",
                      size: "xs",
                      align: "end"
                    }
                  ]
                }
              ]
            },
            styles: {
              footer: {
                separator: true
              }
            }
          }
        };

        // å‘¼å« Supabase RPC ç™¼é€æ”¶æ“š
        const { data, error } = await supabaseClient.rpc('send_line_notification', {
          p_line_user_id: binding.line_user_id,
          p_message: receiptMessage
        });

        if (error) {
          console.error('âŒ ç™¼é€ LINE æ”¶æ“šå¤±æ•—ï¼š', error);
          return false;
        }

        console.log('âœ… LINE æ”¶æ“šå·²ç™¼é€');

        // è¨˜éŒ„é€šçŸ¥
        await supabaseClient.from('line_notifications').insert({
          line_user_id: binding.line_user_id,
          phone: transaction.receiver_phone,
          notification_type: 'receipt',
          shipment_id: transaction.shipment_id,
          tracking_no: transaction.tracking_no,
          message_content: `å–ä»¶æ”¶æ“š - ${transaction.transaction_no}`,
          flex_message: receiptMessage,
          status: 'sent'
        });

        return true;

      } catch (error) {
        console.error('âŒ ç™¼é€ LINE æ”¶æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', error);
        // ä¸é˜»æ“‹çµå¸³æµç¨‹
        return false;
      }
    }

    async function logAction(action, transactionNo, trackingNo) {
      try {
        await supabaseClient
          .from('pos_logs')
          .insert({
            action,
            transaction_no: transactionNo,
            tracking_no: trackingNo,
            user_id: currentUser?.id,
            store_code: currentStore?.store_code,
            details: {
              timestamp: new Date().toISOString(),
              user_agent: navigator.userAgent
            }
          });
      } catch (error) {
        console.error('è¨˜éŒ„æ—¥èªŒå¤±æ•—ï¼š', error);
      }
    }

    // é‡ç½®æœå°‹
    function resetSearch() {
      searchInput.value = '';
      currentShipment = null;
      infoCard.classList.remove('show');
      selectList.style.display = 'none';
      emptyState.style.display = 'block';
      searchInput.focus();
    }

    // é¡¯ç¤ºè¨Šæ¯
    function showMessage(text, type = 'success') {
      const message = document.createElement('div');
      message.className = `message ${type}`;
      message.textContent = text;
      document.body.appendChild(message);

      setTimeout(() => {
        message.remove();
      }, 3000);
    }

    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(date) {
      const d = new Date(date);
      return d.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // åˆå§‹åŒ–
    init();
  </script>
</body>
</html>
      
