<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Âèñ‰ª∂ÁµêÂ∏≥ - POS Á≥ªÁµ±</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../../config.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #0a84ff;
      --success: #28c76f;
      --danger: #ff3b30;
      --warning: #ff9500;
      --muted: #6b7280;
      --bg: #f5f7fa;
      --card-bg: #ffffff;
      --border: #e5e7eb;
    }

    body {
      font-family: "Microsoft JhengHei", "Noto Sans TC", -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: #1f2937;
      line-height: 1.6;
    }

    /* È†ÇÈÉ®Â∞éËà™ */
    .navbar {
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .navbar-brand {
      font-size: 20px;
      font-weight: bold;
      color: var(--primary);
    }

    .navbar-user {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-info {
      text-align: right;
      font-size: 14px;
    }

    .user-name {
      font-weight: 600;
    }

    .store-code {
      color: var(--muted);
      font-size: 12px;
    }

    /* ‰∏ªÂÆπÂô® */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    /* ÊêúÂ∞ãÂçÄ */
    .search-section {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .search-box {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }

    .search-input {
      flex: 1;
      padding: 14px 16px;
      font-size: 18px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-family: monospace;
      letter-spacing: 1px;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: #0066cc;
    }

    .btn-success {
      background: var(--success);
      color: white;
      font-size: 18px;
      padding: 18px 32px;
    }

    .btn-success:hover {
      background: #22a55e;
    }

    .btn-secondary {
      background: var(--muted);
      color: white;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .search-hint {
      color: var(--muted);
      font-size: 14px;
    }

    /* Ë≥áË®äÂç°Áâá */
    .info-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: none;
    }

    .info-card.show {
      display: block;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border);
    }

    .card-title {
      font-size: 20px;
      font-weight: bold;
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }

    .status-ÂæÖÂèñ‰ª∂ {
      background: #fff8e6;
      color: #b86b00;
    }

    .status-ÂåÖË£πÂ∑≤ÈÖçÈÅîÂèñ‰ª∂ÈñÄÂ∏Ç {
      background: #f0f4ff;
      color: #2b6be6;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    .info-item {
      padding: 12px;
      background: var(--bg);
      border-radius: 8px;
    }

    .info-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .info-value {
      font-size: 16px;
      font-weight: 600;
    }

    .info-value.large {
      font-size: 20px;
      color: var(--primary);
    }

    /* ÈáëÈ°çÂçÄ */
    .amount-section {
      background: linear-gradient(135deg, var(--success) 0%, #22c55e 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      text-align: center;
    }

    .amount-label {
      font-size: 16px;
      opacity: 0.9;
      margin-bottom: 8px;
    }

    .amount-value {
      font-size: 48px;
      font-weight: bold;
      font-family: "Courier New", monospace;
    }

    .amount-note {
      margin-top: 12px;
      font-size: 14px;
      opacity: 0.9;
    }

    /* Êìç‰ΩúÊåâÈàïÂçÄ */
    .actions {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    /* Á©∫ÁãÄÊÖã */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    /* Ë®äÊÅØÊèêÁ§∫ */
    .message {
      position: fixed;
      top: 80px;
      right: 24px;
      max-width: 400px;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      animation: slideIn 0.3s;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }

    .message.success {
      background: var(--success);
      color: white;
    }

    .message.error {
      background: var(--danger);
      color: white;
    }

    .message.warning {
      background: var(--warning);
      color: white;
    }

    /* Á¢∫Ë™çÂ∞çË©±Ê°Ü */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }

    .modal-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 16px;
    }

    .modal-body {
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .form-input {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* ÁôªÂÖ•È†ÅÈù¢ */
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-box {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 40px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .login-title {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 32px;
      color: var(--primary);
    }

    .hidden {
      display: none !important;
    }

    /* Ë≤®‰ª∂ÈÅ∏È†ÖÂç°Áâá */
    .shipment-option {
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--bg);
    }

    .shipment-option:hover {
      border-color: var(--primary);
      background: white;
      box-shadow: 0 2px 8px rgba(10, 132, 255, 0.1);
    }

    .shipment-option-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .shipment-option-tracking {
      font-size: 16px;
      font-weight: bold;
      color: var(--primary);
    }

    .shipment-option-status {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .shipment-option-body {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      font-size: 14px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <!-- ÁôªÂÖ•È†ÅÈù¢ -->
  <div id="loginPage" class="login-container">
    <div class="login-box">
      <h1 class="login-title">üõí POS Á≥ªÁµ±ÁôªÂÖ•</h1>
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label" for="email">Â∏≥Ëôü</label>
          <input type="email" id="email" class="form-input" placeholder="Ë´ãËº∏ÂÖ•ÈõªÂ≠êÈÉµ‰ª∂" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="password">ÂØÜÁ¢º</label>
          <input type="password" id="password" class="form-input" placeholder="Ë´ãËº∏ÂÖ•ÂØÜÁ¢º" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">ÁôªÂÖ•</button>
      </form>
    </div>
  </div>

  <!-- ‰∏ªÈ†ÅÈù¢ -->
  <div id="mainPage" class="hidden">
    <!-- Â∞éËà™Âàó -->
    <nav class="navbar">
      <div class="navbar-brand">üõí Âèñ‰ª∂ÁµêÂ∏≥Á≥ªÁµ±</div>
      <div class="navbar-user">
        <div class="user-info">
          <div class="user-name" id="userName">Â∫óÂì°</div>
          <div class="store-code" id="storeCode">ÈñÄÂ∏Ç‰ª£ËôüÔºöST001</div>
        </div>
        <button class="btn btn-secondary" onclick="logout()">ÁôªÂá∫</button>
      </div>
    </nav>

    <div class="container">
      <!-- ÊêúÂ∞ãÂçÄ -->
      <div class="search-section">
        <div style="margin-bottom: 16px;">
          <label style="font-weight: 600; margin-bottom: 8px; display: block;">Êü•Ë©¢ÊñπÂºè</label>
          <div style="display: flex; gap: 12px;">
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="radio" name="searchType" value="tracking" checked onchange="updateSearchPlaceholder()">
              <span>Âèñ‰ª∂ÂñÆËôü</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="radio" name="searchType" value="phone" onchange="updateSearchPlaceholder()">
              <span>ÊâãÊ©üÊú´‰∏âÁ¢º</span>
            </label>
          </div>
        </div>
        <div class="search-box">
          <input 
            type="text" 
            id="searchInput" 
            class="search-input" 
            placeholder="Ë´ãÊéÉÊèèÊàñËº∏ÂÖ•Âèñ‰ª∂ÂñÆËôü..."
            autofocus
          >
          <button class="btn btn-primary" onclick="searchShipment()">Êü•Ë©¢</button>
          <button class="btn btn-secondary" onclick="resetSearch()">ÈáçÁΩÆ</button>
        </div>
        <div class="search-hint" id="searchHint">üí° ÊèêÁ§∫ÔºöÂèØÁõ¥Êé•‰ΩøÁî®Ê¢ùÁ¢ºÊéÉÊèèÂô®ÊéÉÊèèÂèñ‰ª∂ÂñÆËôü</div>
      </div>

      <!-- Á©∫ÁãÄÊÖã -->
      <div id="emptyState" class="empty-state">
        <div class="empty-icon">üì¶</div>
        <h3>Ë´ãÊéÉÊèèÊàñËº∏ÂÖ•Âèñ‰ª∂ÂñÆËôü</h3>
        <p>Á≥ªÁµ±Â∞áËá™ÂãïÊü•Ë©¢Ë≤®Áâ©Ë≥áË®ä</p>
      </div>

      <!-- ÈÅ∏ÊìáÂàóË°®ÔºàÊâãÊ©üÊú´‰∏âÁ¢ºÊü•Ë©¢ÁµêÊûúÔºâ -->
      <div id="selectList" class="info-card" style="display: none;">
        <div class="card-header">
          <div class="card-title">Êü•Ë©¢Âà∞Â§öÁ≠ÜË≤®‰ª∂ÔºåË´ãÈÅ∏Êìá</div>
        </div>
        <div id="shipmentList" style="display: flex; flex-direction: column; gap: 12px;">
          <!-- ÂãïÊÖãÁîüÊàêÈÅ∏È†Ö -->
        </div>
      </div>

      <!-- Ë≤®Áâ©Ë≥áË®äÂç°Áâá -->
      <div id="infoCard" class="info-card">
        <div class="card-header">
          <div>
            <div class="card-title">Ë≤®Áâ©Ë≥áË®ä</div>
            <div style="color: var(--muted); font-size: 14px; margin-top: 4px;">
              ÂñÆËôüÔºö<span id="displayTrackingNo"></span>
            </div>
          </div>
          <span id="displayStatus" class="status-badge">ÂæÖÂèñ‰ª∂</span>
        </div>

        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Êî∂‰ª∂‰∫∫ÂßìÂêç</div>
            <div class="info-value" id="displayReceiverName">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">Êî∂‰ª∂‰∫∫ÈõªË©±</div>
            <div class="info-value" id="displayReceiverPhone">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">ÂìÅÂêç</div>
            <div class="info-value" id="displayItemName">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">Âà∞Â∫óÊôÇÈñì</div>
            <div class="info-value" id="displayArrivalTime">-</div>
          </div>
        </div>

        <!-- ÈáëÈ°çÂçÄ -->
        <div class="amount-section">
          <div class="amount-label">Êáâ‰ªòÈáëÈ°ç</div>
          <div class="amount-value">$<span id="displayAmount">0</span></div>
          <div class="amount-note" id="amountNote"></div>
        </div>

        <!-- Êìç‰ΩúÊåâÈàï -->
        <div class="actions">
          <button class="btn btn-success" onclick="checkout()">‚úÖ ÁµêÂ∏≥Âèñ‰ª∂</button>
          <button class="btn btn-secondary" onclick="resetSearch()">üîÑ ÈáçÁΩÆ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Ë∫´ÂàÜÈ©óË≠âÂ∞çË©±Ê°Ü -->
  <div id="verifyModal" class="modal">
    <div class="modal-content">
      <div class="modal-title">ü™™ Ë∫´ÂàÜÈ©óË≠â</div>
      <div class="modal-body">
        <p style="margin-bottom: 16px;">Ê≠§ÁÇ∫ÂÖç‰ªòË≤ªÂèñ‰ª∂ÔºåË´ãÁ¢∫Ë™çÂèñ‰ª∂‰∫∫Ë∫´ÂàÜ„ÄÇ</p>
        <div class="form-group">
          <label class="form-label" for="idName">Ë∫´ÂàÜË≠âÂßìÂêç</label>
          <input 
            type="text" 
            id="idName" 
            class="form-input" 
            placeholder="Ë´ãËº∏ÂÖ•Âèñ‰ª∂‰∫∫Ë∫´ÂàÜË≠âÂßìÂêç"
          >
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeVerifyModal()">ÂèñÊ∂à</button>
        <button class="btn btn-primary" onclick="confirmVerify()">Á¢∫Ë™ç</button>
      </div>
    </div>
  </div>

  <script>
    // Supabase ÂàùÂßãÂåñ
    const { createClient } = supabase;
    const supabaseClient = createClient(CONFIG.SUPABASE.URL, CONFIG.SUPABASE.ANON_KEY);

    // ÂÖ®ÂüüËÆäÊï∏
    let currentUser = null;
    let currentShipment = null;
    let currentStore = null;

    // È†ÅÈù¢ÂÖÉÁ¥†
    const loginPage = document.getElementById('loginPage');
    const mainPage = document.getElementById('mainPage');
    const loginForm = document.getElementById('loginForm');
    const searchInput = document.getElementById('searchInput');
    const emptyState = document.getElementById('emptyState');
    const selectList = document.getElementById('selectList');
    const shipmentList = document.getElementById('shipmentList');
    const infoCard = document.getElementById('infoCard');
    const verifyModal = document.getElementById('verifyModal');

    // ÂàùÂßãÂåñ
    async function init() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session) {
        currentUser = session.user;
        await loadUserInfo();
        showMainPage();
      } else {
        showLoginPage();
      }

      // Áõ£ËÅΩ Enter ÈçµËá™ÂãïÊü•Ë©¢
      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          searchShipment();
        }
      });
    }

    // È°ØÁ§∫ÁôªÂÖ•È†ÅÈù¢
    function showLoginPage() {
      loginPage.classList.remove('hidden');
      mainPage.classList.add('hidden');
    }

    // È°ØÁ§∫‰∏ªÈ†ÅÈù¢
    function showMainPage() {
      loginPage.classList.add('hidden');
      mainPage.classList.remove('hidden');
      searchInput.focus();
    }

    // ÁôªÂÖ•
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email,
          password
        });

        if (error) throw error;

        currentUser = data.user;
        await loadUserInfo();
        showMainPage();
        showMessage('ÁôªÂÖ•ÊàêÂäüÔºÅ', 'success');
      } catch (error) {
        showMessage('ÁôªÂÖ•Â§±ÊïóÔºö' + error.message, 'error');
      }
    });

    // ËºâÂÖ•Áî®Êà∂Ë≥áË®ä
    async function loadUserInfo() {
      try {
        const { data: user, error } = await supabaseClient
          .from('users')
          .select('*')
          .eq('id', currentUser.id)
          .single();

        if (error) throw error;

        document.getElementById('userName').textContent = user.name;
        
        // ËºâÂÖ•ÈñÄÂ∏ÇË≥áË®äÔºàÈÄôË£°‰ΩøÁî®È†êË®≠ÈñÄÂ∏ÇÔºåÂØ¶ÈöõÊáâË©≤ÂæûÁî®Êà∂Ë≥áÊñôËÆÄÂèñÔºâ
        currentStore = { store_code: 'ST001', store_name: 'BaiFa.GRP È´òÈõÑ‰∏âÊ∞ëÂ∫ó' };
        document.getElementById('storeCode').textContent = `ÈñÄÂ∏ÇÔºö${currentStore.store_name}`;
      } catch (error) {
        console.error('ËºâÂÖ•Áî®Êà∂Ë≥áË®äÂ§±ÊïóÔºö', error);
      }
    }

    // ÁôªÂá∫
    async function logout() {
      await supabaseClient.auth.signOut();
      currentUser = null;
      currentShipment = null;
      showLoginPage();
      showMessage('Â∑≤ÁôªÂá∫', 'success');
    }

    // Êõ¥Êñ∞ÊêúÂ∞ãÊ°Ü‰Ωî‰ΩçÁ¨¶
    function updateSearchPlaceholder() {
      const searchType = document.querySelector('input[name="searchType"]:checked').value;
      const searchHint = document.getElementById('searchHint');
      
      if (searchType === 'tracking') {
        searchInput.placeholder = 'Ë´ãÊéÉÊèèÊàñËº∏ÂÖ•Âèñ‰ª∂ÂñÆËôü...';
        searchHint.textContent = 'üí° ÊèêÁ§∫ÔºöÂèØÁõ¥Êé•‰ΩøÁî®Ê¢ùÁ¢ºÊéÉÊèèÂô®ÊéÉÊèèÂèñ‰ª∂ÂñÆËôü';
      } else {
        searchInput.placeholder = 'Ë´ãËº∏ÂÖ•ÊâãÊ©üÊú´‰∏âÁ¢º...';
        searchHint.textContent = 'üí° ÊèêÁ§∫ÔºöËº∏ÂÖ•Êî∂‰ª∂‰∫∫ÊâãÊ©üËôüÁ¢ºÁöÑÂæå‰∏âÁ¢ºÔºà‰æãÂ¶ÇÔºö123Ôºâ';
      }
      searchInput.value = '';
      searchInput.focus();
    }

    // Êü•Ë©¢Ë≤®Áâ©
    async function searchShipment() {
      const searchValue = searchInput.value.trim();
      const searchType = document.querySelector('input[name="searchType"]:checked').value;
      
      if (!searchValue) {
        showMessage(searchType === 'tracking' ? 'Ë´ãËº∏ÂÖ•Âèñ‰ª∂ÂñÆËôü' : 'Ë´ãËº∏ÂÖ•ÊâãÊ©üÊú´‰∏âÁ¢º', 'warning');
        return;
      }

      try {
        let shipments;

        if (searchType === 'tracking') {
          // ‰ΩøÁî®Âèñ‰ª∂ÂñÆËôüÊü•Ë©¢
          await logAction('pickup_scan', null, searchValue);

          const { data, error } = await supabaseClient
            .from('shipments')
            .select('*')
            .eq('tracking_no', searchValue)
            .single();

          if (error) throw error;

          if (!data) {
            showMessage('Êâæ‰∏çÂà∞Ê≠§Âèñ‰ª∂ÂñÆËôü', 'error');
            return;
          }

          shipments = [data];
        } else {
          // ‰ΩøÁî®ÊâãÊ©üÊú´‰∏âÁ¢ºÊü•Ë©¢
          await logAction('pickup_scan_by_phone', null, searchValue);

          const { data, error } = await supabaseClient
            .from('shipments')
            .select('*')
            .like('receiver_phone', `%${searchValue}`)
            .neq('status', 'Âèñ‰ª∂ÊàêÂäü')
            .order('created_at', { ascending: false });

          if (error) throw error;

          if (!data || data.length === 0) {
            showMessage('Êâæ‰∏çÂà∞Á¨¶ÂêàÁöÑË≤®‰ª∂', 'error');
            return;
          }

          shipments = data;
        }

        // Â¶ÇÊûúÊúâÂ§öÁ≠ÜÁµêÊûúÔºåÈ°ØÁ§∫ÈÅ∏ÊìáÂàóË°®
        if (shipments.length > 1) {
          showShipmentList(shipments);
          return;
        }

        // ÂñÆÁ≠ÜÁµêÊûúÔºåÁõ¥Êé•È°ØÁ§∫
        const shipment = shipments[0];

        // Ê™¢Êü•ÁãÄÊÖã
        if (shipment.status === 'Âèñ‰ª∂ÊàêÂäü') {
          showMessage('Ê≠§Ë≤®‰ª∂Â∑≤ÂÆåÊàêÂèñ‰ª∂', 'warning');
          return;
        }

        // Ê™¢Êü•ÊòØÂê¶Â∑≤ÊúâÂèñ‰ª∂Ë®òÈåÑ
        const { data: existingTransaction } = await supabaseClient
          .from('pickup_transactions')
          .select('*')
          .eq('tracking_no', shipment.tracking_no)
          .eq('status', 'completed')
          .single();

        if (existingTransaction) {
          showMessage('Ê≠§Ë≤®‰ª∂Â∑≤ÂÆåÊàêÂèñ‰ª∂ÔºåÁÑ°Ê≥ïÈáçË§áÁµêÂ∏≥', 'error');
          return;
        }

        // È°ØÁ§∫Ë≤®Áâ©Ë≥áË®ä
        currentShipment = shipment;
        displayShipmentInfo(shipment);
      } catch (error) {
        console.error('Êü•Ë©¢Â§±ÊïóÔºö', error);
        showMessage('Êü•Ë©¢Â§±ÊïóÔºö' + error.message, 'error');
      }
    }

    // È°ØÁ§∫Ë≤®‰ª∂ÈÅ∏ÊìáÂàóË°®
    function showShipmentList(shipments) {
      emptyState.style.display = 'none';
      infoCard.classList.remove('show');
      selectList.style.display = 'block';

      shipmentList.innerHTML = shipments.map(shipment => `
        <div class="shipment-option" onclick="selectShipmentFromList(${shipment.id})">
          <div class="shipment-option-header">
            <div class="shipment-option-tracking">${shipment.tracking_no}</div>
            <div class="shipment-option-status status-${shipment.status.replace(/\s+/g, '')}">${shipment.status}</div>
          </div>
          <div class="shipment-option-body">
            <div>Êî∂‰ª∂‰∫∫Ôºö${shipment.receiver_name}</div>
            <div>ÈõªË©±Ôºö${shipment.receiver_phone}</div>
            <div>ÂìÅÂêçÔºö${shipment.item_name || '‰∏ÄËà¨Ë≤®Áâ©'}</div>
            <div>‰ª£Êî∂Ôºö$${shipment.cod_amount || 0}</div>
          </div>
        </div>
      `).join('');
    }

    // ÂæûÂàóË°®ÈÅ∏ÊìáË≤®‰ª∂
    async function selectShipmentFromList(shipmentId) {
      try {
        const { data: shipment, error } = await supabaseClient
          .from('shipments')
          .select('*')
          .eq('id', shipmentId)
          .single();

        if (error) throw error;

        // Ê™¢Êü•ÊòØÂê¶Â∑≤ÊúâÂèñ‰ª∂Ë®òÈåÑ
        const { data: existingTransaction } = await supabaseClient
          .from('pickup_transactions')
          .select('*')
          .eq('tracking_no', shipment.tracking_no)
          .eq('status', 'completed')
          .single();

        if (existingTransaction) {
          showMessage('Ê≠§Ë≤®‰ª∂Â∑≤ÂÆåÊàêÂèñ‰ª∂ÔºåÁÑ°Ê≥ïÈáçË§áÁµêÂ∏≥', 'error');
          return;
        }

        selectList.style.display = 'none';
        currentShipment = shipment;
        displayShipmentInfo(shipment);
      } catch (error) {
        console.error('ÈÅ∏ÊìáË≤®‰ª∂Â§±ÊïóÔºö', error);
        showMessage('ÈÅ∏ÊìáË≤®‰ª∂Â§±ÊïóÔºö' + error.message, 'error');
      }
    }

    // È°ØÁ§∫Ë≤®Áâ©Ë≥áË®ä
    function displayShipmentInfo(shipment) {
      emptyState.style.display = 'none';
      infoCard.classList.add('show');

      document.getElementById('displayTrackingNo').textContent = shipment.tracking_no;
      document.getElementById('displayStatus').textContent = shipment.status;
      document.getElementById('displayStatus').className = `status-badge status-${shipment.status.replace(/\s+/g, '')}`;
      document.getElementById('displayReceiverName').textContent = shipment.receiver_name;
      document.getElementById('displayReceiverPhone').textContent = shipment.receiver_phone;
      document.getElementById('displayItemName').textContent = shipment.item_name || '‰∏ÄËà¨Ë≤®Áâ©';
      document.getElementById('displayArrivalTime').textContent = formatDate(shipment.updated_at);

      // ‰ΩøÁî®‰ª£Êî∂ÈáëÈ°çÊ¨Ñ‰Ωç
      const amount = shipment.cod_amount || 0;
      document.getElementById('displayAmount').textContent = amount;

      if (amount === 0) {
        document.getElementById('amountNote').textContent = 'üí≥ ÂÖç‰ªòË≤ªÂèñ‰ª∂ÔºàÈ†ê‰ªòÊ¨æÔºâ';
      } else {
        document.getElementById('amountNote').textContent = 'üíµ Ë≤®Âà∞‰ªòÊ¨æ';
      }
    }

    // ÁµêÂ∏≥
    async function checkout() {
      if (!currentShipment) return;

      const amount = parseInt(document.getElementById('displayAmount').textContent);

      // Â¶ÇÊûúÊòØÂÖç‰ªòË≤ªÔºåÈúÄË¶ÅÈ©óË≠âË∫´ÂàÜ
      if (amount === 0) {
        openVerifyModal();
        return;
      }

      // Áõ¥Êé•ÁµêÂ∏≥
      await completeCheckout(null);
    }

    // ÊâìÈñãË∫´ÂàÜÈ©óË≠âÂ∞çË©±Ê°Ü
    function openVerifyModal() {
      verifyModal.classList.add('show');
      document.getElementById('idName').value = '';
      document.getElementById('idName').focus();
    }

    // ÈóúÈñâË∫´ÂàÜÈ©óË≠âÂ∞çË©±Ê°Ü
    function closeVerifyModal() {
      verifyModal.classList.remove('show');
    }

    // Á¢∫Ë™çË∫´ÂàÜÈ©óË≠â
    async function confirmVerify() {
      const idName = document.getElementById('idName').value.trim();
      
      if (!idName) {
        showMessage('Ë´ãËº∏ÂÖ•Ë∫´ÂàÜË≠âÂßìÂêç', 'warning');
        return;
      }

      closeVerifyModal();
      await completeCheckout(idName);
    }

    // ÂÆåÊàêÁµêÂ∏≥
    async function completeCheckout(idName) {
      try {
        const amount = parseInt(document.getElementById('displayAmount').textContent);
        
        // ÁîüÊàê‰∫§ÊòìÂñÆËôü
        const { data: transactionNo } = await supabaseClient.rpc('generate_transaction_no');

        // Âª∫Á´ãÂèñ‰ª∂‰∫§ÊòìË®òÈåÑ
        const { data: transaction, error } = await supabaseClient
          .from('pickup_transactions')
          .insert({
            transaction_no: transactionNo,
            shipment_id: currentShipment.id,
            tracking_no: currentShipment.tracking_no,
            receiver_name: currentShipment.receiver_name,
            receiver_phone: currentShipment.receiver_phone,
            receiver_id_name: idName,
            amount: amount,
            payment_method: amount === 0 ? 'free' : 'cash',
            is_cod: amount > 0,
            cashier_id: currentUser.id,
            cashier_name: document.getElementById('userName').textContent,
            store_code: currentStore.store_code,
            status: 'completed',
            print_count: 0
          })
          .select()
          .single();

        if (error) throw error;

        // Ë®òÈåÑÁµêÂ∏≥Âãï‰Ωú
        await logAction('pickup_checkout', transaction.transaction_no, transaction.tracking_no);

        // ÂàóÂç∞Êî∂Êìö
        await printReceipt(transaction);

        // È°ØÁ§∫ÊàêÂäüË®äÊÅØ
        showMessage('‚úÖ Âèñ‰ª∂ÁµêÂ∏≥ÊàêÂäüÔºÅÂ∑≤‰∏äÂÇ≥Ëá≥ Supabase ‰∏¶ÂàóÂç∞Êî∂Êìö„ÄÇ', 'success');

        // ÈáçÁΩÆÈ†ÅÈù¢
        setTimeout(() => {
          resetSearch();
        }, 2000);
      } catch (error) {
        console.error('ÁµêÂ∏≥Â§±ÊïóÔºö', error);
        showMessage('ÁµêÂ∏≥Â§±ÊïóÔºö' + error.message, 'error');
      }
    }

    // ÂàóÂç∞Êî∂Êìö
    async function printReceipt(transaction) {
      // Êõ¥Êñ∞ÂàóÂç∞Ê¨°Êï∏
      await supabaseClient
        .from('pickup_transactions')
        .update({ 
          print_count: transaction.print_count + 1,
          last_print_time: new Date().toISOString()
        })
        .eq('id', transaction.id);

      // Ë®òÈåÑÂàóÂç∞Âãï‰Ωú
      await logAction('print_receipt', transaction.transaction_no, transaction.tracking_no);

      // ÁîüÊàêÊî∂ÊìöÂÖßÂÆπ
      const receiptContent = generateReceiptContent(transaction);

      // ÊâìÈñãÂàóÂç∞Ë¶ñÁ™ó
      const printWindow = window.open('', '_blank', 'width=300,height=600');
      printWindow.document.write(receiptContent);
      printWindow.document.close();

      // Âª∂ÈÅ≤ÂàóÂç∞ÔºåÁ≠âÂæÖÂÖßÂÆπËºâÂÖ•
      setTimeout(() => {
        printWindow.print();
        printWindow.close();
      }, 500);
    }

    // ÁîüÊàêÊî∂ÊìöÂÖßÂÆπ
    function generateReceiptContent(transaction) {
      const now = new Date();
      const dateStr = formatDate(now);

      return `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>Âèñ‰ª∂Êî∂Êìö</title>
          <style>
            @page {
              size: 58mm auto;
              margin: 0;
            }
            * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
            }
            body {
              width: 58mm;
              font-family: "Microsoft JhengHei", "Courier New", monospace;
              font-size: 9pt;
              padding: 5mm;
              line-height: 1.4;
            }
            .center {
              text-align: center;
            }
            .header {
              font-size: 14pt;
              font-weight: bold;
              margin-bottom: 3mm;
            }
            .divider {
              border-top: 1px dashed #000;
              margin: 3mm 0;
            }
            .row {
              display: flex;
              justify-content: space-between;
              margin: 1mm 0;
            }
            .label {
              font-weight: bold;
            }
            .amount {
              font-size: 12pt;
              font-weight: bold;
              margin: 2mm 0;
            }
            .footer {
              font-size: 8pt;
              margin-top: 3mm;
            }
          </style>
        </head>
        <body>
          <div class="center header">‚òÖ Âèñ‰ª∂Êî∂Êìö ‚òÖ</div>
          <div class="center" style="font-size: 12pt; font-weight: bold; margin-bottom: 3mm;">
            ${CONFIG.UI.PRINT.COMPANY.NAME}
          </div>
          <div class="divider"></div>
          
          <div class="row">
            <span class="label">‰∫§ÊòìÂñÆËôüÔºö</span>
            <span>${transaction.transaction_no}</span>
          </div>
          <div class="row">
            <span class="label">Âèñ‰ª∂ÂñÆËôüÔºö</span>
            <span>${transaction.tracking_no}</span>
          </div>
          <div class="row">
            <span class="label">Êî∂‰ª∂‰∫∫Ôºö</span>
            <span>${transaction.receiver_name}</span>
          </div>
          <div class="row">
            <span class="label">ÁµêÂ∏≥‰∫∫Âì°Ôºö</span>
            <span>${transaction.cashier_name}</span>
          </div>
          <div class="row">
            <span class="label">‰∫§ÊòìÊôÇÈñìÔºö</span>
            <span>${dateStr}</span>
          </div>
          <div class="row">
            <span class="label">ÈñÄÂ∏ÇÔºö</span>
            <span>${currentStore.store_name}</span>
          </div>
          
          <div class="divider"></div>
          
          <div style="margin: 2mm 0;">
            <div class="label">ÂìÅÈ†ÖÔºö</div>
            <div class="row">
              <span>Âèñ‰ª∂ - ${transaction.tracking_no}</span>
              <span>$${transaction.amount}</span>
            </div>
          </div>
          
          <div class="divider"></div>
          
          <div class="row amount">
            <span>ÂêàË®àÈáëÈ°çÔºö</span>
            <span>$${transaction.amount}</span>
          </div>
          
          ${transaction.amount === 0 ? '<div class="center">ÂÖç‰ªòË≤ªÂèñ‰ª∂</div>' : ''}
          ${transaction.receiver_id_name ? `<div class="center">Âèñ‰ª∂‰∫∫Ôºö${transaction.receiver_id_name}</div>` : ''}
          
          <div class="divider"></div>
          
          <div class="center footer">
            ÊÑüË¨ùÊÇ®ÁöÑÂèñ‰ª∂ÔºåÊ≠°ËøéÂÜçÂ∫¶ÂÖâËá®ÔºÅ
          </div>
          <div class="center footer" style="margin-top: 2mm;">
            ${CONFIG.UI.PRINT.COMPANY.PHONE}
          </div>
        </body>
        </html>
      `;
    }

    // Ë®òÈåÑÊìç‰ΩúÊó•Ë™å
    async function logAction(action, transactionNo, trackingNo) {
      try {
        await supabaseClient
          .from('pos_logs')
          .insert({
            action,
            transaction_no: transactionNo,
            tracking_no: trackingNo,
            user_id: currentUser?.id,
            store_code: currentStore?.store_code,
            details: {
              timestamp: new Date().toISOString(),
              user_agent: navigator.userAgent
            }
          });
      } catch (error) {
        console.error('Ë®òÈåÑÊó•Ë™åÂ§±ÊïóÔºö', error);
      }
    }

    // ÈáçÁΩÆÊêúÂ∞ã
    function resetSearch() {
      searchInput.value = '';
      currentShipment = null;
      infoCard.classList.remove('show');
      selectList.style.display = 'none';
      emptyState.style.display = 'block';
      searchInput.focus();
    }

    // È°ØÁ§∫Ë®äÊÅØ
    function showMessage(text, type = 'success') {
      const message = document.createElement('div');
      message.className = `message ${type}`;
      message.textContent = text;
      document.body.appendChild(message);

      setTimeout(() => {
        message.remove();
      }, 3000);
    }

    // Ê†ºÂºèÂåñÊó•Êúü
    function formatDate(date) {
      const d = new Date(date);
      return d.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // ÂàùÂßãÂåñ
    init();
  </script>
</body>
</html>
      
