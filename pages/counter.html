<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ«ƒæª¯å«è™Ÿç®¡ç†</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../config.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #0a84ff;
      --success: #28c76f;
      --danger: #ff3b30;
      --warning: #ff9500;
      --muted: #6b7280;
      --bg: #f5f7fa;
      --card-bg: #ffffff;
      --border: #e5e7eb;
    }

    body {
      font-family: "Microsoft JhengHei", "Noto Sans TC", -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      min-height: 100vh;
    }

    .header {
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      padding: 20px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-title {
      font-size: 24px;
      font-weight: bold;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .stat-card {
      background: var(--bg);
      padding: 8px 16px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-label {
      font-size: 12px;
      color: var(--muted);
    }

    .stat-value {
      font-size: 20px;
      font-weight: bold;
      color: var(--primary);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    .queue-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .queue-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.3s;
      border: 2px solid transparent;
    }

    .queue-card:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }

    .queue-card.waiting {
      border-color: var(--warning);
      background: #fff8e6;
    }

    .queue-card.called {
      border-color: var(--primary);
      background: #e6f3ff;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .checkin-no {
      font-size: 32px;
      font-weight: bold;
      color: var(--primary);
      font-family: "Courier New", monospace;
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-badge.waiting {
      background: var(--warning);
      color: white;
    }

    .status-badge.called {
      background: var(--primary);
      color: white;
    }

    .status-badge.completed {
      background: var(--success);
      color: white;
    }

    .card-body {
      margin-bottom: 16px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      color: var(--muted);
      font-size: 14px;
    }

    .info-value {
      font-weight: 600;
      color: #1f2937;
      font-size: 14px;
    }

    .wait-time {
      text-align: center;
      padding: 8px;
      background: var(--bg);
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .wait-time-label {
      font-size: 12px;
      color: var(--muted);
    }

    .wait-time-value {
      font-size: 18px;
      font-weight: bold;
      color: var(--warning);
    }

    .card-actions {
      display: flex;
      gap: 8px;
    }

    .btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .btn-call {
      background: var(--primary);
      color: white;
    }

    .btn-complete {
      background: var(--success);
      color: white;
    }

    .btn-cancel {
      background: var(--muted);
      color: white;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      background: var(--card-bg);
      padding: 8px;
      border-radius: 12px;
    }

    .tab {
      flex: 1;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      background: transparent;
      color: var(--muted);
      transition: all 0.2s;
    }

    .tab.active {
      background: var(--primary);
      color: white;
    }

    .refresh-btn {
      padding: 8px 16px;
      border: 2px solid var(--primary);
      border-radius: 8px;
      background: white;
      color: var(--primary);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .refresh-btn:hover {
      background: var(--primary);
      color: white;
    }

    .message {
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      font-weight: 500;
      text-align: center;
    }

    .message.success {
      background: #e8f7ee;
      color: var(--success);
    }

    .message.error {
      background: #ffecee;
      color: var(--danger);
    }
  </style>
</head>
<body>
  <!-- é ­éƒ¨ -->
  <div class="header">
    <div class="header-left">
      <h1 class="header-title">ğŸ”” æ«ƒæª¯å«è™Ÿç®¡ç†</h1>
    </div>
    <div class="header-right">
      <div class="stat-card">
        <div class="stat-label">å¾…å«è™Ÿ</div>
        <div class="stat-value" id="waitingCount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">å·²å«è™Ÿ</div>
        <div class="stat-value" id="calledCount" style="color: var(--primary);">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">å·²å®Œæˆ</div>
        <div class="stat-value" id="completedCount" style="color: var(--success);">0</div>
      </div>
      <button class="refresh-btn" onclick="loadCheckins()">ğŸ”„ åˆ·æ–°</button>
      <button class="refresh-btn" onclick="goToSales()">ğŸ’° çµå¸³</button>
      <button class="refresh-btn" onclick="goBack()">â† è¿”å›</button>
    </div>
  </div>

  <div class="container">
    <!-- åˆ†é  -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('waiting')">å¾…å«è™Ÿ</button>
      <button class="tab" onclick="switchTab('called')">å·²å«è™Ÿ</button>
      <button class="tab" onclick="switchTab('completed')">ä»Šæ—¥å®Œæˆ</button>
    </div>

    <!-- è¨Šæ¯ -->
    <div id="messageContainer"></div>

    <!-- å¾…å«è™Ÿåˆ—è¡¨ -->
    <div id="waitingTab" class="tab-content">
      <div class="queue-grid" id="waitingQueue"></div>
    </div>

    <!-- å·²å«è™Ÿåˆ—è¡¨ -->
    <div id="calledTab" class="tab-content" style="display: none;">
      <div class="queue-grid" id="calledQueue"></div>
    </div>

    <!-- ä»Šæ—¥å®Œæˆåˆ—è¡¨ -->
    <div id="completedTab" class="tab-content" style="display: none;">
      <div class="queue-grid" id="completedQueue"></div>
    </div>
  </div>

  <script>
    // Supabase åˆå§‹åŒ–
    const { createClient } = supabase;
    const supabaseClient = createClient(CONFIG.SUPABASE.URL, CONFIG.SUPABASE.ANON_KEY);

    // å…¨åŸŸè®Šæ•¸
    let currentUser = null;
    let currentTab = 'waiting';
    let refreshInterval = null;

    // åˆå§‹åŒ–
    async function init() {
      await checkAuth();
      await loadCheckins();
      startAutoRefresh();
      subscribeToChanges();
    }

    // æª¢æŸ¥ç™»å…¥
    async function checkAuth() {
      const { data: { user }, error } = await supabaseClient.auth.getUser();
      
      if (error || !user) {
        alert('è«‹å…ˆç™»å…¥');
        window.location.href = '../index.html';
        return;
      }

      // ç›´æ¥ä½¿ç”¨ auth.users çš„è³‡æ–™
      currentUser = {
        id: user.id,
        email: user.email,
        name: user.user_metadata?.name || user.email.split('@')[0]
      };
      
      console.log('âœ… æ«ƒæª¯ç³»çµ±å·²ç™»å…¥ï¼š', currentUser.email);
    }

    // è¼‰å…¥å ±åˆ°è¨˜éŒ„
    async function loadCheckins() {
      try {
        const { data, error } = await supabaseClient
          .from('checkin_records')
          .select('*')
          .gte('checkin_time', new Date().toISOString().split('T')[0])
          .order('checkin_time', { ascending: true });

        if (error) throw error;

        // åˆ†é¡
        const waiting = data.filter(c => c.status === 'å¾…å«è™Ÿ');
        const called = data.filter(c => c.status === 'å·²å«è™Ÿ');
        const completed = data.filter(c => c.status === 'å·²å®Œæˆ');

        // æ›´æ–°çµ±è¨ˆ
        document.getElementById('waitingCount').textContent = waiting.length;
        document.getElementById('calledCount').textContent = called.length;
        document.getElementById('completedCount').textContent = completed.length;

        // æ¸²æŸ“åˆ—è¡¨
        renderQueue('waitingQueue', waiting);
        renderQueue('calledQueue', called);
        renderQueue('completedQueue', completed);

      } catch (error) {
        console.error('è¼‰å…¥å¤±æ•—ï¼š', error);
        showMessage('è¼‰å…¥å¤±æ•—ï¼š' + error.message, 'error');
      }
    }

    // æ¸²æŸ“éšŠåˆ—
    function renderQueue(containerId, checkins) {
      const container = document.getElementById(containerId);
      
      if (checkins.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ“­</div>
            <div>ç›®å‰æ²’æœ‰å ±åˆ°è¨˜éŒ„</div>
          </div>
        `;
        return;
      }

      container.innerHTML = checkins.map(checkin => {
        // è¨ˆç®—ç­‰å¾…æ™‚é–“
        const now = new Date();
        
        // Supabase å„²å­˜çš„æ™‚é–“æ²’æœ‰æ™‚å€æ¨™è¨˜ï¼Œéœ€è¦åŠ ä¸Š 'Z' å¼·åˆ¶è§£æç‚º UTC
        // é€™æ¨£æ‰èƒ½æ­£ç¢ºè½‰æ›æˆæœ¬åœ°æ™‚é–“
        const checkinTime = new Date(checkin.checkin_time + 'Z');
        
        // è¨ˆç®—æ™‚é–“å·®ï¼ˆæ¯«ç§’ï¼‰
        const timeDiff = now.getTime() - checkinTime.getTime();
        const waitMinutes = Math.max(0, Math.floor(timeDiff / (1000 * 60)));
        
        const statusClass = checkin.status === 'å¾…å«è™Ÿ' ? 'waiting' : 
                           checkin.status === 'å·²å«è™Ÿ' ? 'called' : 'completed';
        
        return `
          <div class="queue-card ${statusClass}">
            <div class="card-header">
              <div class="checkin-no">${checkin.checkin_no}</div>
              <div class="status-badge ${statusClass}">${checkin.status}</div>
            </div>

            ${checkin.status !== 'å·²å®Œæˆ' ? `
              <div class="wait-time">
                <div class="wait-time-label">ç­‰å¾…æ™‚é–“</div>
                <div class="wait-time-value">${waitMinutes} åˆ†é˜</div>
              </div>
            ` : ''}

            <div class="card-body">
              <div class="info-row">
                <span class="info-label">å–ä»¶å–®è™Ÿ</span>
                <span class="info-value">${checkin.tracking_no}</span>
              </div>
              <div class="info-row">
                <span class="info-label">æ”¶ä»¶äºº</span>
                <span class="info-value">${checkin.receiver_name.substring(0, 2)}**</span>
              </div>
              <div class="info-row">
                <span class="info-label">é›»è©±æœ«ä¸‰ç¢¼</span>
                <span class="info-value">${checkin.receiver_phone.slice(-3)}</span>
              </div>
              <div class="info-row">
                <span class="info-label">ä»£æ”¶é‡‘é¡</span>
                <span class="info-value" style="color: var(--danger); font-size: 18px;">$${checkin.cod_amount || 0}</span>
              </div>
              <div class="info-row">
                <span class="info-label">å ±åˆ°æ™‚é–“</span>
                <span class="info-value">${new Date(checkin.checkin_time).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })}</span>
              </div>
            </div>

            <div class="card-actions">
              ${checkin.status === 'å¾…å«è™Ÿ' ? `
                <button class="btn btn-call" onclick="callNumber('${checkin.id}', '${checkin.checkin_no}')">
                  ğŸ”” å«è™Ÿ
                </button>
              ` : ''}
              ${checkin.status === 'å·²å«è™Ÿ' ? `
                <button class="btn btn-complete" onclick="goToCheckout('${checkin.tracking_no}')">
                  ğŸ’° å‰å¾€çµå¸³
                </button>
              ` : ''}
              ${checkin.status === 'å·²å®Œæˆ' ? `
                <button class="btn btn-cancel" disabled>
                  âœ… å·²å®Œæˆ
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // å«è™Ÿ
    async function callNumber(checkinId, checkinNo) {
      if (!confirm(`ç¢ºå®šè¦å«è™Ÿ ${checkinNo} å—ï¼Ÿ`)) return;

      try {
        // æ›´æ–°ç‹€æ…‹
        const { error: updateError } = await supabaseClient
          .from('checkin_records')
          .update({
            status: 'å·²å«è™Ÿ',
            called_time: new Date().toISOString()
          })
          .eq('id', checkinId);

        if (updateError) throw updateError;

        // è¨˜éŒ„å«è™Ÿæ­·å²
        await supabaseClient
          .from('call_history')
          .insert({
            checkin_id: checkinId,
            checkin_no: checkinNo,
            caller_id: currentUser.id,
            caller_name: currentUser.name
          });

        // èªéŸ³æ’­æ”¾å·²ç§»è‡³ display.html
        // é€é Supabase Realtime è‡ªå‹•é€šçŸ¥é¡¯ç¤ºç•«é¢

        showMessage(`å·²å«è™Ÿ ${checkinNo}ï¼Œè«‹æº–å‚™åŒ…è£¹ï¼ˆèªéŸ³ç”±é¡¯ç¤ºç•«é¢æ’­æ”¾ï¼‰`, 'success');
        await loadCheckins();

      } catch (error) {
        console.error('å«è™Ÿå¤±æ•—ï¼š', error);
        showMessage('å«è™Ÿå¤±æ•—ï¼š' + error.message, 'error');
      }
    }

    // èªéŸ³æ’­æ”¾åŠŸèƒ½å·²ç§»é™¤
    // ç¾åœ¨ç”± display.html é€é Realtime è‡ªå‹•è™•ç†

    // å‰å¾€çµå¸³
    function goToCheckout(trackingNo) {
      window.open(`sales.html?tracking=${trackingNo}`, '_blank');
    }

    // å‰å¾€çµå¸³ç³»çµ±
    function goToSales() {
      window.location.href = 'sales.html';
    }

    // è¿”å›
    function goBack() {
      window.location.href = '../index.html';
    }

    // åˆ‡æ›åˆ†é 
    function switchTab(tab) {
      currentTab = tab;
      
      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      // é¡¯ç¤ºå°æ‡‰å…§å®¹
      document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
      document.getElementById(`${tab}Tab`).style.display = 'block';
    }

    // é¡¯ç¤ºè¨Šæ¯
    function showMessage(text, type) {
      const container = document.getElementById('messageContainer');
      const message = document.createElement('div');
      message.className = `message ${type}`;
      message.textContent = text;
      container.innerHTML = '';
      container.appendChild(message);
      
      setTimeout(() => message.remove(), 3000);
    }

    // è‡ªå‹•åˆ·æ–°
    function startAutoRefresh() {
      refreshInterval = setInterval(loadCheckins, 10000); // æ¯ 10 ç§’åˆ·æ–°
    }

    // è¨‚é–±å³æ™‚æ›´æ–°
    function subscribeToChanges() {
      supabaseClient
        .channel('checkin_changes')
        .on('postgres_changes', 
          { event: '*', schema: 'public', table: 'checkin_records' },
          payload => {
            console.log('å³æ™‚æ›´æ–°ï¼š', payload);
            loadCheckins();
          }
        )
        .subscribe();
    }

    // é é¢å¸è¼‰æ™‚æ¸…ç†
    window.addEventListener('beforeunload', () => {
      if (refreshInterval) clearInterval(refreshInterval);
    });

    init();
  </script>
</body>
</html>

