<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åŒ…è£¹æŸ¥è©¢ - è¿½è¹¤æ‚¨çš„åŒ…è£¹</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="../../config.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #0a84ff;
      --success: #28c76f;
      --warning: #ff9500;
      --danger: #ff3b30;
      --info: #5ac8fa;
      --muted: #6b7280;
      --bg: #f5f7fa;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
    }

    body {
      font-family: "Microsoft JhengHei", "Noto Sans TC", -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #b0b0b0 0%, #343434 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    /* é ­éƒ¨ */
    .header {
      text-align: center;
      margin-bottom: 32px;
      animation: fadeIn 0.5s;
    }

    .logo {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .title {
      font-size: 28px;
      font-weight: bold;
      color: white;
      margin-bottom: 8px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .subtitle {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.9);
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }

    /* æŸ¥è©¢å¡ç‰‡ */
    .search-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 24px;
      animation: slideUp 0.5s;
    }

    .search-label {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      display: block;
    }

    .search-input-group {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }

    .search-input {
      flex: 1;
      padding: 14px 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s;
      font-family: "Courier New", monospace;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.1);
    }

    .search-btn {
      padding: 14px 24px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .search-btn:hover {
      background: #0066cc;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(10, 132, 255, 0.3);
    }

    .search-btn:active {
      transform: translateY(0);
    }

    .search-btn:disabled {
      background: var(--muted);
      cursor: not-allowed;
      transform: none;
    }

    .search-hint {
      font-size: 14px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* çµæœå¡ç‰‡ */
    .result-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 24px;
      animation: slideUp 0.5s;
      display: none;
    }

    .result-card.show {
      display: block;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border);
    }

    .result-icon {
      font-size: 48px;
    }

    .status-badge {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status-badge.å¾…å–ä»¶ {
      background: #e8f7ee;
      color: var(--success);
    }

    .status-badge.é…é€ä¸­ {
      background: #e6f3ff;
      color: var(--info);
    }

    .status-badge.å·²å–ä»¶ {
      background: #f3f4f6;
      color: var(--muted);
    }

    .status-badge.ç‰©æµå–®å·²å»ºç«‹,
    .status-badge.åŒ…è£¹é›¢åº—ä½œæ¥­ä¸­,
    .status-badge.åŒ…è£¹æŠµé”ç†è²¨ä¸­å¿ƒè™•ç†ä¸­ {
      background: #e6f3ff;
      color: var(--info);
    }

    .status-badge.åŒ…è£¹å·²é…é”å–ä»¶é–€å¸‚ {
      background: #e8f7ee;
      color: var(--success);
    }

    .status-badge.å–ä»¶æˆåŠŸ {
      background: #f3f4f6;
      color: var(--muted);
    }

    .result-body {
      margin-bottom: 20px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      font-size: 14px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .info-value {
      font-size: 14px;
      color: var(--text-primary);
      font-weight: 600;
      text-align: right;
    }

    .info-value.tracking {
      font-family: "Courier New", monospace;
      font-size: 13px;
    }

    .info-value.amount {
      font-size: 20px;
      color: var(--danger);
    }

    /* æç¤ºè¨Šæ¯ */
    .alert {
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
      animation: slideUp 0.3s;
    }

    .alert.show {
      display: block;
    }

    .alert.success {
      background: #e8f7ee;
      color: var(--success);
      border: 1px solid var(--success);
    }

    .alert.error {
      background: #ffecee;
      color: var(--danger);
      border: 1px solid var(--danger);
    }

    .alert.info {
      background: #e6f3ff;
      color: var(--info);
      border: 1px solid var(--info);
    }

    .alert.warning {
      background: #fff8e6;
      color: var(--warning);
      border: 1px solid var(--warning);
    }

    /* å‹•ä½œæŒ‰éˆ• */
    .action-buttons {
      display: flex;
      gap: 12px;
    }

    .btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: #0066cc;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(10, 132, 255, 0.3);
    }

    .btn-secondary {
      background: var(--bg);
      color: var(--text-primary);
      border: 2px solid var(--border);
    }

    .btn-secondary:hover {
      background: white;
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    /* è¼‰å…¥å‹•ç•« */
    .loading {
      display: none;
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .loading.show {
      display: block;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* é å°¾ */
    .footer {
      text-align: center;
      padding: 24px;
      color: rgba(255, 255, 255, 0.8);
      font-size: 14px;
    }

    .footer a {
      color: white;
      text-decoration: none;
      font-weight: 600;
    }

    /* å‹•ç•« */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 480px) {
      body {
        padding: 12px;
      }

      .title {
        font-size: 24px;
      }

      .search-card, .result-card {
        padding: 20px;
      }

      .search-input-group {
        flex-direction: column;
      }

      .search-btn {
        width: 100%;
      }

      .action-buttons {
        flex-direction: column;
      }
    }

    /* æ­·å²è¨˜éŒ„ */
    .history-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid var(--border);
    }

    .history-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .timeline {
      position: relative;
      padding-left: 32px;
    }

    .timeline-item {
      position: relative;
      padding-bottom: 20px;
    }

    .timeline-item:last-child {
      padding-bottom: 0;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: -25px;
      top: 6px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--primary);
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .timeline-item::after {
      content: '';
      position: absolute;
      left: -20px;
      top: 18px;
      width: 2px;
      height: calc(100% - 6px);
      background: var(--border);
    }

    .timeline-item:last-child::after {
      display: none;
    }

    .timeline-status {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .timeline-time {
      font-size: 12px;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- é ­éƒ¨ -->
    <div class="header">
      <div class="logo">ğŸ“¦</div>
      <h1 class="title">åŒ…è£¹æŸ¥è©¢</h1>
      <p class="subtitle">è¼¸å…¥åŒ…è£¹ç·¨è™Ÿï¼Œå³æ™‚è¿½è¹¤åŒ…è£¹ç‹€æ…‹</p>
    </div>

    <!-- æŸ¥è©¢å¡ç‰‡ -->
    <div class="search-card">
      <label class="search-label">åŒ…è£¹ç·¨è™Ÿ</label>
      <div class="search-input-group">
        <input 
          type="text" 
          id="trackingInput" 
          class="search-input" 
          placeholder="è«‹è¼¸å…¥åŒ…è£¹ç·¨è™Ÿï¼ˆä¾‹å¦‚ï¼šSHP-20251027-8893ï¼‰"
          autocomplete="off"
        >
        <button id="searchBtn" class="search-btn">ğŸ” æŸ¥è©¢</button>
      </div>
      <div class="search-hint">
        ğŸ’¡ æç¤ºï¼šåŒ…è£¹ç·¨è™Ÿå¯åœ¨å–ä»¶å–®æˆ–ç°¡è¨Šé€šçŸ¥ä¸­æ‰¾åˆ°
      </div>
    </div>

    <!-- è¼‰å…¥å‹•ç•« -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <div>æŸ¥è©¢ä¸­...</div>
    </div>

    <!-- æç¤ºè¨Šæ¯ -->
    <div id="alert" class="alert"></div>

    <!-- çµæœå¡ç‰‡ -->
    <div id="resultCard" class="result-card">
      <div class="result-header">
        <div class="result-icon">ğŸ“¦</div>
        <div id="statusBadge" class="status-badge">å¾…å–ä»¶</div>
      </div>

      <div class="result-body">
        <div class="info-row">
          <span class="info-label">åŒ…è£¹ç·¨è™Ÿ</span>
          <span class="info-value tracking" id="trackingNo">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">æ”¶ä»¶äºº</span>
          <span class="info-value" id="receiverName">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">å–ä»¶åœ°å€</span>
          <span class="info-value" id="storeAddress">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">åŒ…è£¹ç‹€æ…‹</span>
          <span class="info-value" id="statusText">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">æ›´æ–°æ™‚é–“</span>
          <span class="info-value" id="updateTime">-</span>
        </div>
        <div class="info-row" id="codRow" style="display: none;">
          <span class="info-label">ä»£æ”¶é‡‘é¡</span>
          <span class="info-value amount" id="codAmount">NT$ 0</span>
        </div>
      </div>

      <!-- æ­·å²è¨˜éŒ„ -->
      <div class="history-section" id="historySection" style="display: none;">
        <div class="history-title">
          ğŸ“‹ é…é€æ­·å²
        </div>
        <div class="timeline" id="timeline">
          <!-- å‹•æ…‹ç”Ÿæˆ -->
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-secondary" onclick="resetSearch()">
          ğŸ”„ é‡æ–°æŸ¥è©¢
        </button>
        <button class="btn btn-primary" onclick="shareResult()">
          ğŸ“¤ åˆ†äº«çµæœ
        </button>
      </div>
    </div>

    <!-- é å°¾ -->
    <div class="footer">
      <p>Â© 2025 <a href="../../index.html">è²¨ç‰©ç®¡ç†ç³»çµ±</a></p>
      <p>éœ€è¦å¹«åŠ©ï¼Ÿ</p>
    </div>
  </div>

  <script>
    // Supabase åˆå§‹åŒ–
    const { createClient } = supabase;
    const supabaseClient = createClient(CONFIG.SUPABASE.URL, CONFIG.SUPABASE.ANON_KEY);

    // DOM å…ƒç´ 
    const trackingInput = document.getElementById('trackingInput');
    const searchBtn = document.getElementById('searchBtn');
    const loading = document.getElementById('loading');
    const alert = document.getElementById('alert');
    const resultCard = document.getElementById('resultCard');
    const historySection = document.getElementById('historySection');
    const timeline = document.getElementById('timeline');

    // åˆå§‹åŒ–
    function init() {
      // ç›£è½è¼¸å…¥æ¡† Enter éµ
      trackingInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          searchPackage();
        }
      });

      // ç›£è½æŸ¥è©¢æŒ‰éˆ•
      searchBtn.addEventListener('click', searchPackage);

      // æª¢æŸ¥ URL åƒæ•¸
      const urlParams = new URLSearchParams(window.location.search);
      const tracking = urlParams.get('tracking');
      if (tracking) {
        trackingInput.value = tracking;
        searchPackage();
      }
    }

    // é®è”½æ”¶ä»¶äººå§“åï¼ˆä¿ç•™é¦–å°¾å­—ï¼Œä¸­é–“æœ€å¤šç”¨å…©å€‹ O é®è”½ï¼‰
    function maskReceiverName(name) {
      if (!name || name.length === 0) {
        return '---';
      }
      
      // å–®å­—åç¨±ï¼ˆä¾‹å¦‚ï¼šç‹ï¼‰
      if (name.length === 1) {
        return name;
      }
      
      // å…©å­—åç¨±ï¼ˆä¾‹å¦‚ï¼šç‹æ˜ â†’ ç‹Oï¼‰
      if (name.length === 2) {
        return name[0] + 'O';
      }
      
      // ä¸‰å­—ä»¥ä¸Šåç¨±ï¼ˆä¾‹å¦‚ï¼šç‹å°æ˜ â†’ ç‹Oæ˜ã€æ­é™½å¨œå¨œ â†’ æ­OOå¨œï¼‰
      // ä¸­é–“æœ€å¤šåªé¡¯ç¤ºå…©å€‹ Oï¼Œå³ä½¿åå­—å†é•·
      const firstChar = name[0];
      const lastChar = name[name.length - 1];
      const middleLength = name.length - 2;
      const maskedMiddle = middleLength === 1 ? 'O' : 'OO';
      
      return firstChar + maskedMiddle + lastChar;
    }

    // æŸ¥è©¢åŒ…è£¹
    async function searchPackage() {
      const trackingNo = trackingInput.value.trim();

      // é©—è­‰è¼¸å…¥
      if (!trackingNo) {
        showAlert('è«‹è¼¸å…¥åŒ…è£¹ç·¨è™Ÿ', 'warning');
        return;
      }

      // é¡¯ç¤ºè¼‰å…¥
      showLoading(true);
      hideAlert();
      hideResult();

      try {
        // æŸ¥è©¢åŒ…è£¹
        const { data: shipment, error } = await supabaseClient
          .from('shipments')
          .select('*')
          .eq('tracking_no', trackingNo)
          .single();

        if (error || !shipment) {
          showAlert('âš ï¸ æŸ¥ç„¡æ­¤åŒ…è£¹ï¼Œè«‹ç¢ºèªå–®è™Ÿæ˜¯å¦æ­£ç¢º', 'error');
          showLoading(false);
          return;
        }

        // æŸ¥è©¢æ­·å²è¨˜éŒ„
        const { data: logs } = await supabaseClient
          .from('logs')
          .select('*')
          .eq('shipment_id', shipment.id)
          .order('created_at', { ascending: false });

        // é¡¯ç¤ºçµæœ
        displayResult(shipment, logs || []);
        showLoading(false);

      } catch (error) {
        console.error('æŸ¥è©¢å¤±æ•—ï¼š', error);
        showAlert('ç³»çµ±å¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        showLoading(false);
      }
    }

    // é¡¯ç¤ºçµæœ
    function displayResult(shipment, logs) {
      // åŸºæœ¬è³‡è¨Š
      document.getElementById('trackingNo').textContent = shipment.tracking_no;
      
      // æ”¶ä»¶äººå§“åé®è”½è™•ç†ï¼ˆä¾‹å¦‚ï¼šç‹å°æ˜ â†’ ç‹Oæ˜ã€å¼µä¸‰ä¸° â†’ å¼µOä¸°ã€æå›› â†’ æOï¼‰
      const maskedName = maskReceiverName(shipment.receiver_name);
      document.getElementById('receiverName').textContent = maskedName;
      
      // å–ä»¶åœ°å€ï¼ˆå„ªå…ˆä½¿ç”¨ receiver_addressï¼Œæ²’æœ‰å‰‡ä½¿ç”¨åº—å®¶åœ°å€ï¼‰
      const address = shipment.receiver_address || 
                      CONFIG.UI.PRINT.COMPANY.ADDRESS || 
                      'è«‹æ´½è©¢å®¢æœ';
      document.getElementById('storeAddress').textContent = address;
      
      document.getElementById('statusText').textContent = shipment.status;
      document.getElementById('updateTime').textContent = new Date(shipment.updated_at).toLocaleString('zh-TW');

      // ç‹€æ…‹å¾½ç« 
      const statusBadge = document.getElementById('statusBadge');
      statusBadge.textContent = getStatusIcon(shipment.status) + ' ' + shipment.status;
      statusBadge.className = 'status-badge ' + shipment.status.replace(/\s+/g, '').replace(/ï¼Œ/g, '');

      // ä»£æ”¶é‡‘é¡
      if (shipment.cod_amount && shipment.cod_amount > 0) {
        document.getElementById('codRow').style.display = 'flex';
        document.getElementById('codAmount').textContent = 'NT$ ' + shipment.cod_amount;
      } else {
        document.getElementById('codRow').style.display = 'none';
      }

      // é¡¯ç¤ºæ­·å²è¨˜éŒ„
      if (logs && logs.length > 0) {
        displayHistory(logs);
        historySection.style.display = 'block';
      } else {
        historySection.style.display = 'none';
      }

      // é¡¯ç¤ºæç¤ºè¨Šæ¯
      if (shipment.status === 'åŒ…è£¹å·²é…é”å–ä»¶é–€å¸‚' || shipment.status.includes('å¾…å–ä»¶')) {
        showAlert('ğŸ’¡ åŒ…è£¹å·²åˆ°é”å–ä»¶åœ°é»ï¼Œè«‹å‰å¾€æ«ƒæª¯æˆ–ä½¿ç”¨è‡ªåŠ©å ±åˆ°æ©Ÿå®Œæˆå–ä»¶', 'info');
      } else if (shipment.status === 'å–ä»¶æˆåŠŸ' || shipment.status.includes('å·²å–ä»¶')) {
        showAlert('âœ… æ­¤åŒ…è£¹å·²å®Œæˆå–ä»¶', 'success');
      }

      // é¡¯ç¤ºçµæœå¡ç‰‡
      resultCard.classList.add('show');
    }

    // é¡¯ç¤ºæ­·å²è¨˜éŒ„
    function displayHistory(logs) {
      timeline.innerHTML = logs.map(log => `
        <div class="timeline-item">
          <div class="timeline-status">
            ${getStatusIcon(log.new_status || log.action)} ${log.new_status || log.action}
          </div>
          <div class="timeline-time">
            ${new Date(log.created_at).toLocaleString('zh-TW')}
          </div>
        </div>
      `).join('');
    }

    // å–å¾—ç‹€æ…‹åœ–æ¨™
    function getStatusIcon(status) {
      if (!status) return 'ğŸ“¦';
      
      if (status.includes('å·²å»ºç«‹')) return 'ğŸ“';
      if (status.includes('é›¢åº—') || status.includes('é…é€ä¸­')) return 'ğŸšš';
      if (status.includes('ç†è²¨ä¸­å¿ƒ')) return 'ğŸ¢';
      if (status.includes('é…é”') || status.includes('å¾…å–ä»¶')) return 'ğŸŸ¢';
      if (status.includes('å–ä»¶æˆåŠŸ') || status.includes('å·²å–ä»¶')) return 'âœ…';
      
      return 'ğŸ“¦';
    }

    // é¡¯ç¤º/éš±è—è¼‰å…¥
    function showLoading(show) {
      loading.classList.toggle('show', show);
      searchBtn.disabled = show;
    }

    // é¡¯ç¤ºæç¤º
    function showAlert(message, type) {
      alert.textContent = message;
      alert.className = `alert ${type} show`;
    }

    // éš±è—æç¤º
    function hideAlert() {
      alert.classList.remove('show');
    }

    // éš±è—çµæœ
    function hideResult() {
      resultCard.classList.remove('show');
    }

    // é‡ç½®æœå°‹
    function resetSearch() {
      trackingInput.value = '';
      hideResult();
      hideAlert();
      trackingInput.focus();
    }

    // åˆ†äº«çµæœ
    function shareResult() {
      const trackingNo = document.getElementById('trackingNo').textContent;
      const status = document.getElementById('statusText').textContent;
      const storeAddress = document.getElementById('storeAddress').textContent;
      const updateTime = document.getElementById('updateTime').textContent;
      
      // å–å¾—ä»£æ”¶é‡‘é¡ï¼ˆå¦‚æœæœ‰ï¼‰
      const codRow = document.getElementById('codRow');
      const codAmount = codRow.style.display !== 'none' ? 
        document.getElementById('codAmount').textContent : '';
      
      // å»ºç«‹å®Œæ•´çš„åˆ†äº«ç¶²å€
      let shareUrl = window.location.href.split('?')[0] + '?tracking=' + encodeURIComponent(trackingNo);
      
      // å¦‚æœæ˜¯ file:// å”è­°ï¼Œæä¾›æ›¿ä»£èªªæ˜
      const isFileProtocol = window.location.protocol === 'file:';
      
      // å»ºç«‹åˆ†äº«æ–‡å­—
      const text = `ğŸ“¦ åŒ…è£¹æŸ¥è©¢çµæœ\n\n` +
                   `åŒ…è£¹ç·¨è™Ÿï¼š${trackingNo}\n` +
                   `ç‹€æ…‹ï¼š${status}\n` +
                   `å–ä»¶åœ°å€ï¼š${storeAddress}\n` +
                   `æ›´æ–°æ™‚é–“ï¼š${updateTime}\n` +
                   (codAmount ? `ä»£æ”¶é‡‘é¡ï¼š${codAmount}\n` : '') +
                   (isFileProtocol ? 
                     `\nâš ï¸ æœ¬åœ°æ¸¬è©¦ç’°å¢ƒ\nè«‹éƒ¨ç½²è‡³ç¶²é ä¼ºæœå™¨å¾Œä½¿ç”¨åˆ†äº«åŠŸèƒ½` : 
                     `\næŸ¥è©¢é€£çµï¼š${shareUrl}`);

      // æª¢æŸ¥æ˜¯å¦æ”¯æ´ Web Share APIï¼ˆä¸”é file:// å”è­°ï¼‰
      if (navigator.share && !isFileProtocol && window.location.protocol === 'https:') {
        navigator.share({
          title: 'åŒ…è£¹æŸ¥è©¢çµæœ',
          text: text,
          url: shareUrl
        }).then(() => {
          showAlert('âœ… åˆ†äº«æˆåŠŸ', 'success');
          setTimeout(hideAlert, 2000);
        }).catch(err => {
          if (err.name !== 'AbortError') {
            console.log('åˆ†äº«å–æ¶ˆæˆ–å¤±æ•—ï¼š', err);
            fallbackCopy(text);
          }
        });
      } else {
        // å‚™ç”¨æ–¹æ¡ˆï¼šè¤‡è£½åˆ°å‰ªè²¼ç°¿
        fallbackCopy(text);
      }
    }
    
    // å‚™ç”¨è¤‡è£½åŠŸèƒ½
    function fallbackCopy(text) {
      // å˜—è©¦ä½¿ç”¨ Clipboard API
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
          showAlert('âœ… æŸ¥è©¢çµæœå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
          setTimeout(hideAlert, 3000);
        }).catch(err => {
          console.error('è¤‡è£½å¤±æ•—ï¼š', err);
          // æœ€å¾Œå‚™ç”¨æ–¹æ¡ˆï¼šé¡¯ç¤ºæ–‡å­—æ¡†è®“ä½¿ç”¨è€…æ‰‹å‹•è¤‡è£½
          showCopyDialog(text);
        });
      } else {
        // èˆŠç‰ˆç€è¦½å™¨ï¼šä½¿ç”¨ execCommand
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        
        try {
          document.execCommand('copy');
          showAlert('âœ… æŸ¥è©¢çµæœå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
          setTimeout(hideAlert, 3000);
        } catch (err) {
          console.error('è¤‡è£½å¤±æ•—ï¼š', err);
          showCopyDialog(text);
        }
        
        document.body.removeChild(textarea);
      }
    }
    
    // é¡¯ç¤ºè¤‡è£½å°è©±æ¡†ï¼ˆæœ€å¾Œå‚™ç”¨æ–¹æ¡ˆï¼‰
    function showCopyDialog(text) {
      const dialog = document.createElement('div');
      dialog.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        z-index: 10000;
        max-width: 90%;
        width: 400px;
      `;
      
      dialog.innerHTML = `
        <div style="font-size: 18px; font-weight: bold; margin-bottom: 12px;">è«‹æ‰‹å‹•è¤‡è£½</div>
        <textarea readonly style="width: 100%; height: 200px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; font-family: inherit; resize: none;">${text}</textarea>
        <button onclick="this.parentElement.remove()" style="margin-top: 12px; width: 100%; padding: 12px; background: #0a84ff; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">é—œé–‰</button>
      `;
      
      document.body.appendChild(dialog);
      dialog.querySelector('textarea').select();
    }

    // ============================================
    // LIFF æ•´åˆåŠŸèƒ½
    // ============================================
    
    let isLiffApp = false;
    let lineProfile = null;

    // åˆå§‹åŒ– LIFFï¼ˆå¦‚æœåœ¨ LINE å…§é–‹å•Ÿï¼‰
    async function initLiff() {
      try {
        // æª¢æŸ¥æ˜¯å¦å·²è¨­å®š LIFF ID ä¸”åœ¨ LINE ç’°å¢ƒå…§
        if (!CONFIG.LINE.LIFF_ID || typeof liff === 'undefined') {
          console.log('â„¹ï¸ é LINE ç’°å¢ƒæˆ–æœªè¨­å®š LIFF');
          return;
        }

        console.log('ğŸš€ åˆå§‹åŒ– LIFF...');
        await liff.init({ liffId: CONFIG.LINE.LIFF_ID });
        
        if (liff.isInClient()) {
          isLiffApp = true;
          console.log('âœ… åœ¨ LINE å…§é–‹å•Ÿ');
          
          // å–å¾— LINE ä½¿ç”¨è€…è³‡æ–™
          if (liff.isLoggedIn()) {
            lineProfile = await liff.getProfile();
            console.log('ğŸ‘¤ LINE ä½¿ç”¨è€…ï¼š', lineProfile.displayName);
            
            // è‡ªå‹•æŸ¥è©¢å·²ç¶å®šæ‰‹æ©Ÿçš„åŒ…è£¹
            await autoLoadPackages();
          }
        }
      } catch (error) {
        console.error('âŒ LIFF åˆå§‹åŒ–å¤±æ•—ï¼š', error);
      }
    }

    // è‡ªå‹•è¼‰å…¥å·²ç¶å®šæ‰‹æ©Ÿçš„åŒ…è£¹
    async function autoLoadPackages() {
      try {
        if (!lineProfile) return;
        
        // æŸ¥è©¢ç¶å®šè³‡è¨Š
        const { data: binding } = await supabaseClient
          .from('line_bindings')
          .select('phone')
          .eq('line_user_id', lineProfile.userId)
          .single();
        
        if (binding && binding.phone) {
          console.log('ğŸ“± å·²ç¶å®šæ‰‹æ©Ÿï¼š', binding.phone);
          
          // é¡¯ç¤ºã€Œæˆ‘çš„åŒ…è£¹ã€æç¤º
          showMyPackagesHint(binding.phone);
        }
      } catch (error) {
        console.log('â„¹ï¸ å°šæœªç¶å®šæ‰‹æ©Ÿè™Ÿç¢¼');
      }
    }

    // é¡¯ç¤ºã€Œæˆ‘çš„åŒ…è£¹ã€æç¤º
    function showMyPackagesHint(phone) {
      const searchCard = document.querySelector('.search-card');
      
      const hint = document.createElement('div');
      hint.style.cssText = `
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 16px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      `;
      
      hint.innerHTML = `
        <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">
          ğŸ‘‹ ${lineProfile.displayName}ï¼Œæ­¡è¿å›ä¾†ï¼
        </div>
        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 12px;">
          å·²ç¶å®šæ‰‹æ©Ÿï¼š${phone.replace(/(\d{4})(\d{3})(\d{3})/, '$1-$2-$3')}
        </div>
        <button onclick="loadMyPackages('${phone}')" style="
          background: white;
          color: #667eea;
          border: none;
          padding: 10px 20px;
          border-radius: 8px;
          font-weight: 600;
          cursor: pointer;
          font-size: 14px;
        ">
          ğŸ“¦ æŸ¥çœ‹æˆ‘çš„åŒ…è£¹
        </button>
      `;
      
      searchCard.insertBefore(hint, searchCard.firstChild);
    }

    // è¼‰å…¥æˆ‘çš„åŒ…è£¹ï¼ˆæ ¹æ“šç¶å®šæ‰‹æ©Ÿï¼‰
    async function loadMyPackages(phone) {
      showAlert('ğŸ” æŸ¥è©¢ä¸­...', 'info');
      
      try {
        const { data, error } = await supabaseClient
          .from('shipments')
          .select('*')
          .eq('receiver_phone', phone)
          .order('created_at', { ascending: false })
          .limit(5);
        
        if (error) throw error;
        
        hideAlert();
        
        if (!data || data.length === 0) {
          showAlert('æš«ç„¡åŒ…è£¹è¨˜éŒ„', 'warning');
          return;
        }
        
        // é¡¯ç¤ºç¬¬ä¸€ç­†çµæœ
        displayResult(data[0]);
        
        // å¦‚æœæœ‰å¤šç­†ï¼Œé¡¯ç¤ºåˆ—è¡¨
        if (data.length > 1) {
          showPackageList(data);
        }
      } catch (error) {
        console.error('âŒ æŸ¥è©¢å¤±æ•—ï¼š', error);
        showAlert('æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
      }
    }

    // é¡¯ç¤ºåŒ…è£¹åˆ—è¡¨
    function showPackageList(packages) {
      const resultCard = document.querySelector('.result-card');
      
      const listHtml = `
        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border);">
          <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">
            ğŸ“‹ æ‚¨çš„å…¶ä»–åŒ…è£¹ï¼ˆ${packages.length - 1} ç­†ï¼‰
          </div>
          ${packages.slice(1).map(pkg => `
            <div onclick="document.getElementById('trackingInput').value='${pkg.tracking_no}'; searchTracking();" style="
              padding: 12px;
              background: var(--bg);
              border-radius: 8px;
              margin-bottom: 8px;
              cursor: pointer;
              transition: all 0.2s;
            " onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='var(--bg)'">
              <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                ${pkg.tracking_no}
              </div>
              <div style="font-size: 13px; color: var(--text-secondary);">
                ${pkg.status || 'è™•ç†ä¸­'} Â· ${new Date(pkg.created_at).toLocaleDateString()}
              </div>
            </div>
          `).join('')}
        </div>
      `;
      
      resultCard.innerHTML += listHtml;
    }

    // è¦†å¯«åˆ†äº«åŠŸèƒ½ï¼ˆLIFF ç’°å¢ƒä¸‹ä½¿ç”¨ LINE åˆ†äº«ï¼‰
    const originalShareResult = shareResult;
    shareResult = function() {
      if (isLiffApp && liff.isApiAvailable('shareTargetPicker')) {
        shareToLINE();
      } else {
        originalShareResult();
      }
    };

    // LINE åˆ†äº«
    function shareToLINE() {
      const trackingNo = document.getElementById('trackingNo').textContent;
      const status = document.getElementById('statusText').textContent;
      const storeAddress = document.getElementById('storeAddress').textContent;
      
      const shareUrl = window.location.href.split('?')[0] + '?tracking=' + encodeURIComponent(trackingNo);
      
      // Flex Message æ ¼å¼
      const flexMessage = {
        type: 'flex',
        altText: `ğŸ“¦ åŒ…è£¹ ${trackingNo} æŸ¥è©¢çµæœ`,
        contents: {
          type: 'bubble',
          hero: {
            type: 'box',
            layout: 'vertical',
            contents: [
              {
                type: 'text',
                text: 'ğŸ“¦ åŒ…è£¹æŸ¥è©¢',
                weight: 'bold',
                size: 'xl',
                color: '#ffffff'
              }
            ],
            backgroundColor: CONFIG.LINE.MESSAGING.FLEX_MESSAGE_COLOR || '#0a84ff',
            paddingAll: '20px'
          },
          body: {
            type: 'box',
            layout: 'vertical',
            contents: [
              {
                type: 'text',
                text: trackingNo,
                weight: 'bold',
                size: 'lg',
                margin: 'md'
              },
              {
                type: 'box',
                layout: 'vertical',
                margin: 'lg',
                spacing: 'sm',
                contents: [
                  {
                    type: 'box',
                    layout: 'baseline',
                    spacing: 'sm',
                    contents: [
                      {
                        type: 'text',
                        text: 'ç‹€æ…‹',
                        color: '#aaaaaa',
                        size: 'sm',
                        flex: 1
                      },
                      {
                        type: 'text',
                        text: status,
                        wrap: true,
                        color: '#666666',
                        size: 'sm',
                        flex: 3
                      }
                    ]
                  },
                  {
                    type: 'box',
                    layout: 'baseline',
                    spacing: 'sm',
                    contents: [
                      {
                        type: 'text',
                        text: 'å–ä»¶åœ°å€',
                        color: '#aaaaaa',
                        size: 'sm',
                        flex: 1
                      },
                      {
                        type: 'text',
                        text: storeAddress,
                        wrap: true,
                        color: '#666666',
                        size: 'sm',
                        flex: 3
                      }
                    ]
                  }
                ]
              }
            ]
          },
          footer: {
            type: 'box',
            layout: 'vertical',
            spacing: 'sm',
            contents: [
              {
                type: 'button',
                style: 'primary',
                height: 'sm',
                action: {
                  type: 'uri',
                  label: 'æŸ¥çœ‹è©³ç´°è³‡è¨Š',
                  uri: shareUrl
                }
              }
            ]
          }
        }
      };
      
      liff.shareTargetPicker([flexMessage])
        .then(() => {
          showAlert('âœ… åˆ†äº«æˆåŠŸ', 'success');
          setTimeout(hideAlert, 2000);
        })
        .catch((error) => {
          console.error('åˆ†äº«å¤±æ•—ï¼š', error);
          // å‚™ç”¨ï¼šä½¿ç”¨åŸæœ¬çš„åˆ†äº«åŠŸèƒ½
          originalShareResult();
        });
    }

    // ============================================
    // åˆå§‹åŒ–ï¼ˆåŠ å…¥ LIFF æ”¯æ´ï¼‰
    // ============================================
    
    async function initApp() {
      // å…ˆåˆå§‹åŒ– LIFF
      await initLiff();
      
      // å†åŸ·è¡ŒåŸæœ¬çš„åˆå§‹åŒ–
      init();
    }

    // å•Ÿå‹•
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }
  </script>
</body>
</html>

