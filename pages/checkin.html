<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‡ªåŠ©å ±åˆ° - Kiosk ç³»çµ±</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../config.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #434343;
      --success: #28c76f;
      --danger: #ff3b30;
      --warning: #ff9500;
      --muted: #6b7280;
      --bg: #f5f7fa;
      --card-bg: #ffffff;
      --border: #e5e7eb;
    }

    body {
      font-family: "Microsoft JhengHei", "Noto Sans TC", -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #e3e3e3 0%, #dfdfdf 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .kiosk-container {
      background: var(--card-bg);
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 600px;
      width: 100%;
      overflow: hidden;
    }

    .kiosk-header {
      background: linear-gradient(135deg, #4a4a4a, #2c2c2c);
      color: white;
      padding: 40px 32px;
      text-align: center;
    }

    .kiosk-logo {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .kiosk-title {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .kiosk-subtitle {
      font-size: 18px;
      opacity: 0.9;
    }

    .kiosk-body {
      padding: 40px 32px;
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 32px;
    }

    .step {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--border);
      transition: all 0.3s;
    }

    .step.active {
      background: var(--primary);
      width: 32px;
      border-radius: 6px;
    }

    .screen {
      display: none;
    }

    .screen.active {
      display: block;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .instruction {
      text-align: center;
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 24px;
      color: #1f2937;
    }

    .phone-input-group {
      text-align: center;
      margin-bottom: 32px;
    }

    .phone-display {
      font-size: 48px;
      font-weight: bold;
      letter-spacing: 8px;
      color: var(--primary);
      min-height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: "Courier New", monospace;
    }

    .numpad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      max-width: 400px;
      margin: 0 auto;
    }

    .num-btn {
      padding: 24px;
      font-size: 28px;
      font-weight: 600;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }

    .num-btn:hover {
      background: var(--bg);
      border-color: var(--primary);
    }

    .num-btn:active {
      transform: scale(0.95);
    }

    .num-btn.wide {
      grid-column: span 2;
    }

    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .btn {
      flex: 1;
      padding: 18px 24px;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: #0066cc;
    }

    .btn-secondary {
      background: var(--muted);
      color: white;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .info-card {
      background: var(--bg);
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      color: var(--muted);
      font-weight: 500;
    }

    .info-value {
      font-weight: 600;
      color: #1f2937;
    }

    .checkin-number {
      text-align: center;
      margin: 32px 0;
    }

    .checkin-number-label {
      font-size: 18px;
      color: var(--muted);
      margin-bottom: 12px;
    }

    .checkin-number-value {
      font-size: 72px;
      font-weight: bold;
      color: var(--success);
      font-family: "Courier New", monospace;
    }

    .success-icon {
      text-align: center;
      font-size: 80px;
      margin-bottom: 24px;
    }

    .message {
      text-align: center;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 24px;
      font-weight: 500;
    }

    .message.error {
      background: #ffecee;
      color: var(--danger);
    }

    .message.warning {
      background: #fff8e6;
      color: var(--warning);
    }

    .message.success {
      background: #e8f7ee;
      color: var(--success);
    }

    .loading {
      text-align: center;
      padding: 40px;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="kiosk-container">
    <!-- é ­éƒ¨ -->
    <div class="kiosk-header">
      <div class="kiosk-logo">ğŸ·ï¸</div>
      <h1 class="kiosk-title">è‡ªåŠ©å ±åˆ°</h1>
      <p class="kiosk-subtitle">è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼æŸ¥è©¢åŒ…è£¹</p>
    </div>

    <div class="kiosk-body">
      <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
      <div class="step-indicator">
        <div class="step active" id="step1"></div>
        <div class="step" id="step2"></div>
        <div class="step" id="step3"></div>
      </div>

      <!-- ç•«é¢ 1: è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼ -->
      <div id="screen1" class="screen active">
        <div class="instruction">è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆ10 ç¢¼ï¼‰</div>
        
        <div class="phone-input-group">
          <div class="phone-display" id="phoneDisplay">__________</div>
        </div>

        <div class="numpad">
          <button class="num-btn" onclick="inputNumber('1')">1</button>
          <button class="num-btn" onclick="inputNumber('2')">2</button>
          <button class="num-btn" onclick="inputNumber('3')">3</button>
          <button class="num-btn" onclick="inputNumber('4')">4</button>
          <button class="num-btn" onclick="inputNumber('5')">5</button>
          <button class="num-btn" onclick="inputNumber('6')">6</button>
          <button class="num-btn" onclick="inputNumber('7')">7</button>
          <button class="num-btn" onclick="inputNumber('8')">8</button>
          <button class="num-btn" onclick="inputNumber('9')">9</button>
          <button class="num-btn" onclick="clearInput()">æ¸…é™¤</button>
          <button class="num-btn" onclick="inputNumber('0')">0</button>
          <button class="num-btn" onclick="deleteNumber()">â†</button>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="resetKiosk()">å–æ¶ˆ</button>
          <button class="btn btn-primary" onclick="searchByPhone()">æŸ¥è©¢</button>
        </div>
      </div>

      <!-- ç•«é¢ 2: ç¢ºèªèº«ä»½ -->
      <div id="screen2" class="screen">
        <div class="instruction">è«‹ç¢ºèªæ‚¨çš„è³‡è¨Š</div>
        
        <div id="confirmMessage"></div>

        <div class="info-card">
          <div class="info-row">
            <span class="info-label">æ”¶ä»¶äºº</span>
            <span class="info-value" id="receiverName">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">é›»è©±æœ«ä¸‰ç¢¼</span>
            <span class="info-value" id="receiverPhone">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">å–ä»¶å–®è™Ÿ</span>
            <span class="info-value" id="trackingNo">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">ä»£æ”¶é‡‘é¡</span>
            <span class="info-value" id="codAmount" style="color: var(--danger); font-size: 24px;">-</span>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="backToInput()">è¿”å›</button>
          <button class="btn btn-primary" onclick="confirmCheckin()">ç¢ºèªå ±åˆ°</button>
        </div>
      </div>

      <!-- ç•«é¢ 3: å®Œæˆå ±åˆ° -->
      <div id="screen3" class="screen">
        <div class="success-icon">âœ…</div>
        <div class="instruction">å ±åˆ°æˆåŠŸï¼</div>
        
        <div class="checkin-number">
          <div class="checkin-number-label">æ‚¨çš„å ±åˆ°è™Ÿç¢¼</div>
          <div class="checkin-number-value" id="checkinNumber">001</div>
        </div>

        <div class="message success">
          è«‹ç¨å¾…å«è™Ÿï¼Œæˆ‘å€‘æ­£åœ¨ç‚ºæ‚¨æº–å‚™åŒ…è£¹...
        </div>

        <div class="info-card">
          <div class="info-row">
            <span class="info-label">ä»£æ”¶é‡‘é¡</span>
            <span class="info-value" id="finalCodAmount" style="color: var(--danger); font-size: 20px;">$0</span>
          </div>
          <div class="info-row">
            <span class="info-label">å ±åˆ°æ™‚é–“</span>
            <span class="info-value" id="checkinTime">-</span>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="printCheckinTicket()">é‡æ–°åˆ—å°</button>
          <button class="btn btn-primary" onclick="resetKiosk()">å®Œæˆ</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Supabase åˆå§‹åŒ–
    const { createClient } = supabase;
    const supabaseClient = createClient(CONFIG.SUPABASE.URL, CONFIG.SUPABASE.ANON_KEY);

    // å…¨åŸŸè®Šæ•¸
    let phoneNumber = '';
    let currentShipment = null;
    let currentCheckin = null;
    const storeCode = 'ST001'; // å¯¦éš›æ‡‰è©²å¾è¨­å®šè®€å–

    // è¼¸å…¥æ•¸å­—
    function inputNumber(num) {
      if (phoneNumber.length < 10) {
        phoneNumber += num;
        updatePhoneDisplay();
      }
    }

    // åˆªé™¤æ•¸å­—
    function deleteNumber() {
      phoneNumber = phoneNumber.slice(0, -1);
      updatePhoneDisplay();
    }

    // æ¸…é™¤è¼¸å…¥
    function clearInput() {
      phoneNumber = '';
      updatePhoneDisplay();
    }

    // æ›´æ–°é¡¯ç¤º
    function updatePhoneDisplay() {
      const display = document.getElementById('phoneDisplay');
      const formatted = phoneNumber.padEnd(10, '_');
      display.textContent = formatted;
    }

    // æŸ¥è©¢åŒ…è£¹
    async function searchByPhone() {
      if (phoneNumber.length !== 10) {
        showMessage('è«‹è¼¸å…¥å®Œæ•´çš„ 10 ç¢¼æ‰‹æ©Ÿè™Ÿç¢¼', 'error', 'screen1');
        return;
      }

      showLoading('screen1');

      try {
        // è¨˜éŒ„æŸ¥è©¢å‹•ä½œ
        await logKioskAction('phone_search', null, null, phoneNumber);

        // æŸ¥è©¢åŒ…è£¹
        const { data: shipments, error } = await supabaseClient
          .from('shipments')
          .select('*')
          .like('receiver_phone', `%${phoneNumber}%`)
          .in('status', ['åŒ…è£¹å·²é…é”å–ä»¶é–€å¸‚', 'ç‰©æµå–®å·²å»ºç«‹', 'åŒ…è£¹é›¢åº—ä½œæ¥­ä¸­', 'åŒ…è£¹æŠµé”ç†è²¨ä¸­å¿ƒï¼Œè™•ç†ä¸­'])
          .order('created_at', { ascending: false });

        if (error) throw error;

        if (!shipments || shipments.length === 0) {
          showMessage('æŸ¥ç„¡å¾…å–ä»¶åŒ…è£¹ï¼Œè«‹ç¢ºèªé›»è©±è™Ÿç¢¼æˆ–è¯ç¹«æ«ƒæª¯', 'error', 'screen1');
          return;
        }

        // æª¢æŸ¥æ˜¯å¦å·²å ±åˆ°
        const { data: existingCheckin } = await supabaseClient
          .from('checkin_records')
          .select('*')
          .eq('tracking_no', shipments[0].tracking_no)
          .gte('checkin_time', new Date().toISOString().split('T')[0])
          .in('status', ['å¾…å«è™Ÿ', 'å·²å«è™Ÿ'])
          .single();

        if (existingCheckin) {
          showMessage(`æ­¤åŒ…è£¹å·²å ±åˆ°ï¼Œè™Ÿç¢¼ï¼š${existingCheckin.checkin_no}`, 'warning', 'screen1');
          return;
        }

        // é¡¯ç¤ºç¢ºèªç•«é¢
        currentShipment = shipments[0];
        showConfirmScreen();

      } catch (error) {
        console.error('æŸ¥è©¢å¤±æ•—ï¼š', error);
        showMessage('ç³»çµ±æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–è¯ç¹«æ«ƒæª¯', 'error', 'screen1');
      } finally {
        hideLoading('screen1');
      }
    }

    // é¡¯ç¤ºç¢ºèªç•«é¢
    function showConfirmScreen() {
      document.getElementById('receiverName').textContent = 
        currentShipment.receiver_name.substring(0, 2) + '**';
      document.getElementById('receiverPhone').textContent = 
        currentShipment.receiver_phone.slice(-3);
      document.getElementById('trackingNo').textContent = currentShipment.tracking_no;
      document.getElementById('codAmount').textContent = 
        `$${currentShipment.cod_amount || 0}`;

      if (currentShipment.cod_amount && currentShipment.cod_amount > 0) {
        document.getElementById('confirmMessage').innerHTML = 
          '<div class="message warning">âš ï¸ æ­¤åŒ…è£¹éœ€æ”¯ä»˜ä»£æ”¶é‡‘é¡ï¼Œè«‹å…ˆå‚™å¦¥ç¾é‡‘</div>';
      } else {
        document.getElementById('confirmMessage').innerHTML = '';
      }

      switchScreen(2);
    }

    // ç¢ºèªå ±åˆ°
    async function confirmCheckin() {
      showLoading('screen2');

      try {
        // ç”Ÿæˆå ±åˆ°è™Ÿç¢¼
        const { data: checkinNo, error: noError } = await supabaseClient
          .rpc('generate_checkin_no');

        if (noError) throw noError;

        // å»ºç«‹å ±åˆ°è¨˜éŒ„
        const { data: checkin, error: checkinError } = await supabaseClient
          .from('checkin_records')
          .insert({
            checkin_no: checkinNo,
            shipment_id: currentShipment.id,
            tracking_no: currentShipment.tracking_no,
            receiver_name: currentShipment.receiver_name,
            receiver_phone: currentShipment.receiver_phone,
            cod_amount: currentShipment.cod_amount || 0,
            status: 'å¾…å«è™Ÿ',
            store_code: storeCode,
            print_count: 0
          })
          .select()
          .single();

        if (checkinError) throw checkinError;

        currentCheckin = checkin;

        // è¨˜éŒ„å ±åˆ°å‹•ä½œ
        await logKioskAction('checkin_completed', checkin.checkin_no, checkin.tracking_no, phoneNumber);

        // åˆ—å°å ±åˆ°å–®
        await printCheckinTicket();

        // é¡¯ç¤ºå®Œæˆç•«é¢
        showCompleteScreen();

      } catch (error) {
        console.error('å ±åˆ°å¤±æ•—ï¼š', error);
        if (error.message.includes('å·²å ±åˆ°')) {
          showMessage('æ­¤åŒ…è£¹ä»Šæ—¥å·²å ±åˆ°ï¼Œè«‹å‹¿é‡è¤‡å ±åˆ°', 'error', 'screen2');
        } else {
          showMessage('å ±åˆ°å¤±æ•—ï¼š' + error.message, 'error', 'screen2');
        }
      } finally {
        hideLoading('screen2');
      }
    }

    // é¡¯ç¤ºå®Œæˆç•«é¢
    function showCompleteScreen() {
      document.getElementById('checkinNumber').textContent = currentCheckin.checkin_no;
      document.getElementById('finalCodAmount').textContent = 
        `$${currentCheckin.cod_amount || 0}`;
      document.getElementById('checkinTime').textContent = 
        new Date().toLocaleString('zh-TW');

      switchScreen(3);
    }

    // åˆ—å°å ±åˆ°å–®
    async function printCheckinTicket() {
      if (!currentCheckin) return;

      try {
        // æ›´æ–°åˆ—å°æ¬¡æ•¸
        await supabaseClient
          .from('checkin_records')
          .update({
            print_count: currentCheckin.print_count + 1,
            last_print_time: new Date().toISOString()
          })
          .eq('id', currentCheckin.id);

        // è¨˜éŒ„åˆ—å°å‹•ä½œ
        await logKioskAction('print_ticket', currentCheckin.checkin_no, currentCheckin.tracking_no);

        // ç”Ÿæˆåˆ—å°å…§å®¹
        const printContent = generatePrintContent();
        const printWindow = window.open('', '_blank', 'width=300,height=600');
        printWindow.document.write(printContent);
        printWindow.document.close();
        setTimeout(() => {
          printWindow.print();
        }, 500);

      } catch (error) {
        console.error('åˆ—å°å¤±æ•—ï¼š', error);
        alert('åˆ—å°å¤±æ•—ï¼Œè«‹è¯ç¹«æ«ƒæª¯äººå“¡');
      }
    }

    // ç”Ÿæˆåˆ—å°å…§å®¹
    function generatePrintContent() {
      return `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>å ±åˆ°å–®</title>
          <style>
            @page { size: 58mm auto; margin: 0; }
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
              width: 58mm;
              font-family: "Microsoft JhengHei", monospace;
              font-size: 10pt;
              padding: 5mm;
              line-height: 1.4;
            }
            .center { text-align: center; }
            .header { font-size: 16pt; font-weight: bold; margin-bottom: 3mm; }
            .divider { border-top: 1px dashed #000; margin: 3mm 0; }
            .number { font-size: 32pt; font-weight: bold; margin: 4mm 0; }
            .row { display: flex; justify-content: space-between; margin: 2mm 0; }
            .label { font-weight: bold; }
            .amount { font-size: 20pt; font-weight: bold; color: #000; margin: 3mm 0; }
            .note { font-size: 9pt; margin: 2mm 0; }
          </style>
        </head>
        <body>
          <div class="center header">â˜… å ±åˆ°å–® â˜…</div>
          <div class="center" style="font-size: 12pt; font-weight: bold; margin-bottom: 3mm;">
            ${CONFIG.UI.PRINT.COMPANY.NAME}
          </div>
          <div class="divider"></div>
          
          <div class="row">
            <span class="label">å ±åˆ°è™Ÿç¢¼ï¼š</span>
          </div>
          <div class="center number">${currentCheckin.checkin_no}</div>
          
          <div class="divider"></div>
          
          <div class="row">
            <span class="label">å–ä»¶å–®è™Ÿï¼š</span>
            <span>${currentCheckin.tracking_no}</span>
          </div>
          <div class="row">
            <span class="label">å ±åˆ°æ™‚é–“ï¼š</span>
            <span>${new Date().toLocaleString('zh-TW', { 
              hour: '2-digit', 
              minute: '2-digit' 
            })}</span>
          </div>
          
          <div class="divider"></div>
          
          ${currentCheckin.cod_amount > 0 ? `
            <div class="center">
              <div class="label">ä»£æ”¶é‡‘é¡</div>
              <div class="amount">$${currentCheckin.cod_amount}</div>
            </div>
            <div class="center note">è«‹å…ˆå‚™å¦¥æ‚¨çš„ç¾é‡‘</div>
            <div class="divider"></div>
          ` : ''}
          
          <div class="center note">
            è«‹ç¨å¾…å«è™Ÿ<br>
            æº–å‚™åŒ…è£¹ä¸­...
          </div>
          
          <div class="divider"></div>
          <div class="center" style="font-size: 8pt; margin-top: 3mm;">
            ${CONFIG.UI.PRINT.COMPANY.PHONE}
          </div>
        </body>
        </html>
      `;
    }

    // è¨˜éŒ„ Kiosk æ“ä½œ
    async function logKioskAction(action, checkinNo, trackingNo, phone) {
      try {
        await supabaseClient
          .from('kiosk_logs')
          .insert({
            action,
            checkin_no: checkinNo,
            tracking_no: trackingNo,
            phone_number: phone,
            store_code: storeCode,
            device_id: navigator.userAgent,
            details: {
              timestamp: new Date().toISOString(),
              screen_resolution: `${window.screen.width}x${window.screen.height}`
            }
          });
      } catch (error) {
        console.error('è¨˜éŒ„æ—¥èªŒå¤±æ•—ï¼š', error);
      }
    }

    // åˆ‡æ›ç•«é¢
    function switchScreen(screenNum) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      
      document.getElementById(`screen${screenNum}`).classList.add('active');
      document.getElementById(`step${screenNum}`).classList.add('active');
    }

    // è¿”å›è¼¸å…¥
    function backToInput() {
      switchScreen(1);
    }

    // é‡ç½® Kiosk
    function resetKiosk() {
      phoneNumber = '';
      currentShipment = null;
      currentCheckin = null;
      updatePhoneDisplay();
      switchScreen(1);
      
      // æ¸…é™¤è¨Šæ¯
      document.querySelectorAll('.message').forEach(m => m.remove());
    }

    // é¡¯ç¤ºè¨Šæ¯
    function showMessage(text, type, screenId) {
      const screen = document.getElementById(screenId);
      const existing = screen.querySelector('.message');
      if (existing) existing.remove();
      
      const message = document.createElement('div');
      message.className = `message ${type}`;
      message.textContent = text;
      screen.insertBefore(message, screen.firstChild);
      
      setTimeout(() => message.remove(), 5000);
    }

    // é¡¯ç¤ºè¼‰å…¥
    function showLoading(screenId) {
      const screen = document.getElementById(screenId);
      const loading = document.createElement('div');
      loading.className = 'loading';
      loading.id = 'loadingIndicator';
      loading.innerHTML = '<div class="spinner"></div><div>è™•ç†ä¸­...</div>';
      screen.appendChild(loading);
    }

    // éš±è—è¼‰å…¥
    function hideLoading(screenId) {
      const loading = document.getElementById('loadingIndicator');
      if (loading) loading.remove();
    }

    // åˆå§‹åŒ–
    function init() {
      updatePhoneDisplay();
      
      // ç›£è½éµç›¤è¼¸å…¥
      document.addEventListener('keydown', (e) => {
        if (document.getElementById('screen1').classList.contains('active')) {
          if (e.key >= '0' && e.key <= '9') {
            inputNumber(e.key);
          } else if (e.key === 'Backspace') {
            deleteNumber();
          } else if (e.key === 'Enter') {
            searchByPhone();
          }
        }
      });
    }

    init();
  </script>
</body>
</html>

