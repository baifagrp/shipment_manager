<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‡ªåŠ©å¯„ä»¶ - Kiosk ç³»çµ±</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script src="../../config.js"></script>
  <script src="../../email-notify-helper.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #434343;
      --success: #28c76f;
      --danger: #ff3b30;
      --warning: #ff9500;
      --info: #0a84ff;
      --muted: #6b7280;
      --bg: #f5f7fa;
      --card-bg: #ffffff;
      --border: #e5e7eb;
    }

    body {
      font-family: "Microsoft JhengHei", "Noto Sans TC", -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #e3e3e3 0%, #dfdfdf 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .kiosk-container {
      background: var(--card-bg);
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 800px;
      width: 100%;
      overflow: hidden;
    }

    .kiosk-header {
      background: linear-gradient(135deg, #4a4a4a, #2c2c2c);
      color: white;
      padding: 40px 32px;
      text-align: center;
    }

    .kiosk-logo {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .kiosk-title {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .kiosk-subtitle {
      font-size: 18px;
      opacity: 0.9;
    }

    .kiosk-body {
      padding: 40px 32px;
    }

    /* æ­¥é©ŸæŒ‡ç¤ºå™¨ */
    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 40px;
      position: relative;
    }

    .step-indicator::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--border);
      z-index: 0;
    }

    .step-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 1;
    }

    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: var(--muted);
      margin-bottom: 8px;
      transition: all 0.3s;
    }

    .step-item.active .step-circle {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
      transform: scale(1.1);
    }

    .step-item.completed .step-circle {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }

    .step-label {
      font-size: 12px;
      color: var(--muted);
      text-align: center;
    }

    .step-item.active .step-label {
      color: var(--primary);
      font-weight: 600;
    }

    /* ç•«é¢åˆ‡æ› */
    .screen {
      display: none;
    }

    .screen.active {
      display: block;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .screen-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 24px;
      color: #1f2937;
      text-align: center;
    }

    /* è¡¨å–®æ¨£å¼ */
    .form-section {
      margin-bottom: 32px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group.full-width {
      grid-column: span 2;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #374151;
      font-size: 14px;
    }

    .form-label .required {
      color: var(--danger);
      margin-left: 4px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px 16px;
      font-size: 16px;
      border: 2px solid var(--border);
      border-radius: 8px;
      transition: all 0.2s;
      font-family: inherit;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 67, 67, 0.1);
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    /* æŒ‰éˆ•çµ„ */
    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 32px;
    }

    .btn {
      flex: 1;
      padding: 16px 24px;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #2c2c2c;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(67, 67, 67, 0.3);
    }

    .btn-secondary {
      background: var(--muted);
      color: white;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #22a55e;
    }

    /* ç¢ºèªç•«é¢ */
    .confirm-section {
      background: var(--bg);
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
    }

    .confirm-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .confirm-row:last-child {
      border-bottom: none;
    }

    .confirm-label {
      color: var(--muted);
      font-weight: 500;
    }

    .confirm-value {
      font-weight: 600;
      color: #1f2937;
      text-align: right;
    }

    .confirm-value.highlight {
      color: var(--danger);
      font-size: 18px;
    }

    /* æˆåŠŸç•«é¢ */
    .success-screen {
      text-align: center;
    }

    .success-icon {
      font-size: 80px;
      margin-bottom: 24px;
      animation: bounce 0.5s;
    }

    @keyframes bounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .tracking-display {
      background: linear-gradient(135deg, var(--primary), #2c2c2c);
      color: white;
      padding: 32px;
      border-radius: 16px;
      margin: 24px 0;
    }

    .tracking-label {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 8px;
    }

    .tracking-number {
      font-size: 36px;
      font-weight: bold;
      letter-spacing: 2px;
      font-family: "Courier New", monospace;
    }

    /* è¨Šæ¯æç¤º */
    .message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .message.error {
      background: #ffecee;
      color: var(--danger);
      border: 1px solid var(--danger);
    }

    .message.warning {
      background: #fff8e6;
      color: var(--warning);
      border: 1px solid var(--warning);
    }

    .message.info {
      background: #f0f4ff;
      color: var(--info);
      border: 1px solid var(--info);
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Radio æŒ‰éˆ•çµ„ */
    .radio-group {
      display: flex;
      gap: 16px;
      margin-top: 8px;
    }

    .radio-option {
      flex: 1;
      position: relative;
    }

    .radio-option input[type="radio"] {
      position: absolute;
      opacity: 0;
    }

    .radio-label {
      display: block;
      padding: 16px;
      border: 2px solid var(--border);
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
    }

    .radio-option input[type="radio"]:checked + .radio-label {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
    }

    .radio-label:hover {
      border-color: var(--primary);
    }
  </style>
</head>
<body>
  <div class="kiosk-container">
    <!-- é ­éƒ¨ -->
    <div class="kiosk-header">
      <div class="kiosk-logo">ğŸ“¦</div>
      <h1 class="kiosk-title">è‡ªåŠ©å¯„ä»¶</h1>
      <p class="kiosk-subtitle">å¿«é€Ÿå¯„é€æ‚¨çš„åŒ…è£¹</p>
    </div>

    <div class="kiosk-body">
      <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
      <div class="step-indicator">
        <div class="step-item active" id="stepItem1">
          <div class="step-circle">1</div>
          <div class="step-label">å¯„/æ”¶ä»¶äºº</div>
        </div>
        <div class="step-item" id="stepItem2">
          <div class="step-circle">2</div>
          <div class="step-label">åŒ…è£¹è³‡è¨Š</div>
        </div>
        <div class="step-item" id="stepItem3">
          <div class="step-circle">3</div>
          <div class="step-label">è²»ç”¨è¨­å®š</div>
        </div>
        <div class="step-item" id="stepItem4">
          <div class="step-circle">4</div>
          <div class="step-label">ç¢ºèªé€å‡º</div>
        </div>
      </div>

      <!-- æ­¥é©Ÿ 1: å¯„/æ”¶ä»¶äººè³‡è¨Š -->
      <div id="screen1" class="screen active">
        <div class="screen-title">ğŸ“‹ å¡«å¯«å¯„ä»¶äººèˆ‡æ”¶ä»¶äººè³‡è¨Š</div>

        <div id="screen1Message"></div>

        <form id="step1Form">
          <!-- å¯„ä»¶äººè³‡è¨Š -->
          <div class="form-section">
            <div class="section-title">
              <span>ğŸ“¤</span>
              <span>å¯„ä»¶äººè³‡è¨Š</span>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">
                  å§“å <span class="required">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-input" 
                  id="senderName" 
                  placeholder="è«‹è¼¸å…¥å¯„ä»¶äººå§“å"
                  required
                >
              </div>
              <div class="form-group">
                <label class="form-label">
                  é›»è©± <span class="required">*</span>
                </label>
                <input 
                  type="tel" 
                  class="form-input" 
                  id="senderPhone" 
                  placeholder="0912345678"
                  pattern="[0-9]{10}"
                  required
                >
                <div class="form-hint">è«‹è¼¸å…¥10ç¢¼æ‰‹æ©Ÿè™Ÿç¢¼</div>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">
                åœ°å€ <span class="required">*</span>
              </label>
              <input 
                type="text" 
                class="form-input" 
                id="senderAddress" 
                placeholder="è«‹è¼¸å…¥å®Œæ•´åœ°å€"
                required
              >
            </div>
          </div>

          <!-- æ”¶ä»¶äººè³‡è¨Š -->
          <div class="form-section">
            <div class="section-title">
              <span>ğŸ“¥</span>
              <span>æ”¶ä»¶äººè³‡è¨Š</span>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">
                  å§“å <span class="required">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-input" 
                  id="receiverName" 
                  placeholder="è«‹è¼¸å…¥æ”¶ä»¶äººå§“å"
                  required
                >
              </div>
              <div class="form-group">
                <label class="form-label">
                  é›»è©± <span class="required">*</span>
                </label>
                <input 
                  type="tel" 
                  class="form-input" 
                  id="receiverPhone" 
                  placeholder="0912345678"
                  pattern="[0-9]{10}"
                  required
                >
                <div class="form-hint">è«‹è¼¸å…¥10ç¢¼æ‰‹æ©Ÿè™Ÿç¢¼</div>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">
                åœ°å€ <span class="required">*</span>
              </label>
              <input 
                type="text" 
                class="form-input" 
                id="receiverAddress" 
                placeholder="è«‹è¼¸å…¥å®Œæ•´åœ°å€"
                required
              >
            </div>
          </div>

          <div class="btn-group">
            <button type="button" class="btn btn-secondary" onclick="resetKiosk()">å–æ¶ˆ</button>
            <button type="submit" class="btn btn-primary">ä¸‹ä¸€æ­¥ â†’</button>
          </div>
        </form>
      </div>

      <!-- æ­¥é©Ÿ 2: åŒ…è£¹è³‡è¨Š -->
      <div id="screen2" class="screen">
        <div class="screen-title">ğŸ“¦ åŒ…è£¹è©³ç´°è³‡è¨Š</div>

        <div id="screen2Message"></div>

        <form id="step2Form">
          <div class="form-section">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">
                  å“å <span class="required">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-input" 
                  id="itemName" 
                  placeholder="ä¾‹ï¼šæ–‡ä»¶ã€è¡£ç‰©ã€3Cç”¢å“"
                  required
                >
              </div>
              <div class="form-group">
                <label class="form-label">
                  æ•¸é‡
                </label>
                <input 
                  type="number" 
                  class="form-input" 
                  id="quantity" 
                  value="1"
                  min="1"
                  max="99"
                >
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label">
                  é‡é‡ (kg)
                </label>
                <input 
                  type="number" 
                  class="form-input" 
                  id="weight" 
                  placeholder="0.5"
                  step="0.1"
                  min="0.1"
                  max="30"
                >
                <div class="form-hint">é¸å¡«ï¼Œæœ€å¤§30å…¬æ–¤</div>
              </div>
              <div class="form-group">
                <label class="form-label">
                  å°ºå¯¸ (cm)
                </label>
                <input 
                  type="text" 
                  class="form-input" 
                  id="dimensions" 
                  placeholder="é•· x å¯¬ x é«˜"
                >
                <div class="form-hint">é¸å¡«ï¼Œä¾‹ï¼š30x20x10</div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">å‚™è¨»</label>
              <textarea 
                class="form-textarea" 
                id="note" 
                placeholder="å…¶ä»–éœ€è¦èªªæ˜çš„äº‹é …ï¼ˆé¸å¡«ï¼‰"
              ></textarea>
            </div>
          </div>

          <div class="btn-group">
            <button type="button" class="btn btn-secondary" onclick="previousStep()">â† ä¸Šä¸€æ­¥</button>
            <button type="submit" class="btn btn-primary">ä¸‹ä¸€æ­¥ â†’</button>
          </div>
        </form>
      </div>

      <!-- æ­¥é©Ÿ 3: ä»£æ”¶åŠé‹è²»è¨­å®š -->
      <div id="screen3" class="screen">
        <div class="screen-title">ğŸ’° è²»ç”¨è¨­å®š</div>

        <div id="screen3Message"></div>

        <form id="step3Form">
          <div class="form-section">
            <div class="section-title">
              <span>ğŸ’µ</span>
              <span>ä»£æ”¶é‡‘é¡ï¼ˆCODï¼‰</span>
            </div>
            <div class="form-group">
              <label class="form-label">ä»£æ”¶é‡‘é¡</label>
              <input 
                type="number" 
                class="form-input" 
                id="codAmount" 
                placeholder="0"
                min="0"
                step="1"
                value="0"
              >
              <div class="form-hint">éœ€å‘æ”¶ä»¶äººæ”¶å–çš„é‡‘é¡ï¼ˆ0 = ä¸éœ€ä»£æ”¶ï¼‰</div>
            </div>

            <div class="message info">
              <span>â„¹ï¸</span>
              <span>ä»£æ”¶é‡‘é¡ç‚º 0 æ™‚ï¼Œç³»çµ±å°‡è‡ªå‹•ç”¢ç”Ÿå–è²¨é©—è­‰ç¢¼ä»¥ä¿éšœæ‚¨çš„åŒ…è£¹å®‰å…¨</span>
            </div>
          </div>

          <div class="form-section">
            <div class="section-title">
              <span>ğŸšš</span>
              <span>é‹è²»è¨­å®š</span>
            </div>
            <div class="form-group">
              <label class="form-label">é‹è²»ä»˜æ¬¾äºº</label>
              <div class="radio-group">
                <div class="radio-option">
                  <input type="radio" name="shippingPayer" id="payerSender" value="sender" checked>
                  <label for="payerSender" class="radio-label">å¯„ä»¶äººä»˜æ¬¾</label>
                </div>
                <div class="radio-option">
                  <input type="radio" name="shippingPayer" id="payerReceiver" value="receiver">
                  <label for="payerReceiver" class="radio-label">æ”¶ä»¶äººä»˜æ¬¾</label>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">é‹è²»é‡‘é¡</label>
              <div style="padding: 12px 16px; font-size: 24px; font-weight: bold; color: var(--primary); background: var(--bg); border-radius: 8px; text-align: center;">
                NT$ 60
              </div>
              <div class="form-hint">å›ºå®šé‹è²»</div>
            </div>
          </div>

          <div class="btn-group">
            <button type="button" class="btn btn-secondary" onclick="previousStep()">â† ä¸Šä¸€æ­¥</button>
            <button type="submit" class="btn btn-primary">ä¸‹ä¸€æ­¥ â†’</button>
          </div>
        </form>
      </div>

      <!-- æ­¥é©Ÿ 4: ç¢ºèªè³‡è¨Š -->
      <div id="screen4" class="screen">
        <div class="screen-title">âœ… ç¢ºèªå¯„ä»¶è³‡è¨Š</div>

        <div id="screen4Message"></div>

        <!-- å¯„ä»¶äººè³‡è¨Š -->
        <div class="confirm-section">
          <div class="section-title">
            <span>ğŸ“¤</span>
            <span>å¯„ä»¶äºº</span>
          </div>
          <div class="confirm-row">
            <span class="confirm-label">å§“å</span>
            <span class="confirm-value" id="confirmSenderName">-</span>
          </div>
          <div class="confirm-row">
            <span class="confirm-label">é›»è©±</span>
            <span class="confirm-value" id="confirmSenderPhone">-</span>
          </div>
          <div class="confirm-row">
            <span class="confirm-label">åœ°å€</span>
            <span class="confirm-value" id="confirmSenderAddress">-</span>
          </div>
        </div>

        <!-- æ”¶ä»¶äººè³‡è¨Š -->
        <div class="confirm-section">
          <div class="section-title">
            <span>ğŸ“¥</span>
            <span>æ”¶ä»¶äºº</span>
          </div>
          <div class="confirm-row">
            <span class="confirm-label">å§“å</span>
            <span class="confirm-value" id="confirmReceiverName">-</span>
          </div>
          <div class="confirm-row">
            <span class="confirm-label">é›»è©±</span>
            <span class="confirm-value" id="confirmReceiverPhone">-</span>
          </div>
          <div class="confirm-row">
            <span class="confirm-label">åœ°å€</span>
            <span class="confirm-value" id="confirmReceiverAddress">-</span>
          </div>
        </div>

        <!-- åŒ…è£¹è³‡è¨Š -->
        <div class="confirm-section">
          <div class="section-title">
            <span>ğŸ“¦</span>
            <span>åŒ…è£¹å…§å®¹</span>
          </div>
          <div class="confirm-row">
            <span class="confirm-label">å“å</span>
            <span class="confirm-value" id="confirmItemName">-</span>
          </div>
          <div class="confirm-row">
            <span class="confirm-label">æ•¸é‡</span>
            <span class="confirm-value" id="confirmQuantity">-</span>
          </div>
          <div class="confirm-row">
            <span class="confirm-label">é‡é‡</span>
            <span class="confirm-value" id="confirmWeight">-</span>
          </div>
          <div class="confirm-row">
            <span class="confirm-label">å°ºå¯¸</span>
            <span class="confirm-value" id="confirmDimensions">-</span>
          </div>
          <div class="confirm-row">
            <span class="confirm-label">å‚™è¨»</span>
            <span class="confirm-value" id="confirmNote">-</span>
          </div>
        </div>

        <!-- è²»ç”¨è³‡è¨Š -->
        <div class="confirm-section">
          <div class="section-title">
            <span>ğŸ’°</span>
            <span>è²»ç”¨æ˜ç´°</span>
          </div>
          <div class="confirm-row">
            <span class="confirm-label">ä»£æ”¶é‡‘é¡</span>
            <span class="confirm-value highlight" id="confirmCodAmount">$0</span>
          </div>
          <div class="confirm-row">
            <span class="confirm-label">é‹è²»</span>
            <span class="confirm-value" id="confirmShippingFee">$60</span>
          </div>
          <div class="confirm-row">
            <span class="confirm-label">é‹è²»ä»˜æ¬¾äºº</span>
            <span class="confirm-value" id="confirmShippingPayer">-</span>
          </div>
        </div>

        <div class="btn-group">
          <button type="button" class="btn btn-secondary" onclick="previousStep()">â† ä¸Šä¸€æ­¥</button>
          <button type="button" class="btn btn-success" onclick="submitShipment()">
            <span>âœ“</span>
            <span>ç¢ºèªé€å‡º</span>
          </button>
        </div>
      </div>

      <!-- æ­¥é©Ÿ 5: å®Œæˆç•«é¢ -->
      <div id="screen5" class="screen">
        <div class="success-screen">
          <div class="success-icon">âœ…</div>
          <div class="screen-title">å¯„ä»¶æˆåŠŸï¼</div>

          <div class="tracking-display">
            <div class="tracking-label">æ‚¨çš„å¯„ä»¶å–®è™Ÿ</div>
            <div class="tracking-number" id="finalTrackingNo">-</div>
          </div>

          <div class="message info">
            <span>ğŸ“‹</span>
            <span>è«‹åˆ—å°å¯„ä»¶å–®ä¸¦è²¼æ–¼åŒ…è£¹ä¸Š</span>
          </div>

          <div class="btn-group">
            <button type="button" class="btn btn-primary" onclick="printShipmentLabel()">
              <span>ğŸ–¨ï¸</span>
              <span>åˆ—å°å¯„ä»¶å–®</span>
            </button>
            <button type="button" class="btn btn-success" onclick="resetKiosk()">
              <span>âœ“</span>
              <span>å®Œæˆ</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Supabase åˆå§‹åŒ–
    const { createClient } = supabase;
    const supabaseClient = createClient(CONFIG.SUPABASE.URL, CONFIG.SUPABASE.ANON_KEY);

    // å…¨åŸŸè®Šæ•¸
    let currentStep = 1;
    let shipmentData = {
      sender: {},
      receiver: {},
      package: {},
      payment: {}
    };
    let createdShipment = null;

    // åˆå§‹åŒ–
    function init() {
      // ç¶å®šè¡¨å–®æäº¤äº‹ä»¶
      document.getElementById('step1Form').addEventListener('submit', handleStep1Submit);
      document.getElementById('step2Form').addEventListener('submit', handleStep2Submit);
      document.getElementById('step3Form').addEventListener('submit', handleStep3Submit);

      console.log('ğŸš€ è‡ªåŠ©å¯„ä»¶ Kiosk ç³»çµ±å·²å•Ÿå‹•');
    }

    // æ­¥é©Ÿ 1 è¡¨å–®æäº¤
    function handleStep1Submit(e) {
      e.preventDefault();
      
      // é©—è­‰é›»è©±æ ¼å¼
      const senderPhone = document.getElementById('senderPhone').value;
      const receiverPhone = document.getElementById('receiverPhone').value;
      
      if (!/^[0-9]{10}$/.test(senderPhone)) {
        showMessage('å¯„ä»¶äººé›»è©±æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥10ç¢¼æ•¸å­—', 'error', 'screen1Message');
        return;
      }
      
      if (!/^[0-9]{10}$/.test(receiverPhone)) {
        showMessage('æ”¶ä»¶äººé›»è©±æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥10ç¢¼æ•¸å­—', 'error', 'screen1Message');
        return;
      }

      // å„²å­˜è³‡æ–™
      shipmentData.sender = {
        name: document.getElementById('senderName').value.trim(),
        phone: senderPhone,
        address: document.getElementById('senderAddress').value.trim()
      };

      shipmentData.receiver = {
        name: document.getElementById('receiverName').value.trim(),
        phone: receiverPhone,
        address: document.getElementById('receiverAddress').value.trim()
      };

      console.log('âœ… æ­¥é©Ÿ 1 å®Œæˆ', shipmentData);
      nextStep();
    }

    // æ­¥é©Ÿ 2 è¡¨å–®æäº¤
    function handleStep2Submit(e) {
      e.preventDefault();

      const itemName = document.getElementById('itemName').value.trim();
      if (!itemName) {
        showMessage('è«‹è¼¸å…¥å“å', 'error', 'screen2Message');
        return;
      }

      // å„²å­˜è³‡æ–™
      shipmentData.package = {
        itemName: itemName,
        quantity: parseInt(document.getElementById('quantity').value) || 1,
        weight: parseFloat(document.getElementById('weight').value) || null,
        dimensions: document.getElementById('dimensions').value.trim() || null,
        note: document.getElementById('note').value.trim() || null
      };

      console.log('âœ… æ­¥é©Ÿ 2 å®Œæˆ', shipmentData);
      nextStep();
    }

    // æ­¥é©Ÿ 3 è¡¨å–®æäº¤
    function handleStep3Submit(e) {
      e.preventDefault();

      const codAmount = parseFloat(document.getElementById('codAmount').value) || 0;
      const shippingFee = 60; // å›ºå®šé‹è²» 60 å…ƒ
      const shippingPayer = document.querySelector('input[name="shippingPayer"]:checked').value;

      // å„²å­˜è³‡æ–™
      shipmentData.payment = {
        codAmount: codAmount,
        shippingFee: shippingFee,
        shippingPayer: shippingPayer
      };

      console.log('âœ… æ­¥é©Ÿ 3 å®Œæˆ', shipmentData);
      
      // é¡¯ç¤ºç¢ºèªç•«é¢
      displayConfirmation();
      nextStep();
    }

    // é¡¯ç¤ºç¢ºèªè³‡è¨Š
    function displayConfirmation() {
      // å¯„ä»¶äºº
      document.getElementById('confirmSenderName').textContent = shipmentData.sender.name;
      document.getElementById('confirmSenderPhone').textContent = shipmentData.sender.phone;
      document.getElementById('confirmSenderAddress').textContent = shipmentData.sender.address;

      // æ”¶ä»¶äºº
      document.getElementById('confirmReceiverName').textContent = shipmentData.receiver.name;
      document.getElementById('confirmReceiverPhone').textContent = shipmentData.receiver.phone;
      document.getElementById('confirmReceiverAddress').textContent = shipmentData.receiver.address;

      // åŒ…è£¹
      document.getElementById('confirmItemName').textContent = shipmentData.package.itemName;
      document.getElementById('confirmQuantity').textContent = shipmentData.package.quantity + ' ä»¶';
      document.getElementById('confirmWeight').textContent = shipmentData.package.weight ? shipmentData.package.weight + ' kg' : 'æœªæä¾›';
      document.getElementById('confirmDimensions').textContent = shipmentData.package.dimensions || 'æœªæä¾›';
      document.getElementById('confirmNote').textContent = shipmentData.package.note || 'ç„¡';

      // è²»ç”¨
      document.getElementById('confirmCodAmount').textContent = '$' + shipmentData.payment.codAmount;
      document.getElementById('confirmShippingFee').textContent = '$' + shipmentData.payment.shippingFee;
      document.getElementById('confirmShippingPayer').textContent = 
        shipmentData.payment.shippingPayer === 'sender' ? 'å¯„ä»¶äººä»˜æ¬¾' : 'æ”¶ä»¶äººä»˜æ¬¾';
    }

    // é€å‡ºå¯„ä»¶è³‡æ–™
    async function submitShipment() {
      showLoading('screen4Message');

      try {
        // ç”Ÿæˆå¯„ä»¶å–®è™Ÿ
        const trackingNo = generateTrackingNumber();

        // çµ„åˆè³‡æ–™
        const shipment = {
          tracking_no: trackingNo,
          sender_name: shipmentData.sender.name,
          sender_phone: shipmentData.sender.phone,
          sender_address: shipmentData.sender.address,
          receiver_name: shipmentData.receiver.name,
          receiver_phone: shipmentData.receiver.phone,
          receiver_address: shipmentData.receiver.address,
          item_name: shipmentData.package.itemName,
          quantity: shipmentData.package.quantity,
          weight: shipmentData.package.weight,
          note: shipmentData.package.note,
          cod_amount: shipmentData.payment.codAmount,
          status: 'ç‰©æµå–®å·²å»ºç«‹'
        };

        // ğŸ” ä»£æ”¶é‡‘é¡ç‚º 0 æ™‚è‡ªå‹•ç”Ÿæˆé©—è­‰ç¢¼
        if (shipmentData.payment.codAmount === 0) {
          shipment.verification_code = generateVerificationCode();
          shipment.require_code = true;
          console.log('ğŸ” ä»£æ”¶é‡‘é¡ç‚º 0ï¼Œå·²ç”Ÿæˆå–è²¨é©—è­‰ç¢¼ï¼š', shipment.verification_code);
        } else {
          shipment.verification_code = null;
          shipment.require_code = false;
        }

        // å„²å­˜åˆ° Supabase
        const { data, error } = await supabaseClient
          .from('shipments')
          .insert([shipment])
          .select()
          .single();

        if (error) throw error;

        createdShipment = data;
        console.log('âœ… å¯„ä»¶è³‡æ–™å·²å„²å­˜ï¼š', createdShipment);

        // è¨˜éŒ„æ“ä½œæ—¥èªŒ
        await logKioskAction('shipment_created', trackingNo);

        // ç™¼é€ LINE å¯„ä»¶æ”¶æ“šçµ¦å¯„ä»¶äºº
        await sendShipmentReceipt(createdShipment);

        // ğŸ“§ ç™¼é€ Email å¯„ä»¶æ”¶æ“šçµ¦å¯„ä»¶äºº
        await sendShipmentEmailNotification(createdShipment);

        // é¡¯ç¤ºæˆåŠŸç•«é¢
        document.getElementById('finalTrackingNo').textContent = trackingNo;
        nextStep();

      } catch (error) {
        console.error('âŒ å¯„ä»¶å¤±æ•—ï¼š', error);
        showMessage('å¯„ä»¶å¤±æ•—ï¼š' + error.message, 'error', 'screen4Message');
      } finally {
        hideLoading('screen4Message');
      }
    }

    // ç™¼é€ LINE å¯„ä»¶æ”¶æ“šçµ¦å¯„ä»¶äºº
    async function sendShipmentReceipt(shipment) {
      try {
        console.log('ğŸ“¤ æº–å‚™ç™¼é€å¯„ä»¶æ”¶æ“šçµ¦:', shipment.sender_phone);

        // æŸ¥è©¢å¯„ä»¶äººçš„ LINE ç¶å®šè³‡è¨Š
        const { data: binding, error: bindingError } = await supabaseClient
          .from('line_bindings')
          .select('line_user_id, is_blocked')
          .eq('phone', shipment.sender_phone)
          .single();

        if (bindingError || !binding) {
          console.log('â„¹ï¸ å¯„ä»¶äººå°šæœªç¶å®š LINEï¼Œè·³éç™¼é€æ”¶æ“š');
          return false;
        }

        if (binding.is_blocked) {
          console.log('âš ï¸ å¯„ä»¶äººå·²å°é–å®˜æ–¹å¸³è™Ÿï¼Œè·³éç™¼é€');
          return false;
        }

        // å»ºç«‹å¯„ä»¶æ”¶æ“š Flex Message
        const receiptMessage = {
          type: "flex",
          altText: `ğŸ“¦ å¯„ä»¶æ”¶æ“š - ${shipment.tracking_no}`,
          contents: {
            type: "bubble",
            body: {
              type: "box",
              layout: "vertical",
              contents: [
                {
                  type: "text",
                  text: "SHIPMENT RECEIPT",
                  weight: "bold",
                  color: "#1DB446",
                  size: "sm"
                },
                {
                  type: "text",
                  text: CONFIG.UI.PRINT.COMPANY.NAME,
                  weight: "bold",
                  size: "xxl",
                  margin: "md"
                },
                {
                  type: "text",
                  text: "å¯„ä»¶æ”¶æ“š",
                  size: "xs",
                  color: "#aaaaaa",
                  wrap: true
                },
                {
                  type: "separator",
                  margin: "xxl"
                },
                {
                  type: "box",
                  layout: "vertical",
                  margin: "xxl",
                  spacing: "sm",
                  contents: [
                    {
                      type: "box",
                      layout: "horizontal",
                      contents: [
                        {
                          type: "text",
                          text: "å¯„ä»¶å–®è™Ÿ",
                          size: "sm",
                          color: "#555555",
                          flex: 0
                        },
                        {
                          type: "text",
                          text: shipment.tracking_no,
                          size: "sm",
                          color: "#111111",
                          align: "end",
                          weight: "bold"
                        }
                      ]
                    },
                    {
                      type: "box",
                      layout: "horizontal",
                      contents: [
                        {
                          type: "text",
                          text: "å¯„ä»¶æ™‚é–“",
                          size: "sm",
                          color: "#555555",
                          flex: 0
                        },
                        {
                          type: "text",
                          text: new Date().toLocaleString('zh-TW'),
                          size: "sm",
                          color: "#111111",
                          align: "end"
                        }
                      ]
                    },
                    {
                      type: "separator",
                      margin: "xxl"
                    },
                    {
                      type: "box",
                      layout: "horizontal",
                      margin: "xxl",
                      contents: [
                        {
                          type: "text",
                          text: "å¯„ä»¶äºº",
                          size: "sm",
                          color: "#555555"
                        },
                        {
                          type: "text",
                          text: shipment.sender_name,
                          size: "sm",
                          color: "#111111",
                          align: "end"
                        }
                      ]
                    },
                    {
                      type: "box",
                      layout: "horizontal",
                      contents: [
                        {
                          type: "text",
                          text: "å¯„ä»¶é›»è©±",
                          size: "sm",
                          color: "#555555"
                        },
                        {
                          type: "text",
                          text: shipment.sender_phone,
                          size: "sm",
                          color: "#111111",
                          align: "end"
                        }
                      ]
                    },
                    {
                      type: "separator",
                      margin: "xxl"
                    },
                    {
                      type: "box",
                      layout: "horizontal",
                      margin: "xxl",
                      contents: [
                        {
                          type: "text",
                          text: "æ”¶ä»¶äºº",
                          size: "sm",
                          color: "#555555"
                        },
                        {
                          type: "text",
                          text: shipment.receiver_name,
                          size: "sm",
                          color: "#111111",
                          align: "end"
                        }
                      ]
                    },
                    {
                      type: "box",
                      layout: "horizontal",
                      contents: [
                        {
                          type: "text",
                          text: "æ”¶ä»¶é›»è©±",
                          size: "sm",
                          color: "#555555"
                        },
                        {
                          type: "text",
                          text: shipment.receiver_phone,
                          size: "sm",
                          color: "#111111",
                          align: "end"
                        }
                      ]
                    },
                    {
                      type: "separator",
                      margin: "xxl"
                    },
                    {
                      type: "box",
                      layout: "horizontal",
                      margin: "xxl",
                      contents: [
                        {
                          type: "text",
                          text: "å“å",
                          size: "sm",
                          color: "#555555"
                        },
                        {
                          type: "text",
                          text: shipment.item_name,
                          size: "sm",
                          color: "#111111",
                          align: "end"
                        }
                      ]
                    },
                    {
                      type: "box",
                      layout: "horizontal",
                      contents: [
                        {
                          type: "text",
                          text: "æ•¸é‡",
                          size: "sm",
                          color: "#555555"
                        },
                        {
                          type: "text",
                          text: `${shipment.quantity} ä»¶`,
                          size: "sm",
                          color: "#111111",
                          align: "end"
                        }
                      ]
                    },
                    {
                      type: "box",
                      layout: "horizontal",
                      contents: [
                        {
                          type: "text",
                          text: "é‹è²»",
                          size: "sm",
                          color: "#555555"
                        },
                        {
                          type: "text",
                          text: "$60",
                          size: "sm",
                          color: "#111111",
                          align: "end"
                        }
                      ]
                    },
                    ...(shipment.cod_amount > 0 ? [{
                      type: "box",
                      layout: "horizontal",
                      contents: [
                        {
                          type: "text",
                          text: "ä»£æ”¶é‡‘é¡",
                          size: "sm",
                          color: "#555555"
                        },
                        {
                          type: "text",
                          text: `$${shipment.cod_amount}`,
                          size: "sm",
                          color: "#ff3b30",
                          align: "end",
                          weight: "bold"
                        }
                      ]
                    }] : [])
                  ]
                },
                {
                  type: "separator",
                  margin: "xxl"
                },
                {
                  type: "box",
                  layout: "horizontal",
                  margin: "md",
                  contents: [
                    {
                      type: "text",
                      text: "STATUS",
                      size: "xs",
                      color: "#aaaaaa",
                      flex: 0
                    },
                    {
                      type: "text",
                      text: shipment.status,
                      color: "#aaaaaa",
                      size: "xs",
                      align: "end"
                    }
                  ]
                }
              ]
            },
            styles: {
              footer: {
                separator: true
              }
            }
          }
        };

        // å‘¼å« Supabase RPC ç™¼é€æ”¶æ“š
        const { data, error } = await supabaseClient.rpc('send_line_notification', {
          p_line_user_id: binding.line_user_id,
          p_message: receiptMessage
        });

        if (error) {
          console.error('âŒ ç™¼é€ LINE å¯„ä»¶æ”¶æ“šå¤±æ•—ï¼š', error);
          return false;
        }

        console.log('âœ… LINE å¯„ä»¶æ”¶æ“šå·²ç™¼é€');

        // è¨˜éŒ„é€šçŸ¥
        await supabaseClient.from('line_notifications').insert({
          line_user_id: binding.line_user_id,
          phone: shipment.sender_phone,
          notification_type: 'shipment_receipt',
          shipment_id: shipment.id,
          tracking_no: shipment.tracking_no,
          message_content: `å¯„ä»¶æ”¶æ“š - ${shipment.tracking_no}`,
          flex_message: receiptMessage,
          status: 'sent'
        });

        return true;

      } catch (error) {
        console.error('âŒ ç™¼é€ LINE å¯„ä»¶æ”¶æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', error);
        // ä¸é˜»æ“‹å¯„ä»¶æµç¨‹
        return false;
      }
    }

    // ğŸ“§ ç™¼é€ Email å¯„ä»¶é€šçŸ¥çµ¦å¯„ä»¶äºº
    async function sendShipmentEmailNotification(shipment) {
      try {
        console.log('ğŸ“§ æº–å‚™ç™¼é€ Email å¯„ä»¶é€šçŸ¥çµ¦:', shipment.sender_phone);

        // æª¢æŸ¥ EmailNotify æ˜¯å¦å¯ç”¨
        if (typeof EmailNotify === 'undefined') {
          console.warn('âš ï¸ EmailNotify æ¨¡çµ„æœªè¼‰å…¥ï¼Œè·³éç™¼é€');
          return false;
        }

        // æŸ¥è©¢å¯„ä»¶äººçš„ Email
        const senderEmail = await EmailNotify.getEmailByPhone(shipment.sender_phone);

        if (!senderEmail) {
          console.log('â„¹ï¸ å¯„ä»¶äººå°šæœªç¶å®š Emailï¼Œè·³éç™¼é€');
          return false;
        }

        // ç™¼é€ Email
        const result = await EmailNotify.sendShipmentCreatedEmail({
          id: shipment.id,
          tracking_no: shipment.tracking_no,
          sender_name: shipment.sender_name,
          sender_phone: shipment.sender_phone,
          receiver_name: shipment.receiver_name,
          receiver_phone: shipment.receiver_phone,
          item_name: shipment.item_name,
          quantity: shipment.quantity,
          shipping_fee: shipmentData.payment.shippingFee || 60,
          created_at: shipment.created_at
        }, senderEmail);

        if (result.success) {
          console.log('âœ… Email å¯„ä»¶é€šçŸ¥å·²ç™¼é€');
          return true;
        } else {
          console.warn('âš ï¸ Email ç™¼é€å¤±æ•—ï¼ˆä¸å½±éŸ¿å¯„ä»¶æµç¨‹ï¼‰:', result.error);
          return false;
        }

      } catch (error) {
        console.error('âŒ ç™¼é€ Email æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼ˆä¸å½±éŸ¿å¯„ä»¶æµç¨‹ï¼‰:', error);
        return false;
      }
    }

    // åˆ—å°å¯„ä»¶å–®
    function printShipmentLabel() {
      if (!createdShipment) {
        alert('æ²’æœ‰å¯åˆ—å°çš„å¯„ä»¶å–®');
        return;
      }

      const printContent = generatePrintContent(createdShipment);
      const printWindow = window.open('', '_blank', 'width=400,height=600');
      printWindow.document.write(printContent);
      printWindow.document.close();
      
      setTimeout(() => {
        printWindow.print();
      }, 500);

      console.log('ğŸ–¨ï¸ é–‹å§‹åˆ—å°å¯„ä»¶å–®');
    }

    // ç”Ÿæˆåˆ—å°å…§å®¹ï¼ˆè¤‡è£½è‡ª index.html çš„é‚è¼¯ï¼‰
    function generatePrintContent(shipment) {
      const companyName = CONFIG.UI.PRINT.COMPANY.NAME;
      const companyAddress = CONFIG.UI.PRINT.COMPANY.ADDRESS;
      const companyPhone = CONFIG.UI.PRINT.COMPANY.PHONE;
      
      return `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>å¯„ä»¶å–® - ${shipment.tracking_no}</title>
          <style>
            @page {
              size: 88mm 140mm;
              margin: 0;
            }
            * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
            }
            body {
              font-family: "Arial", "Microsoft JhengHei", sans-serif;
              color: #000;
              background: #fff;
            }
            .label {
              width: 88mm;
              height: 140mm;
              padding: 2mm;
              border: 2px solid #000;
            }
            
            .header {
              text-align: center;
              font-size: 11pt;
              font-weight: bold;
              padding: 1.5mm 0;
              border-bottom: 1px solid #000;
            }
            
            .info-box {
              border: 1px solid #000;
              margin: 1.5mm 0;
              font-size: 7pt;
              line-height: 1.3;
            }
            .info-title {
              background: #000;
              color: #fff;
              padding: 1mm 2mm;
              font-weight: bold;
            }
            .info-content {
              padding: 1.5mm 2mm;
            }
            
            .main-section {
              border: 1px solid #000;
              margin: 1.5mm 0;
              text-align: center;
            }
            .main-content {
              display: flex;
              padding: 2mm;
              min-height: 35mm;
            }
            .left-part {
              flex: 1;
              display: flex;
              flex-direction: column;
              justify-content: center;
              align-items: center;
            }
            .tracking-no {
              font-size: 16pt;
              font-weight: bold;
              margin: 3mm 0 2mm 0;
              letter-spacing: 1px;
            }
            .qr-box {
              width: 28mm;
              height: 28mm;
              border: 1px solid #000;
              display: flex;
              align-items: center;
              justify-content: center;
              flex-shrink: 0;
            }
            
            .pickup-section {
              border: 1px solid #000;
              margin: 1.5mm 0;
            }
            .pickup-title {
              background: #000;
              color: #fff;
              text-align: center;
              padding: 2mm;
              font-size: 12pt;
              font-weight: bold;
            }
            .pickup-body {
              display: flex;
              min-height: 25mm;
            }
            .pickup-left {
              width: 35%;
              border-right: 1px solid #000;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 8pt;
              padding: 2mm;
              text-align: center;
            }
            .pickup-right {
              flex: 1;
              display: flex;
              flex-direction: column;
              justify-content: center;
              align-items: center;
              padding: 2mm;
            }
            .addr {
              font-size: 9pt;
              margin-bottom: 1mm;
            }
            .name {
              font-size: 18pt;
              font-weight: bold;
              margin: 1mm 0;
            }
            .code {
              font-size: 32pt;
              font-weight: bold;
              font-family: "Consolas", monospace;
            }
            
            .barcode-section {
              border: 1px solid #000;
              text-align: center;
              padding: 2mm;
              margin: 1.5mm 0;
              overflow: hidden;
            }
            .barcode {
              margin: 1mm 0;
              display: flex;
              justify-content: center;
              align-items: center;
            }
            .barcode svg {
              max-width: 100%;
              height: auto;
            }
            .barcode-text {
              font-size: 7pt;
              letter-spacing: 0.5px;
              margin-top: 0.5mm;
            }
            
            .footer {
              text-align: center;
              font-size: 8pt;
              color: #0066ff;
              margin-top: 1mm;
            }

            .cod-badge {
              background: #ff3b30;
              color: white;
              padding: 2mm;
              font-size: 14pt;
              font-weight: bold;
              margin: 1mm 0;
            }
          </style>
        </head>
        <body>
          <div class="label">
            <div class="header">${companyName} å¯„ä»¶å–®</div>

            <!-- å¯„ä»¶è³‡è¨Š -->
            <div class="info-box">
              <div class="info-title">å¯„ä»¶è³‡è¨Š</div>
              <div class="info-content">
                å¯„ä»¶äººï¼š${shipment.sender_name}<br>
                é›»è©±ï¼š${shipment.sender_phone}<br>
                åœ°å€ï¼š${shipment.sender_address}<br>
                è²¨ç‰©ï¼š${shipment.item_name} Ã— ${shipment.quantity}<br>
                ${shipment.cod_amount && shipment.cod_amount > 0 ? `ä»£æ”¶ï¼š$${shipment.cod_amount}<br>` : ''}åˆ—å°ï¼š${new Date().toLocaleString('zh-TW')}
              </div>
            </div>

            <!-- ä¸»è¦ç‰©æµå€ -->
            <div class="main-section">
              <div class="main-content">
                <div class="left-part">
                  <div class="tracking-no">${shipment.tracking_no}</div>
                  <div class="short-no">${shipment.weight ? (shipment.weight + 'kg') : 'å¾…æ¸¬'}</div>
                </div>
                <div class="qr-box">
                  <div id="qrcode"></div>
                </div>
              </div>
            </div>

            <!-- å–ä»¶å€ -->
            <div class="pickup-section">
              <div class="pickup-title">å–ã€€ä»¶</div>
              <div class="pickup-body">
                <div class="pickup-left">è«‹æ ¸å°<br>æœ«ä¸‰ç¢¼</div>
                <div class="pickup-right">
                  <div class="addr">${shipment.receiver_address}</div>
                  <div class="name">${shipment.receiver_name}</div>
                  <div class="code">${shipment.receiver_phone.slice(-3)}</div>
                </div>
              </div>
            </div>

            <!-- å–ä»¶å°ˆç”¨æ¢ç¢¼ -->
            <div class="barcode-section">
              <div class="barcode" id="barcode"></div>
              <div class="barcode-text">${shipment.tracking_no}</div>
            </div>

            ${shipment.verification_code ? `
            <!-- éœ€è¦é©—è­‰ç¢¼æç¤º -->
            <div style="border: 2px solid #ff9500; border-radius: 2mm; padding: 3mm; margin: 1.5mm 0; background: #fff8e6; text-align: center;">
              <div style="font-size: 9pt; font-weight: bold; color: #ff9500; margin-bottom: 1mm;">âš ï¸ å–ä»¶éœ€è¦é©—è­‰ç¢¼</div>
              <div style="font-size: 8pt; color: #666; line-height: 1.4;">
                æ­¤åŒ…è£¹å–ä»¶æ™‚éœ€è¦è¼¸å…¥é©—è­‰ç¢¼<br>
                é©—è­‰ç¢¼å·²é€éç°¡è¨Š/é€šçŸ¥å‚³é€çµ¦æ”¶ä»¶äºº
              </div>
            </div>
            ` : ''}

            <div class="footer">${companyPhone}</div>
          </div>

          <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>
          <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"><\/script>
          <script>
            // ç”Ÿæˆ QR Code å’Œæ¢ç¢¼
            window.onload = function() {
              // ç”Ÿæˆ QR Code
              var qrcode = new QRCode(document.getElementById("qrcode"), {
                text: "${shipment.tracking_no}",
                width: 90,
                height: 90,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.M
              });
              
              // ç”Ÿæˆæ¢ç¢¼
              var barcodeElement = document.getElementById("barcode");
              var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
              barcodeElement.appendChild(svg);
              
              JsBarcode(svg, "${shipment.tracking_no}", {
                format: "CODE128",
                width: 1.2,
                height: 35,
                displayValue: false,
                margin: 2
              });
              
              // ç­‰å¾…ç”Ÿæˆå¾Œå†åˆ—å°
              setTimeout(function() {
                window.print();
              }, 600);
            };
          <\/script>
        </body>
        </html>
      `;
    }

    // ç”Ÿæˆå¯„ä»¶å–®è™Ÿ
    function generateTrackingNumber() {
      const date = new Date();
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const random = Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
      return `${year}${month}${day}-${random}`;
    }

    // ç”Ÿæˆé©—è­‰ç¢¼ï¼ˆ6ä½æ•¸å­—ï¼‰
    function generateVerificationCode() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }

    // ä¸‹ä¸€æ­¥
    function nextStep() {
      if (currentStep >= 5) return;
      
      // ç§»é™¤ç•¶å‰æ­¥é©Ÿçš„ active
      document.getElementById(`screen${currentStep}`).classList.remove('active');
      
      // åªæœ‰æ­¥é©Ÿ 1-4 æœ‰æ­¥é©ŸæŒ‡ç¤ºå™¨
      const stepItem = document.getElementById(`stepItem${currentStep}`);
      if (stepItem) {
        stepItem.classList.remove('active');
        stepItem.classList.add('completed');
      }
      
      // é€²å…¥ä¸‹ä¸€æ­¥
      currentStep++;
      document.getElementById(`screen${currentStep}`).classList.add('active');
      
      // åªæœ‰æ­¥é©Ÿ 1-4 æœ‰æ­¥é©ŸæŒ‡ç¤ºå™¨
      const nextStepItem = document.getElementById(`stepItem${currentStep}`);
      if (nextStepItem) {
        nextStepItem.classList.add('active');
      }
      
      // æ²å‹•åˆ°é ‚éƒ¨
      window.scrollTo(0, 0);
    }

    // ä¸Šä¸€æ­¥
    function previousStep() {
      if (currentStep <= 1) return;
      
      // ç§»é™¤ç•¶å‰æ­¥é©Ÿçš„ active
      document.getElementById(`screen${currentStep}`).classList.remove('active');
      document.getElementById(`stepItem${currentStep}`).classList.remove('active');
      
      // è¿”å›ä¸Šä¸€æ­¥
      currentStep--;
      document.getElementById(`screen${currentStep}`).classList.add('active');
      document.getElementById(`stepItem${currentStep}`).classList.remove('completed');
      document.getElementById(`stepItem${currentStep}`).classList.add('active');
      
      // æ²å‹•åˆ°é ‚éƒ¨
      window.scrollTo(0, 0);
    }

    // é‡ç½® Kiosk
    function resetKiosk() {
      if (currentStep > 1 && currentStep < 5) {
        if (!confirm('ç¢ºå®šè¦å–æ¶ˆä¸¦é‡æ–°é–‹å§‹å—ï¼Ÿ')) {
          return;
        }
      }

      // é‡ç½®æ‰€æœ‰è®Šæ•¸
      currentStep = 1;
      shipmentData = {
        sender: {},
        receiver: {},
        package: {},
        payment: {}
      };
      createdShipment = null;

      // é‡ç½®æ‰€æœ‰è¡¨å–®
      document.getElementById('step1Form').reset();
      document.getElementById('step2Form').reset();
      document.getElementById('step3Form').reset();

      // é‡ç½®æ­¥é©ŸæŒ‡ç¤ºå™¨
      for (let i = 1; i <= 5; i++) {
        document.getElementById(`screen${i}`).classList.remove('active');
        document.getElementById(`stepItem${i}`).classList.remove('active', 'completed');
      }

      // é¡¯ç¤ºç¬¬ä¸€æ­¥
      document.getElementById('screen1').classList.add('active');
      document.getElementById('stepItem1').classList.add('active');

      // æ¸…é™¤æ‰€æœ‰è¨Šæ¯
      ['screen1Message', 'screen2Message', 'screen3Message', 'screen4Message'].forEach(id => {
        document.getElementById(id).innerHTML = '';
      });

      // æ²å‹•åˆ°é ‚éƒ¨
      window.scrollTo(0, 0);

      console.log('ğŸ”„ ç³»çµ±å·²é‡ç½®');
    }

    // è¨˜éŒ„ Kiosk æ“ä½œ
    async function logKioskAction(action, trackingNo) {
      try {
        // å˜—è©¦è¨˜éŒ„æ—¥èªŒï¼Œä½†ä¸å½±éŸ¿ä¸»æµç¨‹
        await supabaseClient
          .from('kiosk_logs')
          .insert({
            action,
            tracking_no: trackingNo,
            device_id: navigator.userAgent,
            details: {
              timestamp: new Date().toISOString(),
              screen_resolution: `${window.screen.width}x${window.screen.height}`,
              user_agent: navigator.userAgent
            }
          });
        console.log('âœ… æ—¥èªŒå·²è¨˜éŒ„ï¼š', action);
      } catch (error) {
        // æ—¥èªŒè¨˜éŒ„å¤±æ•—ä¸å½±éŸ¿ä¸»åŠŸèƒ½
        console.warn('âš ï¸ è¨˜éŒ„æ—¥èªŒå¤±æ•—ï¼ˆä¸å½±éŸ¿åŠŸèƒ½ï¼‰ï¼š', error.message);
      }
    }

    // é¡¯ç¤ºè¨Šæ¯
    function showMessage(text, type, targetId) {
      const target = document.getElementById(targetId);
      target.innerHTML = `
        <div class="message ${type}">
          <span>${type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸'}</span>
          <span>${text}</span>
        </div>
      `;
      
      setTimeout(() => {
        target.innerHTML = '';
      }, 5000);
    }

    // é¡¯ç¤º Loading
    function showLoading(targetId) {
      const target = document.getElementById(targetId);
      target.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <div>è™•ç†ä¸­...</div>
        </div>
      `;
    }

    // éš±è— Loading
    function hideLoading(targetId) {
      const target = document.getElementById(targetId);
      target.innerHTML = '';
    }

    // åˆå§‹åŒ–
    init();
  </script>
</body>
</html>

