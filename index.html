<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è²¨ç‰©ç®¡ç†ç³»çµ±</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="config.js"></script>
  <script src="config-loader.js"></script>
  <script src="line-notify-helper.js"></script>
  <style>
    /* -------------------------
       è˜‹æœé¢¨æ ¼ UI è¨­è¨ˆç³»çµ±
       - ä½¿ç”¨ç³»çµ±å­—é«”ã€æŸ”å’Œé™°å½±ã€åœ“è§’è¨­è¨ˆ
       - éŸ¿æ‡‰å¼ä½ˆå±€ï¼Œæ”¯æ´æ‰‹æ©Ÿå’Œæ¡Œé¢
       - åˆ—å°æ¨£å¼å„ªåŒ–
    -------------------------*/
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #0a84ff;
      --danger: #ff3b30;
      --success: #28c76f;
      --warning: #ff9500;
      --border: #e6e9ef;
      --shadow: 0 8px 20px rgba(12, 20, 40, 0.04);
      --shadow-hover: 0 12px 24px rgba(12, 20, 40, 0.08);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Helvetica Neue", Arial;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: #0b1320;
      line-height: 1.5;
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
    }

    /* ç™»å…¥é é¢æ¨£å¼ */
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #b0b0b0 0%, #343434 100%);
    }

    .login-card {
      background: var(--card);
      padding: 40px;
      border-radius: 20px;
      box-shadow: var(--shadow-hover);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .login-logo {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, var(--accent), #5ac8fa);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      box-shadow: 0 8px 24px rgba(10, 132, 255, 0.3);
    }

    .login-title {
      font-size: 28px;
      font-weight: 700;
      margin: 0 0 8px;
      color: #1d1d1f;
    }

    .login-subtitle {
      color: var(--muted);
      margin-bottom: 32px;
    }

    /* ä¸»æ‡‰ç”¨æ¨£å¼ */
    .main-app {
      display: none;
    }

    .main-app.active {
      display: block;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 24px;
      padding: 16px 0;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, var(--accent), #5ac8fa);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 18px rgba(10, 132, 255, 0.2);
    }

    .brand-text h1 {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
      color: #1d1d1f;
    }

    .brand-text .subtitle {
      font-size: 14px;
      color: var(--muted);
      margin-top: 4px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      background: var(--accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .search-box {
      position: relative;
      min-width: 280px;
    }

    .search-box input {
      width: 100%;
      padding: 12px 16px 12px 44px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 14px;
      background: var(--card);
      transition: all 0.2s ease;
    }

    .search-box input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.1);
    }

    .search-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
      width: 16px;
      height: 16px;
    }

    button, .btn {
      border: none;
      background: var(--accent);
      color: white;
      padding: 12px 20px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(10, 132, 255, 0.2);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    button:hover, .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(10, 132, 255, 0.3);
    }

    .btn.ghost {
      background: transparent;
      color: var(--accent);
      box-shadow: none;
      border: 1px solid rgba(10, 132, 255, 0.2);
    }

    .btn.ghost:hover {
      background: rgba(10, 132, 255, 0.05);
    }

    .btn.warn {
      background: var(--danger);
      box-shadow: 0 4px 12px rgba(255, 59, 48, 0.2);
    }

    .btn.warn:hover {
      box-shadow: 0 6px 16px rgba(255, 59, 48, 0.3);
    }

    .btn.success {
      background: var(--success);
      box-shadow: 0 4px 12px rgba(40, 199, 111, 0.2);
    }

    .main {
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 24px;
    }

    .card {
      background: var(--card);
      padding: 24px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .card h3 {
      margin: 0 0 20px;
      font-size: 20px;
      font-weight: 700;
      color: #1d1d1f;
    }

    /* è¡¨å–®æ¨£å¼ */
    .form-section {
      margin-bottom: 24px;
    }

    .form-section h4 {
      margin: 0 0 16px;
      font-size: 16px;
      font-weight: 600;
      color: #1d1d1f;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    .form-row {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
    }

    .form-group {
      flex: 1;
    }

    .form-group.small {
      width: 140px;
      flex: none;
    }

    .form-group.medium {
      width: 200px;
      flex: none;
    }

    label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #1d1d1f;
      margin-bottom: 8px;
    }

    input, textarea, select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 14px;
      background: var(--card);
      transition: all 0.2s ease;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    /* ç‹€æ…‹æ¨™ç±¤ */
    .status-pill {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-ç‰©æµå–®å·²å»ºç«‹ { background: #eef6ff; color: #0366d6; }
    .status-åŒ…è£¹é›¢åº—ä½œæ¥­ä¸­ { background: #fff8e6; color: #b86b00; }
    .status-åŒ…è£¹æŠµé”ç†è²¨ä¸­å¿ƒï¼Œè™•ç†ä¸­ { background: #e8f7ee; color: #1a8f3d; }
    .status-åŒ…è£¹å·²é…é”å–ä»¶é–€å¸‚ { background: #f0f4ff; color: #2b6be6; }
    .status-å–ä»¶æˆåŠŸ { background: #eefcf3; color: #0f9d58; }
    .status-é€€å› { background: #ffecee; color: #d93025; }

    /* è¡¨æ ¼æ¨£å¼ */
    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    th {
      background: #f8f9fa;
      padding: 16px;
      text-align: left;
      font-weight: 600;
      color: #1d1d1f;
      border-bottom: 1px solid var(--border);
    }

    td {
      padding: 16px;
      border-bottom: 1px solid #f2f4f8;
      vertical-align: top;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-small {
      padding: 8px 12px;
      font-size: 12px;
      border-radius: 8px;
    }

    /* è©³æƒ…é é¢ */
    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    .detail-info h2 {
      margin: 0 0 8px;
      font-size: 24px;
      font-weight: 700;
      color: #1d1d1f;
    }

    .detail-meta {
      color: var(--muted);
      font-size: 14px;
    }

    .detail-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .info-section {
      margin-bottom: 24px;
    }

    .info-section h4 {
      margin: 0 0 12px;
      font-size: 16px;
      font-weight: 600;
      color: #1d1d1f;
    }

    .info-content {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.6;
    }

    .history-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .history-item {
      padding: 12px 0;
      border-bottom: 1px solid #f2f4f8;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-time {
      color: var(--muted);
      font-size: 12px;
    }

    /* è¼‰å…¥ç‹€æ…‹ */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--muted);
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top: 2px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 12px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ç©ºç‹€æ…‹ */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }

    .empty-icon {
      width: 64px;
      height: 64px;
      background: #f8f9fa;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      color: var(--muted);
    }

    /* åˆ—å°æ¨£å¼ */
    @media print {
      body * { visibility: hidden; }
      #print-area, #print-area * { visibility: visible; }
      #print-area { position: fixed; left: 0; top: 0; width: 100%; }
    }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 1024px) {
      .main { grid-template-columns: 1fr; }
      .controls { flex-wrap: wrap; }
      .search-box { min-width: 200px; }
    }

    @media (max-width: 768px) {
      .app { padding: 16px; }
      .card { padding: 16px; }
      .form-row { flex-direction: column; }
      .form-group.small, .form-group.medium { width: 100%; }
      .detail-header { flex-direction: column; gap: 16px; }
      .detail-actions { width: 100%; }
    }

    /* éš±è—å…ƒç´  */
    .hidden { display: none !important; }

    /* ç”¨æˆ¶é¸å–®ä¸‹æ‹‰ */
    .user-menu-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: var(--card);
      border-radius: 12px;
      box-shadow: var(--shadow-hover);
      min-width: 200px;
      z-index: 1000;
      border: 1px solid var(--border);
      display: none;
    }

    .user-menu-dropdown.show {
      display: block;
      animation: fadeInDown 0.2s ease;
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .user-menu-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s ease;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
    }

    .user-menu-item:last-child {
      border-bottom: none;
    }

    .user-menu-item:hover {
      background: var(--bg);
    }

    .user-menu-item:first-child {
      border-radius: 12px 12px 0 0;
    }

    .user-menu-item:last-child {
      border-radius: 0 0 12px 12px;
    }

    .user-menu-icon {
      width: 20px;
      text-align: center;
    }

    .user-info {
      position: relative;
    }

     /* æˆåŠŸ/éŒ¯èª¤è¨Šæ¯ */
     .message {
       padding: 12px 16px;
       border-radius: 12px;
       margin-bottom: 16px;
       font-size: 14px;
       font-weight: 500;
     }

     .message.success {
       background: #e8f7ee;
       color: #1a8f3d;
       border: 1px solid #c3e6cb;
     }

     .message.error {
       background: #ffecee;
       color: #d93025;
       border: 1px solid #f5c6cb;
     }

     /* å°è©±æ¡†æ¨£å¼ */
     .modal-overlay {
       display: none;
       position: fixed;
       top: 0;
       left: 0;
       right: 0;
       bottom: 0;
       background: rgba(0, 0, 0, 0.5);
       z-index: 9999;
       align-items: center;
       justify-content: center;
     }

     .modal-overlay.show {
       display: flex;
       animation: fadeIn 0.3s ease;
     }

     @keyframes fadeIn {
       from { opacity: 0; }
       to { opacity: 1; }
     }

     .modal-dialog {
       background: var(--card);
       border-radius: 16px;
       box-shadow: var(--shadow-hover);
       max-width: 500px;
       width: 90%;
       max-height: 80vh;
       overflow-y: auto;
       animation: slideUp 0.3s ease;
     }

     @keyframes slideUp {
       from {
         opacity: 0;
         transform: translateY(20px);
       }
       to {
         opacity: 1;
         transform: translateY(0);
       }
     }

     .modal-header {
       padding: 24px;
       border-bottom: 1px solid var(--border);
       display: flex;
       justify-content: space-between;
       align-items: center;
     }

     .modal-title {
       font-size: 20px;
       font-weight: 700;
       margin: 0;
     }

     .modal-close {
       background: transparent;
       border: none;
       font-size: 24px;
       cursor: pointer;
       color: var(--muted);
       padding: 0;
       width: 32px;
       height: 32px;
       border-radius: 8px;
       display: flex;
       align-items: center;
       justify-content: center;
       transition: all 0.2s;
       box-shadow: none;
     }

     .modal-close:hover {
       background: var(--bg);
       color: #1d1d1f;
       transform: none;
     }

     .modal-body {
       padding: 24px;
     }

     .modal-footer {
       padding: 16px 24px;
       border-top: 1px solid var(--border);
       display: flex;
       justify-content: flex-end;
       gap: 12px;
     }

     .form-section-modal {
       margin-bottom: 20px;
     }

     .form-section-modal:last-child {
       margin-bottom: 0;
     }

     .form-section-modal h4 {
       margin: 0 0 12px;
       font-size: 14px;
       font-weight: 600;
       color: var(--muted);
       text-transform: uppercase;
       letter-spacing: 0.5px;
     }
  </style>
</head>
<body>
  <!-- ç™»å…¥é é¢ -->
  <div id="loginPage" class="login-container">
    <div class="login-card">
      <div class="login-logo">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="2" y="6" width="20" height="12" rx="2" fill="white" opacity="0.9"/>
          <path d="M4 10h16M4 14h10" stroke="white" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
      </div>
      <h1 class="login-title">è²¨ç‰©ç®¡ç†ç³»çµ±</h1>
      <p class="login-subtitle">è«‹ç™»å…¥ä»¥ä½¿ç”¨ç³»çµ±</p>
      
      <form id="loginForm">
        <div class="form-group">
          <label for="email">é›»å­éƒµä»¶</label>
          <input type="email" id="email" required placeholder="è«‹è¼¸å…¥æ‚¨çš„é›»å­éƒµä»¶">
        </div>
        <div class="form-group">
          <label for="password">å¯†ç¢¼</label>
          <input type="password" id="password" required placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
        </div>
        <button type="submit" style="width: 100%; margin-top: 8px;">ç™»å…¥</button>
      </form>
      
      <div id="loginMessage" class="message hidden"></div>
    </div>
  </div>

  <!-- ä¸»æ‡‰ç”¨ç¨‹å¼ -->
  <div id="mainApp" class="main-app">
    <div class="app">
      <header>
        <div class="brand">
          <div class="logo">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="2" y="6" width="20" height="12" rx="2" fill="white" opacity="0.9"/>
              <path d="M4 10h16M4 14h10" stroke="white" stroke-width="1.6" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="brand-text">
            <h1>è²¨ç‰©ç®¡ç†</h1>
            <div class="subtitle">è²¨ç‰©ç®¡ç†ç³»çµ±</div>
          </div>
        </div>

        <div class="controls">
          <div class="search-box">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input id="searchInput" placeholder="æœå°‹ï¼šå–®è™Ÿã€å¯„ä»¶äººã€æ”¶ä»¶äºº..." />
          </div>
          <button id="newShipmentBtn">æ–°å¢è²¨ä»¶</button>
          <button id="exportBtn" class="btn ghost">åŒ¯å‡ºè³‡æ–™</button>
          <label class="btn ghost">
            åŒ¯å…¥è³‡æ–™
            <input id="importFile" type="file" accept=".json" style="display:none"/>
          </label>
          <button id="posBtn" class="btn success">ğŸ›’ å–ä»¶çµå¸³</button>
          <div class="user-info">
            <div class="user-avatar" id="userAvatar">U</div>
            <div>
              <div id="userEmail"></div>
              <div id="userRole" style="font-size: 12px; color: var(--muted);"></div>
            </div>
            <button id="userMenuBtn" class="btn ghost btn-small">é¸å–®</button>
            <button id="logoutBtn" class="btn ghost btn-small">ç™»å‡º</button>
            
             <!-- ç”¨æˆ¶é¸å–®ä¸‹æ‹‰ -->
             <div id="userMenuDropdown" class="user-menu-dropdown">
          <div class="user-menu-item" onclick="navigateTo('pages/customer/shpsearch.html')">
            <span class="user-menu-icon">ğŸ”</span>
            <span>åŒ…è£¹æŸ¥è©¢</span>
          </div>
          <div class="user-menu-item" onclick="navigateTo('pages/admin/sales.html')">
            <span class="user-menu-icon">ğŸ›’</span>
            <span>å–ä»¶çµå¸³ç³»çµ±</span>
          </div>
          <div class="user-menu-item" onclick="navigateTo('pages/customer/checkin.html')">
            <span class="user-menu-icon">ğŸ·ï¸</span>
            <span>è‡ªåŠ©å ±åˆ° Kiosk</span>
          </div>
          <div class="user-menu-item" onclick="navigateTo('pages/admin/counter.html')">
            <span class="user-menu-icon">ğŸ””</span>
            <span>æ«ƒæª¯å«è™Ÿç®¡ç†</span>
          </div>
          <div class="user-menu-item" onclick="navigateTo('pages/customer/display.html')">
            <span class="user-menu-icon">ğŸ–¥ï¸</span>
            <span>å…¬æ’­é¡¯ç¤ºç•«é¢</span>
          </div>
          <div class="user-menu-item" onclick="showAccountSettings()">
                 <span class="user-menu-icon">ğŸ‘¤</span>
                 <span>å¸³è™Ÿè¨­å®š</span>
               </div>
               <div class="user-menu-item" onclick="showHelp()">
                 <span class="user-menu-icon">â“</span>
                 <span>ä½¿ç”¨èªªæ˜</span>
               </div>
               <div class="user-menu-item" onclick="showAbout()">
                 <span class="user-menu-icon">â„¹ï¸</span>
                 <span>é—œæ–¼ç³»çµ±</span>
               </div>
             </div>
          </div>
        </div>
      </header>

      <div class="main">
        <!-- å·¦å´ï¼šè¡¨å–®/åˆ—è¡¨ -->
        <div class="card">
          <!-- æ–°å¢/ç·¨è¼¯è¡¨å–® -->
          <div id="formContainer" class="hidden">
            <h3 id="formTitle">æ–°å¢è²¨ä»¶</h3>
            <form id="shipmentForm">
              <div class="form-section">
                <h4>å¯„ä»¶äººè³‡æ–™</h4>
                <div class="form-row">
                  <div class="form-group">
                    <label for="senderName">å§“å *</label>
                    <input type="text" id="senderName" name="sender_name" required />
                  </div>
                  <div class="form-group small">
                    <label for="senderPhone">é›»è©±</label>
                    <input type="tel" id="senderPhone" name="sender_phone" />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="senderAddress">åœ°å€</label>
                    <input type="text" id="senderAddress" name="sender_address" />
                  </div>
                </div>
              </div>

              <div class="form-section">
                <h4>æ”¶ä»¶äººè³‡æ–™</h4>
                <div class="form-row">
                  <div class="form-group">
                    <label for="receiverName">å§“å *</label>
                    <input type="text" id="receiverName" name="receiver_name" required />
                  </div>
                  <div class="form-group small">
                    <label for="receiverPhone">é›»è©±</label>
                    <input type="tel" id="receiverPhone" name="receiver_phone" />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="receiverAddress">åœ°å€</label>
                    <input type="text" id="receiverAddress" name="receiver_address" />
                  </div>
                </div>
              </div>

              <div class="form-section">
                <h4>è²¨ç‰©è³‡è¨Š</h4>
                <div class="form-row">
                  <div class="form-group">
                    <label for="itemName">è²¨ç‰©æè¿°</label>
                    <input type="text" id="itemName" name="item_name" />
                  </div>
                  <div class="form-group small">
                    <label for="quantity">æ•¸é‡</label>
                    <input type="number" id="quantity" name="quantity" min="1" value="1" />
                  </div>
                  <div class="form-group small">
                    <label for="weight">é‡é‡(kg)</label>
                    <input type="number" id="weight" name="weight" step="0.1" />
                  </div>
                  <div class="form-group small">
                    <label for="codAmount">ä»£æ”¶é‡‘é¡($)</label>
                    <input type="number" id="codAmount" name="cod_amount" min="0" step="1" value="0" placeholder="0" />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="notes">å‚™è¨»</label>
                    <textarea id="notes" name="note" placeholder="å…¶ä»–æ³¨æ„äº‹é …..."></textarea>
                  </div>
                  <div class="form-group small">
                    <label for="status">ç‹€æ…‹</label>
                    <select id="status" name="status">
                      <option value="ç‰©æµå–®å·²å»ºç«‹">ç‰©æµå–®å·²å»ºç«‹</option>
                      <option value="åŒ…è£¹é›¢åº—ä½œæ¥­ä¸­">åŒ…è£¹é›¢åº—ä½œæ¥­ä¸­</option>
                      <option value="åŒ…è£¹æŠµé”ç†è²¨ä¸­å¿ƒï¼Œè™•ç†ä¸­">åŒ…è£¹æŠµé”ç†è²¨ä¸­å¿ƒï¼Œè™•ç†ä¸­</option>
                      <option value="åŒ…è£¹å·²é…é”å–ä»¶é–€å¸‚">åŒ…è£¹å·²é…é”å–ä»¶é–€å¸‚</option>
                      <option value="å–ä»¶æˆåŠŸ">å–ä»¶æˆåŠŸ</option>
                      <option value="é€€å›">é€€å›</option>
                    </select>
                  </div>
                </div>
              </div>

              <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button type="submit" id="saveBtn">å„²å­˜</button>
                <button type="button" id="cancelBtn" class="btn ghost">å–æ¶ˆ</button>
              </div>
            </form>
          </div>

          <!-- è²¨ä»¶åˆ—è¡¨ -->
          <div id="listContainer">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3>è²¨ä»¶æ¸…å–®</h3>
              <div style="color: var(--muted); font-size: 14px;">
                ç¸½æ•¸ï¼š<span id="totalCount">0</span>
              </div>
            </div>
            
            <div id="listContent">
              <div class="loading">
                <div class="spinner"></div>
                è¼‰å…¥ä¸­...
              </div>
            </div>
          </div>
        </div>

        <!-- å³å´ï¼šè©³æƒ…è¦–åœ– -->
        <div class="card">
          <div id="detailEmpty" class="empty-state">
            <div class="empty-icon">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="6" width="20" height="12" rx="2"></rect>
                <path d="M4 10h16M4 14h10"></path>
              </svg>
            </div>
            <h3>é¸æ“‡è²¨ä»¶</h3>
            <p>è«‹å¾å·¦å´åˆ—è¡¨é¸æ“‡ä¸€ç­†è²¨ä»¶æŸ¥çœ‹è©³æƒ…</p>
          </div>

          <div id="detailContent" class="hidden">
            <div class="detail-header">
              <div class="detail-info">
                <h2 id="detailId">è²¨ä»¶å–®è™Ÿ</h2>
                <div class="detail-meta">
                  å»ºç«‹æ™‚é–“ï¼š<span id="detailCreated"></span>
                </div>
              </div>
              <div class="detail-actions">
                <span id="detailStatus" class="status-pill">ç‹€æ…‹</span>
                <button id="nextStatusBtn" class="btn success btn-small">ä¸‹ä¸€æ­¥</button>
                <button id="printLabelBtn" class="btn btn-small">åˆ—å°å¯„ä»¶å–®</button>
                <button id="printReceiptBtn" class="btn ghost btn-small">åˆ—å°æ”¶æ“š</button>
              </div>
            </div>

            <div class="info-section">
              <h4>å¯„ä»¶äºº</h4>
              <div class="info-content" id="senderInfo"></div>
            </div>

            <div class="info-section">
              <h4>æ”¶ä»¶äºº</h4>
              <div class="info-content" id="receiverInfo"></div>
            </div>

            <div class="info-section">
              <h4>è²¨ç‰©è³‡è¨Š</h4>
              <div class="info-content" id="parcelInfo"></div>
            </div>

            <div class="info-section">
              <h4>è™•ç†æ­·å²</h4>
              <ul class="history-list" id="historyList"></ul>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
              <button id="editBtn" class="btn ghost">ç·¨è¼¯</button>
              <button id="deleteBtn" class="btn warn">åˆªé™¤</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- åˆ—å°å€åŸŸ -->
  <div id="printArea" class="hidden">
    <!-- åˆ—å°å…§å®¹å°‡å‹•æ…‹ç”Ÿæˆ -->
  </div>

  <!-- å¸³è™Ÿè¨­å®šå°è©±æ¡† -->
  <div id="accountSettingsModal" class="modal-overlay">
    <div class="modal-dialog">
      <div class="modal-header">
        <h3 class="modal-title">ğŸ‘¤ å¸³è™Ÿè¨­å®š</h3>
        <button class="modal-close" onclick="closeAccountSettings()">Ã—</button>
      </div>
      <div class="modal-body">
        <div id="accountMessage" class="message hidden"></div>
        
        <!-- å€‹äººè³‡æ–™ -->
        <div class="form-section-modal">
          <h4>å€‹äººè³‡æ–™</h4>
          <div class="form-group">
            <label for="accountName">å§“å</label>
            <input type="text" id="accountName" placeholder="è«‹è¼¸å…¥å§“å">
          </div>
          <div class="form-group">
            <label for="accountEmail">é›»å­éƒµä»¶</label>
            <input type="email" id="accountEmail" disabled style="background: var(--bg); cursor: not-allowed;">
          </div>
          <div class="form-group">
            <label for="accountRole">è§’è‰²</label>
            <input type="text" id="accountRole" disabled style="background: var(--bg); cursor: not-allowed;">
          </div>
        </div>

        <!-- ä¿®æ”¹å¯†ç¢¼ -->
        <div class="form-section-modal">
          <h4>ä¿®æ”¹å¯†ç¢¼</h4>
          <div class="form-group">
            <label for="currentPassword">ç›®å‰å¯†ç¢¼</label>
            <input type="password" id="currentPassword" placeholder="è«‹è¼¸å…¥ç›®å‰å¯†ç¢¼">
          </div>
          <div class="form-group">
            <label for="newPassword">æ–°å¯†ç¢¼</label>
            <input type="password" id="newPassword" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼ï¼ˆè‡³å°‘ 6 å€‹å­—å…ƒï¼‰">
          </div>
          <div class="form-group">
            <label for="confirmPassword">ç¢ºèªæ–°å¯†ç¢¼</label>
            <input type="password" id="confirmPassword" placeholder="è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn ghost" onclick="closeAccountSettings()">å–æ¶ˆ</button>
        <button class="btn" onclick="saveAccountSettings()">å„²å­˜è®Šæ›´</button>
      </div>
    </div>
  </div>

  <script>
    // ä½¿ç”¨é…ç½®æª”æ¡ˆ
    const SUPABASE_URL = CONFIG.SUPABASE.URL;
    const SUPABASE_ANON_KEY = CONFIG.SUPABASE.ANON_KEY;

    // åˆå§‹åŒ– Supabase å®¢æˆ¶ç«¯
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // å…¨åŸŸè®Šæ•¸
    let currentUser = null;
    let shipments = [];
    let selectedShipmentId = null;
    let isEditMode = false;

    // DOM å…ƒç´ 
    const loginPage = document.getElementById('loginPage');
    const mainApp = document.getElementById('mainApp');
    const loginForm = document.getElementById('loginForm');
    const loginMessage = document.getElementById('loginMessage');
    const userEmail = document.getElementById('userEmail');
    const userRole = document.getElementById('userRole');
    const userAvatar = document.getElementById('userAvatar');
    const userMenuBtn = document.getElementById('userMenuBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    // è¡¨å–®å…ƒç´ 
    const formContainer = document.getElementById('formContainer');
    const listContainer = document.getElementById('listContainer');
    const formTitle = document.getElementById('formTitle');
    const shipmentForm = document.getElementById('shipmentForm');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    // åˆ—è¡¨å…ƒç´ 
    const listContent = document.getElementById('listContent');
    const totalCount = document.getElementById('totalCount');
    const searchInput = document.getElementById('searchInput');

    // è©³æƒ…å…ƒç´ 
    const detailEmpty = document.getElementById('detailEmpty');
    const detailContent = document.getElementById('detailContent');
    const detailId = document.getElementById('detailId');
    const detailCreated = document.getElementById('detailCreated');
    const detailStatus = document.getElementById('detailStatus');
    const senderInfo = document.getElementById('senderInfo');
    const receiverInfo = document.getElementById('receiverInfo');
    const parcelInfo = document.getElementById('parcelInfo');
    const historyList = document.getElementById('historyList');

    // æŒ‰éˆ•å…ƒç´ 
    const newShipmentBtn = document.getElementById('newShipmentBtn');
    const nextStatusBtn = document.getElementById('nextStatusBtn');
    const printLabelBtn = document.getElementById('printLabelBtn');
    const printReceiptBtn = document.getElementById('printReceiptBtn');
    const editBtn = document.getElementById('editBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const exportBtn = document.getElementById('exportBtn');
    const importFile = document.getElementById('importFile');
    const posBtn = document.getElementById('posBtn');

    // å·¥å…·å‡½æ•¸
    function showMessage(message, type = 'success') {
      loginMessage.textContent = message;
      loginMessage.className = `message ${type}`;
      loginMessage.classList.remove('hidden');
      setTimeout(() => {
        loginMessage.classList.add('hidden');
      }, 3000);
    }

    function generateTrackingNumber() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const time = String(now.getTime()).slice(-6);
      return `${year}${month}${day}-${time}`;
    }

    // ç”Ÿæˆ 6 ä½æ•¸å–è²¨é©—è­‰ç¢¼
    function generateVerificationCode() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateString) {
      return new Date(dateString).toLocaleString('zh-TW');
    }

    // èªè­‰ç›¸é—œå‡½æ•¸
    async function signIn(email, password) {
      try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email,
          password
        });
        
        if (error) throw error;
        
        currentUser = data.user;
        showMessage(CONFIG.MESSAGES.SUCCESS.LOGIN, 'success');
        setTimeout(() => {
          showMainApp();
        }, 1000);
      } catch (error) {
        showMessage(CONFIG.MESSAGES.ERROR.LOGIN + 'ï¼š' + error.message, 'error');
      }
    }


    async function signOut() {
      try {
        const { error } = await supabaseClient.auth.signOut();
        if (error) throw error;
        
        currentUser = null;
        showLoginPage();
      } catch (error) {
        console.error('ç™»å‡ºéŒ¯èª¤ï¼š', error);
      }
    }

    function showLoginPage() {
      loginPage.style.display = 'flex';
      mainApp.classList.remove('active');
    }

    async function loadUserInfo() {
      if (currentUser) {
        try {
          const { data, error } = await supabaseClient
            .from('users')
            .select('name, role, email')
            .eq('id', currentUser.id)
            .single();

          if (data) {
            userEmail.textContent = data.email;
            userRole.textContent = data.role === 'admin' ? 'ç®¡ç†å“¡' : 
                                 data.role === 'staff' ? 'å“¡å·¥' : 'ä¸€èˆ¬ç”¨æˆ¶';
            userAvatar.textContent = (data.name || data.email).charAt(0).toUpperCase();
          } else {
            userEmail.textContent = currentUser.email;
            userRole.textContent = 'ç”¨æˆ¶';
            userAvatar.textContent = currentUser.email.charAt(0).toUpperCase();
          }
        } catch (error) {
          console.warn('è¼‰å…¥ç”¨æˆ¶è³‡è¨Šå¤±æ•—ï¼š', error);
          userEmail.textContent = currentUser.email;
          userRole.textContent = 'ç”¨æˆ¶';
          userAvatar.textContent = currentUser.email.charAt(0).toUpperCase();
        }
      }
    }

    function showMainApp() {
      loginPage.style.display = 'none';
      mainApp.classList.add('active');
      loadUserInfo();
      loadShipments();
    }

    // è²¨ä»¶ç®¡ç†å‡½æ•¸
    async function loadShipments() {
      try {
        listContent.innerHTML = '<div class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­...</div>';
        
        const { data, error } = await supabaseClient
          .from('shipments')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        shipments = data || [];
        renderShipmentList();
        updateTotalCount();
      } catch (error) {
        console.error('è¼‰å…¥è²¨ä»¶å¤±æ•—ï¼š', error);
        listContent.innerHTML = '<div class="empty-state"><div class="empty-icon">âš ï¸</div><h3>è¼‰å…¥å¤±æ•—</h3><p>ç„¡æ³•è¼‰å…¥è²¨ä»¶è³‡æ–™</p></div>';
      }
    }

    function renderShipmentList(filterText = '') {
      const filtered = shipments.filter(shipment => {
        if (!filterText) return true;
        const text = filterText.toLowerCase();
        return (
          shipment.tracking_no?.toLowerCase().includes(text) ||
          shipment.receiver_name?.toLowerCase().includes(text) ||
          shipment.sender_name?.toLowerCase().includes(text)
        );
      });

      if (filtered.length === 0) {
        listContent.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“¦</div><h3>æ²’æœ‰è²¨ä»¶</h3><p>ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è²¨ä»¶</p></div>';
        return;
      }

      const table = document.createElement('div');
      table.className = 'table-container';
      table.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>å–®è™Ÿ</th>
              <th>æ”¶ä»¶äºº</th>
              <th>è²¨ç‰©</th>
              <th>ç‹€æ…‹</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.map(shipment => `
              <tr>
                <td>
                  <div style="font-weight: 600;">${escapeHtml(shipment.tracking_no || '')}</div>
                  <div style="font-size: 12px; color: var(--muted);">${formatDate(shipment.created_at)}</div>
                </td>
                <td>
                  <div>${escapeHtml(shipment.receiver_name || '')}</div>
                  <div style="font-size: 12px; color: var(--muted);">${escapeHtml(shipment.receiver_phone || '')}</div>
                </td>
                <td>
                  <div>${escapeHtml(shipment.item_name || '')}</div>
                  <div style="font-size: 12px; color: var(--muted);">æ•¸é‡ï¼š${shipment.quantity || 1}</div>
                </td>
                <td><span class="status-pill status-${shipment.status?.replace(/\s+/g, '').replace(/ï¼Œ/g, '') || 'ç‰©æµå–®å·²å»ºç«‹'}">${shipment.status || 'ç‰©æµå–®å·²å»ºç«‹'}</span></td>
                <td>
                  <div class="actions">
                    <button class="btn btn-small" onclick="selectShipment(${shipment.id})">æŸ¥çœ‹</button>
                    <button class="btn ghost btn-small" onclick="advanceStatus(${shipment.id})">ä¸‹ä¸€æ­¥</button>
                    <button class="btn ghost btn-small" onclick="printShipment(${shipment.id})">åˆ—å°</button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      listContent.innerHTML = '';
      listContent.appendChild(table);
    }

    function updateTotalCount() {
      totalCount.textContent = shipments.length;
    }

    async function selectShipment(shipmentId) {
      selectedShipmentId = shipmentId;
      const shipment = shipments.find(s => s.id === shipmentId);
      if (shipment) {
        await renderShipmentDetail(shipment);
      }
    }

    async function renderShipmentDetail(shipment) {
      detailEmpty.classList.add('hidden');
      detailContent.classList.remove('hidden');

      detailId.textContent = shipment.tracking_no || 'ç„¡å–®è™Ÿ';
      detailCreated.textContent = formatDate(shipment.created_at);
      detailStatus.textContent = shipment.status || 'ç‰©æµå–®å·²å»ºç«‹';
      detailStatus.className = `status-pill status-${(shipment.status || 'ç‰©æµå–®å·²å»ºç«‹').replace(/\s+/g, '').replace(/ï¼Œ/g, '')}`;

      senderInfo.innerHTML = `
        <div><strong>${escapeHtml(shipment.sender_name || '')}</strong></div>
        <div style="color: var(--muted); margin-top: 4px;">
          ${escapeHtml(shipment.sender_phone || '')} ${escapeHtml(shipment.sender_address || '')}
        </div>
      `;

      receiverInfo.innerHTML = `
        <div><strong>${escapeHtml(shipment.receiver_name || '')}</strong></div>
        <div style="color: var(--muted); margin-top: 4px;">
          ${escapeHtml(shipment.receiver_phone || '')} ${escapeHtml(shipment.receiver_address || '')}
        </div>
      `;

      parcelInfo.innerHTML = `
        <div><strong>${escapeHtml(shipment.item_name || '')}</strong></div>
        <div style="color: var(--muted); margin-top: 4px;">
          æ•¸é‡ï¼š${shipment.quantity || 1} | é‡é‡ï¼š${shipment.weight || 'æœªè¨­å®š'}kg | ä»£æ”¶ï¼š$${shipment.cod_amount || 0}
        </div>
        ${shipment.verification_code ? `
        <div style="background: #e6f3ff; padding: 12px; border-radius: 8px; margin-top: 8px; border: 1px solid #0a84ff;">
          <strong style="color: #0a84ff;">ğŸ” å–è²¨é©—è­‰ç¢¼ï¼š</strong>
          <span style="font-family: 'Courier New', monospace; font-size: 20px; font-weight: bold; color: #0a84ff; letter-spacing: 2px;">${shipment.verification_code}</span>
          <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">è‡ªåŠ©å ±åˆ°æ™‚éœ€è¦è¼¸å…¥æ­¤é©—è­‰ç¢¼</div>
        </div>
        ` : ''}
        <div style="color: var(--muted); margin-top: 4px;">
          å‚™è¨»ï¼š${escapeHtml(shipment.note || 'ç„¡')}
        </div>
      `;

      // è¼‰å…¥å®Œæ•´çš„æ­·å²è¨˜éŒ„
      await loadShipmentHistory(shipment.id);
    }

    async function loadShipmentHistory(shipmentId) {
      try {
        // å¾ logs è¡¨ä¸­è®€å–æ­¤è²¨ä»¶çš„æ‰€æœ‰è®Šæ›´è¨˜éŒ„
        const { data: logs, error } = await supabaseClient
          .from('logs')
          .select('*')
          .eq('target_table', 'shipments')
          .eq('target_id', shipmentId.toString())
          .order('created_at', { ascending: true });

        if (error) {
          console.error('è®€å–æ­·å²è¨˜éŒ„å¤±æ•—ï¼š', error);
          // å¦‚æœè®€å–å¤±æ•—ï¼Œé¡¯ç¤ºç°¡åŒ–çš„æ­·å²
          const shipment = shipments.find(s => s.id === shipmentId);
          historyList.innerHTML = `
            <li class="history-item">
              <span>å»ºç«‹è²¨ä»¶</span>
              <span class="history-time">${formatDate(shipment.created_at)}</span>
            </li>
          `;
          return;
        }

        // æ§‹å»ºæ­·å²è¨˜éŒ„ HTML
        if (!logs || logs.length === 0) {
          const shipment = shipments.find(s => s.id === shipmentId);
          historyList.innerHTML = `
            <li class="history-item">
              <span>å»ºç«‹è²¨ä»¶</span>
              <span class="history-time">${formatDate(shipment.created_at)}</span>
            </li>
          `;
        } else {
          historyList.innerHTML = logs.map(log => {
            let actionText = '';
            if (log.action === 'shipment_created') {
              actionText = 'å»ºç«‹è²¨ä»¶';
            } else if (log.action === 'status_updated') {
              const details = log.details || {};
              actionText = `ç‹€æ…‹æ›´æ–°ï¼š${details.old_status || ''} â†’ ${details.new_status || ''}`;
            } else if (log.action === 'shipment_deleted') {
              actionText = 'åˆªé™¤è²¨ä»¶';
            } else {
              actionText = log.action;
            }

            return `
              <li class="history-item">
                <span>${escapeHtml(actionText)}</span>
                <span class="history-time">${formatDate(log.created_at)}</span>
              </li>
            `;
          }).join('');
        }
      } catch (error) {
        console.error('è¼‰å…¥æ­·å²è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', error);
      }
    }

    async function saveShipment(formData) {
      try {
        const codAmount = parseFloat(formData.cod_amount) || 0;
        
        const shipmentData = {
          tracking_no: formData.tracking_no || generateTrackingNumber(),
          sender_name: formData.sender_name,
          sender_phone: formData.sender_phone,
          sender_address: formData.sender_address,
          receiver_name: formData.receiver_name,
          receiver_phone: formData.receiver_phone,
          receiver_address: formData.receiver_address,
          item_name: formData.item_name,
          quantity: parseInt(formData.quantity) || 1,
          weight: parseFloat(formData.weight) || null,
          cod_amount: codAmount,
          note: formData.note,
          status: formData.status || 'ç‰©æµå–®å·²å»ºç«‹',
          created_by: currentUser.id
        };

        // ğŸ” å®‰å…¨æ©Ÿåˆ¶ï¼šä»£æ”¶é‡‘é¡ç‚º 0 æ™‚è‡ªå‹•ç”Ÿæˆå–è²¨é©—è­‰ç¢¼
        if (codAmount === 0) {
          shipmentData.verification_code = generateVerificationCode();
          shipmentData.require_code = true;
          console.log('ğŸ« ä»£æ”¶é‡‘é¡ç‚º 0ï¼Œå·²ç”Ÿæˆå–è²¨é©—è­‰ç¢¼ï¼š', shipmentData.verification_code);
        } else {
          shipmentData.verification_code = null;
          shipmentData.require_code = false;
          console.log('ğŸ’° ä»£æ”¶é‡‘é¡ç‚º $' + codAmount + 'ï¼Œä¸éœ€è¦é©—è­‰ç¢¼');
        }

        let result;
        if (isEditMode && selectedShipmentId) {
          // æ›´æ–°ç¾æœ‰è²¨ä»¶
          const { data, error } = await supabaseClient
            .from('shipments')
            .update({
              ...shipmentData,
              updated_at: new Date().toISOString()
            })
            .eq('id', selectedShipmentId)
            .select();

          if (error) throw error;
          result = data[0];
        } else {
          // æ–°å¢è²¨ä»¶
          const { data, error } = await supabaseClient
            .from('shipments')
            .insert([shipmentData])
            .select();

          if (error) throw error;
          result = data[0];
        }

        // é‡æ–°è¼‰å…¥è³‡æ–™
        await loadShipments();
        
        // é¸æ“‡æ–°å»ºç«‹çš„è²¨ä»¶
        if (!isEditMode) {
          selectShipment(result.id);
        }

        hideForm();
        
        // âš ï¸ ä¸åœ¨å»ºç«‹æ™‚ç™¼é€é©—è­‰ç¢¼ï¼Œæ”¹ç‚ºåœ¨ã€Œå¾…å–ä»¶ã€æ™‚ç™¼é€
        // é©—è­‰ç¢¼å°‡åœ¨åŒ…è£¹åˆ°åº—æ™‚ä¸€ä½µç™¼é€
        
        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
        let successMsg = isEditMode ? 'è²¨ä»¶æ›´æ–°æˆåŠŸï¼' : 'è²¨ä»¶å»ºç«‹æˆåŠŸï¼';
        if (result.verification_code) {
          successMsg += ` âš ï¸ æ­¤åŒ…è£¹éœ€è¦é©—è­‰ç¢¼å–ä»¶ï¼Œè«‹é€éç°¡è¨Šæˆ–å…¶ä»–æ–¹å¼å°‡é©—è­‰ç¢¼å‚³é€çµ¦æ”¶ä»¶äººã€‚`;
        }
        showMessage(successMsg, 'success');
      } catch (error) {
        console.error('å„²å­˜è²¨ä»¶å¤±æ•—ï¼š', error);
        showMessage('å„²å­˜å¤±æ•—ï¼š' + error.message, 'error');
      }
    }

    async function advanceStatus(shipmentId) {
      try {
        const shipment = shipments.find(s => s.id === shipmentId);
        if (!shipment) return;

        const statusFlow = CONFIG.APP.STATUS_FLOW;
        const currentIndex = statusFlow.indexOf(shipment.status);
        const nextStatus = currentIndex < statusFlow.length - 1 ? statusFlow[currentIndex + 1] : shipment.status;

        if (nextStatus === shipment.status) {
          showMessage(CONFIG.MESSAGES.ERROR.VALIDATION, 'error');
          return;
        }

        const { data, error } = await supabaseClient
          .from('shipments')
          .update({ 
            status: nextStatus,
            updated_at: new Date().toISOString()
          })
          .eq('id', shipmentId)
          .select('*, verification_code, require_code');

        if (error) throw error;

        // ğŸ”” ç™¼é€ LINE åˆ°åº—é€šçŸ¥ï¼ˆå¦‚æœç‹€æ…‹æ˜¯ã€ŒåŒ…è£¹å·²é…é”å–ä»¶é–€å¸‚ã€ä¸”å°šæœªé€šçŸ¥ï¼‰
        if (CONFIG.FEATURES.LINE_OA && CONFIG.LINE.MESSAGING.NOTIFY_ON_ARRIVAL && 
            nextStatus === 'åŒ…è£¹å·²é…é”å–ä»¶é–€å¸‚' && data && data[0]) {
          const updatedShipment = data[0];
          
          // Debug: æª¢æŸ¥è²¨ä»¶è³‡æ–™
          console.log('ğŸ“¦ æº–å‚™ç™¼é€ LINE é€šçŸ¥ï¼Œè²¨ä»¶è³‡æ–™ï¼š', {
            tracking_no: updatedShipment.tracking_no,
            receiver_phone: updatedShipment.receiver_phone,
            require_code: updatedShipment.require_code,
            verification_code: updatedShipment.verification_code ? '***æœ‰é©—è­‰ç¢¼***' : 'ç„¡',
            cod_amount: updatedShipment.cod_amount
          });
          
          if (!updatedShipment.line_notified) {
            window.LINENotify.notifyArrival(
              updatedShipment.receiver_phone,
              updatedShipment
            ).then(sent => {
              if (sent) {
                console.log('âœ… LINE åˆ°åº—é€šçŸ¥å·²ç™¼é€');
                showMessage('å·²æ›´æ–°ç‹€æ…‹ä¸¦ç™¼é€ LINE é€šçŸ¥', 'success');
              }
            });
          }
        }

        await loadShipments();
        if (selectedShipmentId === shipmentId) {
          selectShipment(shipmentId);
        }
        showMessage(CONFIG.MESSAGES.SUCCESS.UPDATE, 'success');
      } catch (error) {
        console.error('æ›´æ–°ç‹€æ…‹å¤±æ•—ï¼š', error);
        showMessage('æ›´æ–°å¤±æ•—ï¼š' + error.message, 'error');
      }
    }

    async function deleteShipment(shipmentId) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è²¨ä»¶å—ï¼Ÿæ­¤æ“ä½œå°‡åŒæ™‚åˆªé™¤ç›¸é—œçš„å ±åˆ°è¨˜éŒ„å’Œå–ä»¶è¨˜éŒ„ã€‚')) return;

      console.log('ğŸ—‘ï¸ é–‹å§‹åˆªé™¤è²¨ä»¶ï¼š', shipmentId);

      try {
        // å…ˆç²å–è²¨ä»¶è³‡è¨Š
        console.log('ğŸ“‹ 1. ç²å–è²¨ä»¶è³‡è¨Š...');
        const { data: shipment, error: fetchError } = await supabaseClient
          .from('shipments')
          .select('tracking_no')
          .eq('id', shipmentId)
          .single();

        if (fetchError) {
          console.error('âŒ ç²å–è²¨ä»¶å¤±æ•—ï¼š', fetchError);
          throw fetchError;
        }
        if (!shipment) {
          throw new Error('æ‰¾ä¸åˆ°æ­¤è²¨ä»¶');
        }
        console.log('âœ… æ‰¾åˆ°è²¨ä»¶ï¼š', shipment.tracking_no);

        // 1. å…ˆåˆªé™¤ call_historyï¼ˆé€é checkin_recordsï¼‰
        console.log('ğŸ” 2. æŸ¥æ‰¾ç›¸é—œå ±åˆ°è¨˜éŒ„...');
        const { data: checkins } = await supabaseClient
          .from('checkin_records')
          .select('id')
          .eq('shipment_id', shipmentId);

        if (checkins && checkins.length > 0) {
          console.log(`ğŸ“ 3. åˆªé™¤ ${checkins.length} å€‹å ±åˆ°è¨˜éŒ„çš„å«è™Ÿæ­·å²...`);
          const checkinIds = checkins.map(c => c.id);
          
          const { error: callHistoryError } = await supabaseClient
            .from('call_history')
            .delete()
            .in('checkin_id', checkinIds);

          if (callHistoryError) {
            console.error('âŒ åˆªé™¤å«è™Ÿæ­·å²å¤±æ•—ï¼š', callHistoryError);
          } else {
            console.log('âœ… å«è™Ÿæ­·å²å·²åˆªé™¤');
          }
        } else {
          console.log('â„¹ï¸ ç„¡ç›¸é—œå ±åˆ°è¨˜éŒ„');
        }

        // 2. åˆªé™¤å ±åˆ°è¨˜éŒ„
        console.log('ğŸ·ï¸ 4. åˆªé™¤å ±åˆ°è¨˜éŒ„...');
        const { error: checkinError } = await supabaseClient
          .from('checkin_records')
          .delete()
          .eq('shipment_id', shipmentId);

        if (checkinError) {
          console.error('âŒ åˆªé™¤å ±åˆ°è¨˜éŒ„å¤±æ•—ï¼š', checkinError);
        } else {
          console.log('âœ… å ±åˆ°è¨˜éŒ„å·²åˆªé™¤');
        }

        // 3. åˆªé™¤å–ä»¶äº¤æ˜“è¨˜éŒ„ï¼ˆä½¿ç”¨ tracking_noï¼‰
        console.log('ğŸ’° 5. åˆªé™¤å–ä»¶äº¤æ˜“è¨˜éŒ„...');
        const { error: transactionError } = await supabaseClient
          .from('pickup_transactions')
          .delete()
          .eq('tracking_no', shipment.tracking_no);

        if (transactionError) {
          console.error('âŒ åˆªé™¤å–ä»¶è¨˜éŒ„å¤±æ•—ï¼š', transactionError);
        } else {
          console.log('âœ… å–ä»¶è¨˜éŒ„å·²åˆªé™¤');
        }

        // 4. åˆªé™¤æ—¥èªŒè¨˜éŒ„ï¼ˆå„ªå…ˆä½¿ç”¨ shipment_idï¼Œå¦‚æœä¸å­˜åœ¨å‰‡ç”¨ tracking_noï¼‰
        console.log('ğŸ“ 6. åˆªé™¤æ—¥èªŒè¨˜éŒ„...');
        let logsDeleted = false;
        
        // å…ˆå˜—è©¦ä½¿ç”¨ shipment_id
        const { error: logsError1 } = await supabaseClient
          .from('logs')
          .delete()
          .eq('shipment_id', shipmentId);

        if (logsError1) {
          if (logsError1.code === '42703') {
            // shipment_id æ¬„ä½ä¸å­˜åœ¨ï¼Œä½¿ç”¨ tracking_no
            console.log('âš ï¸ logs è¡¨ç„¡ shipment_id æ¬„ä½ï¼Œæ”¹ç”¨ tracking_no');
            const { error: logsError2 } = await supabaseClient
              .from('logs')
              .delete()
              .eq('tracking_no', shipment.tracking_no);
            
            if (logsError2) {
              console.error('âŒ ä½¿ç”¨ tracking_no åˆªé™¤æ—¥èªŒå¤±æ•—ï¼š', logsError2);
            } else {
              logsDeleted = true;
            }
          } else {
            console.error('âŒ åˆªé™¤æ—¥èªŒè¨˜éŒ„å¤±æ•—ï¼š', logsError1);
          }
        } else {
          logsDeleted = true;
        }
        
        if (logsDeleted) {
          console.log('âœ… æ—¥èªŒè¨˜éŒ„å·²åˆªé™¤');
        }

        // 5. æœ€å¾Œåˆªé™¤è²¨ä»¶æœ¬èº«
        console.log('ğŸ“¦ 7. åˆªé™¤è²¨ä»¶æœ¬èº«...');
        const { error: deleteError } = await supabaseClient
          .from('shipments')
          .delete()
          .eq('id', shipmentId);

        if (deleteError) {
          console.error('âŒ åˆªé™¤è²¨ä»¶å¤±æ•—ï¼š', deleteError);
          throw deleteError;
        }
        
        console.log('âœ… è²¨ä»¶å·²åˆªé™¤');
        console.log('ğŸ‰ åˆªé™¤æµç¨‹å®Œæˆï¼');

        await loadShipments();
        if (selectedShipmentId === shipmentId) {
          selectedShipmentId = null;
          showEmptyDetail();
        }
        showMessage('è²¨ä»¶åŠç›¸é—œè¨˜éŒ„åˆªé™¤æˆåŠŸï¼', 'success');
      } catch (error) {
        console.error('åˆªé™¤è²¨ä»¶å¤±æ•—ï¼š', error);
        showMessage('åˆªé™¤å¤±æ•—ï¼š' + error.message, 'error');
      }
    }

    // è¡¨å–®ç›¸é—œå‡½æ•¸
    function showForm(editMode = false) {
      isEditMode = editMode;
      formContainer.classList.remove('hidden');
      listContainer.classList.add('hidden');
      
      if (editMode) {
        formTitle.textContent = 'ç·¨è¼¯è²¨ä»¶';
        fillFormWithShipmentData();
      } else {
        formTitle.textContent = 'æ–°å¢è²¨ä»¶';
        clearForm();
      }
    }

    function hideForm() {
      formContainer.classList.add('hidden');
      listContainer.classList.remove('hidden');
      isEditMode = false;
    }

    function clearForm() {
      shipmentForm.reset();
      document.getElementById('quantity').value = 1;
    }

    function fillFormWithShipmentData() {
      const shipment = shipments.find(s => s.id === selectedShipmentId);
      if (!shipment) return;

      document.getElementById('senderName').value = shipment.sender_name || '';
      document.getElementById('senderPhone').value = shipment.sender_phone || '';
      document.getElementById('senderAddress').value = shipment.sender_address || '';
      document.getElementById('receiverName').value = shipment.receiver_name || '';
      document.getElementById('receiverPhone').value = shipment.receiver_phone || '';
      document.getElementById('receiverAddress').value = shipment.receiver_address || '';
      document.getElementById('itemName').value = shipment.item_name || '';
      document.getElementById('quantity').value = shipment.quantity || 1;
      document.getElementById('weight').value = shipment.weight || '';
      document.getElementById('codAmount').value = shipment.cod_amount || 0;
      document.getElementById('notes').value = shipment.note || '';
      document.getElementById('status').value = shipment.status || 'ç‰©æµå–®å·²å»ºç«‹';
    }

    function showEmptyDetail() {
      detailEmpty.classList.remove('hidden');
      detailContent.classList.add('hidden');
    }

    // åˆ—å°åŠŸèƒ½
    function printShipment(shipmentId) {
      const shipment = shipments.find(s => s.id === shipmentId);
      if (!shipment) return;

      const printContent = generatePrintContent(shipment, 'label');
      const printWindow = window.open('', '_blank', 'width=400,height=600');
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.focus();
    }

    function generatePrintContent(shipment, type) {
      const companyName = CONFIG.UI.PRINT.COMPANY.NAME;
      const companyLogo = CONFIG.UI.PRINT.COMPANY.LOGO;
      const companyAddress = CONFIG.UI.PRINT.COMPANY.ADDRESS;
      const companyPhone = CONFIG.UI.PRINT.COMPANY.PHONE;
      
      const content = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>${type === 'receipt' ? 'å–è²¨æ”¶æ“š' : 'å¯„ä»¶å–®'}</title>
          <style>
            @page {
              size: 88mm 140mm;
              margin: 0;
            }
            * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
            }
            body {
              font-family: "Arial", "Microsoft JhengHei", sans-serif;
              color: #000;
              background: #fff;
            }
            .label {
              width: 88mm;
              height: 140mm;
              padding: 2mm;
              border: 2px solid #000;
            }
            
            /* è¡¨é ­ */
            .header {
              text-align: center;
              font-size: 11pt;
              font-weight: bold;
              padding: 1.5mm 0;
              border-bottom: 1px solid #000;
            }
            
            /* å¯„ä»¶è³‡è¨Š */
            .info-box {
              border: 1px solid #000;
              margin: 1.5mm 0;
              font-size: 7pt;
              line-height: 1.3;
            }
            .info-title {
              background: #000;
              color: #fff;
              padding: 1mm 2mm;
              font-weight: bold;
            }
            .info-content {
              padding: 1.5mm 2mm;
            }
            
            /* ä¸»è¦ç‰©æµå€ */
            .main-section {
              border: 1px solid #000;
              margin: 1.5mm 0;
              text-align: center;
            }
            .main-content {
              display: flex;
              padding: 2mm;
              min-height: 35mm;
            }
            .left-part {
              flex: 1;
              display: flex;
              flex-direction: column;
              justify-content: center;
              align-items: center;
            }
            .hash {
              font-size: 48pt;
              font-weight: bold;
              line-height: 1;
              color: #666;
            }
            .tracking-no {
              font-size: 16pt;
              font-weight: bold;
              margin: 3mm 0 2mm 0;
              letter-spacing: 1px;
            }
            .short-no {
              font-size: 16pt;
              font-weight: bold;
              color: #000;
              margin-top: 2mm;
            }
            .qr-box {
              width: 28mm;
              height: 28mm;
              border: 1px solid #000;
              display: flex;
              align-items: center;
              justify-content: center;
              flex-shrink: 0;
            }
            
            /* å–ä»¶å€ */
            .pickup-section {
              border: 1px solid #000;
              margin: 1.5mm 0;
            }
            .pickup-title {
              background: #000;
              color: #fff;
              text-align: center;
              padding: 2mm;
              font-size: 12pt;
              font-weight: bold;
              letter-spacing: 8mm;
            }
            .pickup-body {
              display: flex;
              min-height: 25mm;
            }
            .pickup-left {
              width: 35%;
              border-right: 1px solid #000;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 8pt;
              padding: 2mm;
              text-align: center;
            }
            .pickup-right {
              flex: 1;
              display: flex;
              flex-direction: column;
              justify-content: center;
              align-items: center;
              padding: 2mm;
            }
            .addr {
              font-size: 9pt;
              margin-bottom: 1mm;
            }
            .name {
              font-size: 18pt;
              font-weight: bold;
              margin: 1mm 0;
            }
            .code {
              font-size: 32pt;
              font-weight: bold;
              font-family: "Consolas", monospace;
            }
            
            /* å–ä»¶å°ˆç”¨å€ */
            .barcode-section {
              border: 1px solid #000;
              text-align: center;
              padding: 2mm;
              margin: 1.5mm 0;
              overflow: hidden;
            }
            .barcode-title {
              font-size: 8pt;
              font-weight: bold;
              margin-bottom: 1mm;
            }
            .barcode {
              margin: 1mm 0;
              display: flex;
              justify-content: center;
              align-items: center;
            }
            .barcode svg {
              max-width: 100%;
              height: auto;
            }
            .barcode-text {
              font-size: 7pt;
              letter-spacing: 0.5px;
              margin-top: 0.5mm;
            }
            
            /* åº•éƒ¨ */
            .footer {
              text-align: center;
              font-size: 8pt;
              color: #0066ff;
              margin-top: 1mm;
            }
          </style>
        </head>
        <body>
          <div class="label">
            <!-- è¡¨é ­ -->
            <div class="header">${companyName} å¯„ä»¶å–®</div>

            <!-- å¯„ä»¶è³‡è¨Š -->
            <div class="info-box">
              <div class="info-title">å¯„ä»¶è³‡è¨Š</div>
              <div class="info-content">
                å¯„ä»¶äººï¼š${escapeHtml(shipment.sender_name || '')}<br>
                é›»è©±ï¼š${escapeHtml(shipment.sender_phone || '')}<br>
                åœ°å€ï¼š${escapeHtml(shipment.sender_address || '')}<br>
                è²¨ç‰©ï¼š${escapeHtml(shipment.item_name || '')} Ã— ${shipment.quantity || 1}<br>
                ${shipment.cod_amount && shipment.cod_amount > 0 ? `ä»£æ”¶ï¼š$${shipment.cod_amount}<br>` : ''}åˆ—å°ï¼š${formatDate(new Date())}
              </div>
            </div>

            <!-- ä¸»è¦ç‰©æµå€ -->
            <div class="main-section">
              <div class="main-content">
                <div class="left-part">
                  <div class="tracking-no">${escapeHtml(shipment.tracking_no || '')}</div>
                  <div class="short-no">${shipment.weight ? (shipment.weight + 'kg') : 'å¾…æ¸¬'}</div>
                </div>
                <div class="qr-box">
                  <div id="qrcode"></div>
                </div>
              </div>
            </div>

            <!-- å–ä»¶å€ -->
            <div class="pickup-section">
              <div class="pickup-title">å–ã€€ä»¶</div>
              <div class="pickup-body">
                <div class="pickup-left">è«‹æ ¸å°<br>æœ«ä¸‰ç¢¼</div>
                <div class="pickup-right">
                  <div class="addr">${escapeHtml(shipment.receiver_address || '')}</div>
                  <div class="name">${escapeHtml(shipment.receiver_name || '')}</div>
                  <div class="code">${escapeHtml((shipment.receiver_phone || '').slice(-3))}</div>
                </div>
              </div>
            </div>

            <!-- å–ä»¶å°ˆç”¨æ¢ç¢¼ -->
            <div class="barcode-section">
              <div class="barcode" id="barcode"></div>
              <div class="barcode-text">${escapeHtml(shipment.tracking_no || '')}</div>
            </div>

            ${shipment.verification_code ? `
            <!-- éœ€è¦é©—è­‰ç¢¼æç¤ºï¼ˆä¸é¡¯ç¤ºé©—è­‰ç¢¼æœ¬èº«ï¼‰-->
            <div style="border: 2px solid #ff9500; border-radius: 2mm; padding: 3mm; margin: 1.5mm 0; background: #fff8e6; text-align: center;">
              <div style="font-size: 9pt; font-weight: bold; color: #ff9500; margin-bottom: 1mm;">âš ï¸ å–ä»¶éœ€è¦é©—è­‰ç¢¼</div>
              <div style="font-size: 8pt; color: #666; line-height: 1.4;">
                æ­¤åŒ…è£¹å–ä»¶æ™‚éœ€è¦è¼¸å…¥é©—è­‰ç¢¼<br>
                é©—è­‰ç¢¼å·²é€éç°¡è¨Š/é€šçŸ¥å‚³é€çµ¦æ”¶ä»¶äºº
              </div>
            </div>
            ` : ''}

          </div>
          <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>
          <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"><\/script>
          <script>
            // ç”Ÿæˆ QR Code å’Œæ¢ç¢¼
            window.onload = function() {
              // ç”Ÿæˆ QR Code
              var qrcode = new QRCode(document.getElementById("qrcode"), {
                text: "${escapeHtml(shipment.tracking_no || '')}",
                width: 90,
                height: 90,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.M
              });
              
              // ç”Ÿæˆæ¢ç¢¼
              var barcodeElement = document.getElementById("barcode");
              var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
              barcodeElement.appendChild(svg);
              
              JsBarcode(svg, "${escapeHtml(shipment.tracking_no || '')}", {
                format: "CODE128",
                width: 1.2,
                height: 35,
                displayValue: false,
                margin: 2
              });
              
              // ç­‰å¾…ç”Ÿæˆå¾Œå†åˆ—å°
              setTimeout(function() {
                window.print();
              }, 600);
            };
          <\/script>
        </body>
        </html>
      `;

      return content;
    }

    // äº‹ä»¶ç›£è½å™¨
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      await signIn(email, password);
    });


    logoutBtn.addEventListener('click', signOut);

    newShipmentBtn.addEventListener('click', () => showForm(false));
    cancelBtn.addEventListener('click', hideForm);

    shipmentForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(shipmentForm);
      const data = Object.fromEntries(formData.entries());
      await saveShipment(data);
    });

    editBtn.addEventListener('click', () => showForm(true));
    deleteBtn.addEventListener('click', () => deleteShipment(selectedShipmentId));
    nextStatusBtn.addEventListener('click', () => advanceStatus(selectedShipmentId));

    printLabelBtn.addEventListener('click', () => {
      if (selectedShipmentId) {
        const shipment = shipments.find(s => s.id === selectedShipmentId);
        if (shipment) {
          const printContent = generatePrintContent(shipment, 'label');
          const printWindow = window.open('', '_blank', 'width=400,height=600');
          printWindow.document.write(printContent);
          printWindow.document.close();
          printWindow.focus();
        }
      }
    });

    printReceiptBtn.addEventListener('click', () => {
      if (selectedShipmentId) {
        const shipment = shipments.find(s => s.id === selectedShipmentId);
        if (shipment) {
          const printContent = generatePrintContent(shipment, 'receipt');
          const printWindow = window.open('', '_blank', 'width=400,height=600');
          printWindow.document.write(printContent);
          printWindow.document.close();
          printWindow.focus();
        }
      }
    });

    searchInput.addEventListener('input', (e) => {
      renderShipmentList(e.target.value);
    });

    exportBtn.addEventListener('click', () => {
      const dataStr = JSON.stringify(shipments, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `shipments_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);
    });

    importFile.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        const data = JSON.parse(text);
        
        if (Array.isArray(data)) {
          // é€™è£¡å¯ä»¥æ·»åŠ åŒ¯å…¥é‚è¼¯
          showMessage('åŒ¯å…¥åŠŸèƒ½é–‹ç™¼ä¸­...', 'error');
        } else {
          showMessage('æª”æ¡ˆæ ¼å¼éŒ¯èª¤', 'error');
        }
      } catch (error) {
        showMessage('è®€å–æª”æ¡ˆå¤±æ•—', 'error');
      }
      
      e.target.value = '';
    });

    posBtn.addEventListener('click', () => {
      window.location.href = 'pages/admin/sales.html';
    });

    // ç”¨æˆ¶é¸å–®åŠŸèƒ½
    const userMenuDropdown = document.getElementById('userMenuDropdown');
    
    userMenuBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      userMenuDropdown.classList.toggle('show');
    });

    // é»æ“Šå¤–éƒ¨é—œé–‰é¸å–®
    document.addEventListener('click', (e) => {
      if (!userMenuDropdown.contains(e.target) && e.target !== userMenuBtn) {
        userMenuDropdown.classList.remove('show');
      }
    });

    // é¸å–®åŠŸèƒ½å‡½æ•¸
    function navigateTo(url) {
      window.location.href = url;
    }

     async function showAccountSettings() {
       userMenuDropdown.classList.remove('show');
       const modal = document.getElementById('accountSettingsModal');
       modal.classList.add('show');
       await loadAccountSettings();
     }

     async function loadAccountSettings() {
       try {
         // è¼‰å…¥ç”¨æˆ¶è³‡æ–™
         const { data: user, error } = await supabaseClient
           .from('users')
           .select('*')
           .eq('id', currentUser.id)
           .single();

         if (error) throw error;

         // å¡«å…¥è¡¨å–®
         document.getElementById('accountName').value = user.name || '';
         document.getElementById('accountEmail').value = user.email || currentUser.email;
         
         const roleText = user.role === 'admin' ? 'ç®¡ç†å“¡' : 
                         user.role === 'staff' ? 'å“¡å·¥' : 'ä¸€èˆ¬ç”¨æˆ¶';
         document.getElementById('accountRole').value = roleText;

         // æ¸…ç©ºå¯†ç¢¼æ¬„ä½
         document.getElementById('currentPassword').value = '';
         document.getElementById('newPassword').value = '';
         document.getElementById('confirmPassword').value = '';
         
         // éš±è—è¨Šæ¯
         document.getElementById('accountMessage').classList.add('hidden');
       } catch (error) {
         console.error('è¼‰å…¥å¸³è™Ÿè¨­å®šå¤±æ•—ï¼š', error);
         showAccountMessage('è¼‰å…¥è³‡æ–™å¤±æ•—', 'error');
       }
     }

     function closeAccountSettings() {
       const modal = document.getElementById('accountSettingsModal');
       modal.classList.remove('show');
     }

     async function saveAccountSettings() {
       const name = document.getElementById('accountName').value.trim();
       const currentPassword = document.getElementById('currentPassword').value;
       const newPassword = document.getElementById('newPassword').value;
       const confirmPassword = document.getElementById('confirmPassword').value;

       try {
         let updated = false;

         // 1. æ›´æ–°å€‹äººè³‡æ–™ï¼ˆå§“åï¼‰
         if (name) {
           const { error } = await supabaseClient
             .from('users')
             .update({ name: name })
             .eq('id', currentUser.id);

           if (error) throw error;
           updated = true;
         }

         // 2. æ›´æ–°å¯†ç¢¼ï¼ˆå¦‚æœæœ‰å¡«å¯«ï¼‰
         if (currentPassword || newPassword || confirmPassword) {
           // é©—è­‰å¯†ç¢¼æ¬„ä½
           if (!currentPassword) {
             showAccountMessage('è«‹è¼¸å…¥ç›®å‰å¯†ç¢¼', 'error');
             return;
           }
           if (!newPassword) {
             showAccountMessage('è«‹è¼¸å…¥æ–°å¯†ç¢¼', 'error');
             return;
           }
           if (newPassword.length < 6) {
             showAccountMessage('æ–°å¯†ç¢¼è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ', 'error');
             return;
           }
           if (newPassword !== confirmPassword) {
             showAccountMessage('æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ç¬¦', 'error');
             return;
           }

           // å…ˆé©—è­‰ç›®å‰å¯†ç¢¼
           const { error: signInError } = await supabaseClient.auth.signInWithPassword({
             email: currentUser.email,
             password: currentPassword
           });

           if (signInError) {
             showAccountMessage('ç›®å‰å¯†ç¢¼éŒ¯èª¤', 'error');
             return;
           }

           // æ›´æ–°å¯†ç¢¼
           const { error: updateError } = await supabaseClient.auth.updateUser({
             password: newPassword
           });

           if (updateError) throw updateError;
           updated = true;
         }

         if (updated) {
           showAccountMessage('è¨­å®šå·²å„²å­˜ï¼', 'success');
           // é‡æ–°è¼‰å…¥ç”¨æˆ¶è³‡è¨Š
           await loadUserInfo();
           // 2 ç§’å¾Œé—œé–‰å°è©±æ¡†
           setTimeout(() => {
             closeAccountSettings();
           }, 2000);
         } else {
           showAccountMessage('æ²’æœ‰è®Šæ›´éœ€è¦å„²å­˜', 'error');
         }
       } catch (error) {
         console.error('å„²å­˜è¨­å®šå¤±æ•—ï¼š', error);
         showAccountMessage('å„²å­˜å¤±æ•—ï¼š' + error.message, 'error');
       }
     }

     function showAccountMessage(text, type) {
       const message = document.getElementById('accountMessage');
       message.textContent = text;
       message.className = `message ${type}`;
       message.classList.remove('hidden');
       
       // 3 ç§’å¾Œè‡ªå‹•éš±è—
       setTimeout(() => {
         message.classList.add('hidden');
       }, 3000);
     }
 
     function showHelp() {
       userMenuDropdown.classList.remove('show');
       const helpText = `
ğŸ“– ç³»çµ±ä½¿ç”¨èªªæ˜

1ï¸âƒ£ æ–°å¢è²¨ä»¶
   â€¢ é»æ“Šã€Œæ–°å¢è²¨ä»¶ã€æŒ‰éˆ•
   â€¢ å¡«å¯«å¯„ä»¶äººã€æ”¶ä»¶äººè³‡æ–™
   â€¢ å¡«å¯«è²¨ç‰©è³‡è¨Š
   â€¢ é»æ“Šã€Œå„²å­˜ã€

2ï¸âƒ£ æŸ¥çœ‹è²¨ä»¶
   â€¢ å¾æ¸…å–®ä¸­é»æ“Šã€ŒæŸ¥çœ‹ã€
   â€¢ å³å´é¡¯ç¤ºè©³ç´°è³‡è¨Š
   â€¢ å¯æŸ¥çœ‹è™•ç†æ­·å²

3ï¸âƒ£ æ›´æ–°ç‹€æ…‹
   â€¢ é»æ“Šã€Œä¸‹ä¸€æ­¥ã€æŒ‰éˆ•
   â€¢ è‡ªå‹•æ›´æ–°è‡³ä¸‹ä¸€å€‹ç‹€æ…‹

4ï¸âƒ£ åˆ—å°å¯„ä»¶å–®
   â€¢ é»æ“Šã€Œåˆ—å°ã€æŒ‰éˆ•
   â€¢ è‡ªå‹•ç”Ÿæˆå« QR Code çš„å¯„ä»¶å–®

5ï¸âƒ£ åŒ…è£¹æŸ¥è©¢ï¼ˆé¡§å®¢ç«¯ï¼‰
   â€¢ é–‹å•Ÿã€ŒåŒ…è£¹æŸ¥è©¢ã€é é¢
   â€¢ è¼¸å…¥åŒ…è£¹ç·¨è™ŸæŸ¥è©¢
   â€¢ æŸ¥çœ‹åŒ…è£¹ç‹€æ…‹èˆ‡é…é€æ­·å²
   â€¢ å¯åˆ†äº«æŸ¥è©¢çµæœ

6ï¸âƒ£ è‡ªåŠ©å ±åˆ°
   â€¢ é¡§å®¢åœ¨ Kiosk è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼
   â€¢ ç¢ºèªèº«ä»½å¾Œå®Œæˆå ±åˆ°
   â€¢ è‡ªå‹•ç”¢ç”Ÿå ±åˆ°è™Ÿç¢¼
   â€¢ åˆ—å°å ±åˆ°å–®

7ï¸âƒ£ æ«ƒæª¯å«è™Ÿ
   â€¢ é€²å…¥ã€Œæ«ƒæª¯å«è™Ÿç®¡ç†ã€
   â€¢ æŸ¥çœ‹å¾…å«è™Ÿåˆ—è¡¨
   â€¢ é»æ“Šã€Œå«è™Ÿã€é€šçŸ¥é¡§å®¢
   â€¢ æº–å‚™åŒ…è£¹å¾Œå‰å¾€çµå¸³

8ï¸âƒ£ å…¬æ’­é¡¯ç¤º
   â€¢ é–‹å•Ÿã€Œå…¬æ’­é¡¯ç¤ºç•«é¢ã€
   â€¢ é€£æ¥è‡³åº—å…§è¢å¹•æˆ–é›»è¦–
   â€¢ è‡ªå‹•é¡¯ç¤ºå«è™Ÿè³‡è¨Š
   â€¢ èªéŸ³æ’­å ±é€šçŸ¥é¡§å®¢

9ï¸âƒ£ å–ä»¶çµå¸³
   â€¢ é»æ“Šã€ŒğŸ›’ å–ä»¶çµå¸³ã€
   â€¢ é€²å…¥ POS ç³»çµ±
   â€¢ æƒæå–®è™Ÿæˆ–è¼¸å…¥æ‰‹æ©Ÿæœ«ä¸‰ç¢¼
   â€¢ å®Œæˆçµå¸³

å¦‚æœ‰å•é¡Œï¼Œè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡ã€‚
         `;
       alert(helpText);
     }

    function showAbout() {
      userMenuDropdown.classList.remove('show');
      const aboutText = `
â„¹ï¸ é—œæ–¼ç³»çµ±

ğŸ“¦ è²¨ç‰©ç®¡ç†ç³»çµ±
ç‰ˆæœ¬ï¼š1.3.0

åŠŸèƒ½ï¼š
âœ… è²¨ä»¶ç®¡ç†
âœ… ç‹€æ…‹è¿½è¹¤
âœ… åˆ—å°å¯„ä»¶å–®
âœ… åŒ…è£¹æŸ¥è©¢ï¼ˆé¡§å®¢ç«¯ï¼‰
âœ… POS å–ä»¶çµå¸³
âœ… æ‰‹æ©Ÿæœ«ä¸‰ç¢¼æŸ¥è©¢
âœ… ä»£æ”¶é‡‘é¡ç®¡ç†
âœ… è‡ªåŠ©å ±åˆ° Kiosk
âœ… æ«ƒæª¯å«è™Ÿç³»çµ±
âœ… å…¬æ’­é¡¯ç¤ºç•«é¢
âœ… èªéŸ³æ’­å ±ç³»çµ±
âœ… å¸³è™Ÿè¨­å®šç®¡ç†

æŠ€è¡“ï¼š
â€¢ Supabase å¾Œç«¯
â€¢ Supabase Realtime å³æ™‚åŒæ­¥
â€¢ ç´” HTML/CSS/JavaScript
â€¢ Web Speech API èªéŸ³æ’­å ±
â€¢ Web Share API åˆ†äº«åŠŸèƒ½
â€¢ å…¨è¢å¹•é¡¯ç¤ºæ”¯æ´
â€¢ éŸ¿æ‡‰å¼è¨­è¨ˆï¼ˆè¡Œå‹•å„ªå…ˆï¼‰

Â© 2025 BaiFa.GRP
          `;
      alert(aboutText);
    }

    // å…¨åŸŸå‡½æ•¸ï¼ˆä¾› HTML èª¿ç”¨ï¼‰
    window.selectShipment = selectShipment;
    window.advanceStatus = advanceStatus;
    window.printShipment = printShipment;

    // åˆå§‹åŒ–
    async function init() {
      // âœ… ç¬¬ä¸€æ­¥ï¼šè¼‰å…¥ LINE è¨­å®šï¼ˆå¾ Supabaseï¼‰
      await initLineConfig();
      
      // ç¬¬äºŒæ­¥ï¼šæª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session) {
        currentUser = session.user;
        showMainApp();
      } else {
        showLoginPage();
      }
    }

    // ç›£è½èªè­‰ç‹€æ…‹è®ŠåŒ–
    supabaseClient.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' && session) {
        currentUser = session.user;
        showMainApp();
      } else if (event === 'SIGNED_OUT') {
        currentUser = null;
        showLoginPage();
      }
    });

    // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
    init();
  </script>
</body>
</html>
