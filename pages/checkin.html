<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>自助報到 - Kiosk 系統</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../config.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #434343;
      --success: #28c76f;
      --danger: #ff3b30;
      --warning: #ff9500;
      --muted: #6b7280;
      --bg: #f5f7fa;
      --card-bg: #ffffff;
      --border: #e5e7eb;
    }

    body {
      font-family: "Microsoft JhengHei", "Noto Sans TC", -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #e3e3e3 0%, #dfdfdf 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .kiosk-container {
      background: var(--card-bg);
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 600px;
      width: 100%;
      overflow: hidden;
    }

    .kiosk-header {
      background: linear-gradient(135deg, #4a4a4a, #2c2c2c);
      color: white;
      padding: 40px 32px;
      text-align: center;
    }

    .kiosk-logo {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .kiosk-title {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .kiosk-subtitle {
      font-size: 18px;
      opacity: 0.9;
    }

    .kiosk-body {
      padding: 40px 32px;
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 32px;
    }

    .step {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--border);
      transition: all 0.3s;
    }

    .step.active {
      background: var(--primary);
      width: 32px;
      border-radius: 6px;
    }

    .screen {
      display: none;
    }

    .screen.active {
      display: block;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .instruction {
      text-align: center;
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 24px;
      color: #1f2937;
    }

    .phone-input-group {
      text-align: center;
      margin-bottom: 32px;
    }

    .phone-display {
      font-size: 48px;
      font-weight: bold;
      letter-spacing: 8px;
      color: var(--primary);
      min-height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: "Courier New", monospace;
    }

    .numpad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      max-width: 400px;
      margin: 0 auto;
    }

    .num-btn {
      padding: 24px;
      font-size: 28px;
      font-weight: 600;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }

    .num-btn:hover {
      background: var(--bg);
      border-color: var(--primary);
    }

    .num-btn:active {
      transform: scale(0.95);
    }

    .num-btn.wide {
      grid-column: span 2;
    }

    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .btn {
      flex: 1;
      padding: 18px 24px;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: #0066cc;
    }

    .btn-secondary {
      background: var(--muted);
      color: white;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .info-card {
      background: var(--bg);
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      color: var(--muted);
      font-weight: 500;
    }

    .info-value {
      font-weight: 600;
      color: #1f2937;
    }

    .checkin-number {
      text-align: center;
      margin: 32px 0;
    }

    .checkin-number-label {
      font-size: 18px;
      color: var(--muted);
      margin-bottom: 12px;
    }

    .checkin-number-value {
      font-size: 72px;
      font-weight: bold;
      color: var(--success);
      font-family: "Courier New", monospace;
    }

    .success-icon {
      text-align: center;
      font-size: 80px;
      margin-bottom: 24px;
    }

    .message {
      text-align: center;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 24px;
      font-weight: 500;
    }

    .message.error {
      background: #ffecee;
      color: var(--danger);
    }

    .message.warning {
      background: #fff8e6;
      color: var(--warning);
    }

    .message.success {
      background: #e8f7ee;
      color: var(--success);
    }

    .loading {
      text-align: center;
      padding: 40px;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="kiosk-container">
    <!-- 頭部 -->
    <div class="kiosk-header">
      <div class="kiosk-logo">🏷️</div>
      <h1 class="kiosk-title">自助報到</h1>
      <p class="kiosk-subtitle">請輸入手機號碼查詢包裹</p>
    </div>

    <div class="kiosk-body">
      <!-- 步驟指示器 -->
      <div class="step-indicator">
        <div class="step active" id="step1"></div>
        <div class="step" id="step2"></div>
        <div class="step" id="step3"></div>
      </div>

      <!-- 畫面 1: 輸入手機號碼 -->
      <div id="screen1" class="screen active">
        <div class="instruction">請輸入手機號碼（10 碼）</div>
        
        <div class="phone-input-group">
          <div class="phone-display" id="phoneDisplay">__________</div>
        </div>

        <div class="numpad">
          <button class="num-btn" onclick="inputNumber('1')">1</button>
          <button class="num-btn" onclick="inputNumber('2')">2</button>
          <button class="num-btn" onclick="inputNumber('3')">3</button>
          <button class="num-btn" onclick="inputNumber('4')">4</button>
          <button class="num-btn" onclick="inputNumber('5')">5</button>
          <button class="num-btn" onclick="inputNumber('6')">6</button>
          <button class="num-btn" onclick="inputNumber('7')">7</button>
          <button class="num-btn" onclick="inputNumber('8')">8</button>
          <button class="num-btn" onclick="inputNumber('9')">9</button>
          <button class="num-btn" onclick="clearInput()">清除</button>
          <button class="num-btn" onclick="inputNumber('0')">0</button>
          <button class="num-btn" onclick="deleteNumber()">←</button>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="resetKiosk()">取消</button>
          <button class="btn btn-primary" onclick="searchByPhone()">查詢</button>
        </div>
      </div>

      <!-- 畫面 2: 確認身份 -->
      <div id="screen2" class="screen">
        <div class="instruction">請確認您的資訊</div>
        
        <div id="confirmMessage"></div>

        <div class="info-card">
          <div class="info-row">
            <span class="info-label">收件人</span>
            <span class="info-value" id="receiverName">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">電話末三碼</span>
            <span class="info-value" id="receiverPhone">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">取件單號</span>
            <span class="info-value" id="trackingNo">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">代收金額</span>
            <span class="info-value" id="codAmount" style="color: var(--danger); font-size: 24px;">-</span>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="backToInput()">返回</button>
          <button class="btn btn-primary" onclick="confirmCheckin()">確認報到</button>
        </div>
      </div>

      <!-- 畫面 3: 完成報到 -->
      <div id="screen3" class="screen">
        <div class="success-icon">✅</div>
        <div class="instruction">報到成功！</div>
        
        <div class="checkin-number">
          <div class="checkin-number-label">您的報到號碼</div>
          <div class="checkin-number-value" id="checkinNumber">001</div>
        </div>

        <div class="message success">
          請稍待叫號，我們正在為您準備包裹...
        </div>

        <div class="info-card">
          <div class="info-row">
            <span class="info-label">代收金額</span>
            <span class="info-value" id="finalCodAmount" style="color: var(--danger); font-size: 20px;">$0</span>
          </div>
          <div class="info-row">
            <span class="info-label">報到時間</span>
            <span class="info-value" id="checkinTime">-</span>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="printCheckinTicket()">重新列印</button>
          <button class="btn btn-primary" onclick="resetKiosk()">完成</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Supabase 初始化
    const { createClient } = supabase;
    const supabaseClient = createClient(CONFIG.SUPABASE.URL, CONFIG.SUPABASE.ANON_KEY);

    // 全域變數
    let phoneNumber = '';
    let currentShipment = null;
    let currentCheckin = null;
    const storeCode = 'ST001'; // 實際應該從設定讀取

    // 輸入數字
    function inputNumber(num) {
      if (phoneNumber.length < 10) {
        phoneNumber += num;
        updatePhoneDisplay();
      }
    }

    // 刪除數字
    function deleteNumber() {
      phoneNumber = phoneNumber.slice(0, -1);
      updatePhoneDisplay();
    }

    // 清除輸入
    function clearInput() {
      phoneNumber = '';
      updatePhoneDisplay();
    }

    // 更新顯示
    function updatePhoneDisplay() {
      const display = document.getElementById('phoneDisplay');
      const formatted = phoneNumber.padEnd(10, '_');
      display.textContent = formatted;
    }

    // 查詢包裹
    async function searchByPhone() {
      if (phoneNumber.length !== 10) {
        showMessage('請輸入完整的 10 碼手機號碼', 'error', 'screen1');
        return;
      }

      showLoading('screen1');

      try {
        // 記錄查詢動作
        await logKioskAction('phone_search', null, null, phoneNumber);

        // 查詢包裹
        const { data: shipments, error } = await supabaseClient
          .from('shipments')
          .select('*')
          .like('receiver_phone', `%${phoneNumber}%`)
          .in('status', ['包裹已配達取件門市', '物流單已建立', '包裹離店作業中', '包裹抵達理貨中心，處理中'])
          .order('created_at', { ascending: false });

        if (error) throw error;

        if (!shipments || shipments.length === 0) {
          showMessage('查無待取件包裹，請確認電話號碼或聯繫櫃檯', 'error', 'screen1');
          return;
        }

        // 檢查是否已報到
        const { data: existingCheckin } = await supabaseClient
          .from('checkin_records')
          .select('*')
          .eq('tracking_no', shipments[0].tracking_no)
          .gte('checkin_time', new Date().toISOString().split('T')[0])
          .in('status', ['待叫號', '已叫號'])
          .single();

        if (existingCheckin) {
          showMessage(`此包裹已報到，號碼：${existingCheckin.checkin_no}`, 'warning', 'screen1');
          return;
        }

        // 顯示確認畫面
        currentShipment = shipments[0];
        showConfirmScreen();

      } catch (error) {
        console.error('查詢失敗：', error);
        showMessage('系統查詢失敗，請稍後再試或聯繫櫃檯', 'error', 'screen1');
      } finally {
        hideLoading('screen1');
      }
    }

    // 顯示確認畫面
    function showConfirmScreen() {
      document.getElementById('receiverName').textContent = 
        currentShipment.receiver_name.substring(0, 2) + '**';
      document.getElementById('receiverPhone').textContent = 
        currentShipment.receiver_phone.slice(-3);
      document.getElementById('trackingNo').textContent = currentShipment.tracking_no;
      document.getElementById('codAmount').textContent = 
        `$${currentShipment.cod_amount || 0}`;

      if (currentShipment.cod_amount && currentShipment.cod_amount > 0) {
        document.getElementById('confirmMessage').innerHTML = 
          '<div class="message warning">⚠️ 此包裹需支付代收金額，請先備妥現金</div>';
      } else {
        document.getElementById('confirmMessage').innerHTML = '';
      }

      switchScreen(2);
    }

    // 確認報到
    async function confirmCheckin() {
      showLoading('screen2');

      try {
        // 生成報到號碼
        const { data: checkinNo, error: noError } = await supabaseClient
          .rpc('generate_checkin_no');

        if (noError) throw noError;

        // 建立報到記錄
        const { data: checkin, error: checkinError } = await supabaseClient
          .from('checkin_records')
          .insert({
            checkin_no: checkinNo,
            shipment_id: currentShipment.id,
            tracking_no: currentShipment.tracking_no,
            receiver_name: currentShipment.receiver_name,
            receiver_phone: currentShipment.receiver_phone,
            cod_amount: currentShipment.cod_amount || 0,
            status: '待叫號',
            store_code: storeCode,
            print_count: 0
          })
          .select()
          .single();

        if (checkinError) throw checkinError;

        currentCheckin = checkin;

        // 記錄報到動作
        await logKioskAction('checkin_completed', checkin.checkin_no, checkin.tracking_no, phoneNumber);

        // 列印報到單
        await printCheckinTicket();

        // 顯示完成畫面
        showCompleteScreen();

      } catch (error) {
        console.error('報到失敗：', error);
        if (error.message.includes('已報到')) {
          showMessage('此包裹今日已報到，請勿重複報到', 'error', 'screen2');
        } else {
          showMessage('報到失敗：' + error.message, 'error', 'screen2');
        }
      } finally {
        hideLoading('screen2');
      }
    }

    // 顯示完成畫面
    function showCompleteScreen() {
      document.getElementById('checkinNumber').textContent = currentCheckin.checkin_no;
      document.getElementById('finalCodAmount').textContent = 
        `$${currentCheckin.cod_amount || 0}`;
      document.getElementById('checkinTime').textContent = 
        new Date().toLocaleString('zh-TW');

      switchScreen(3);
    }

    // 列印報到單
    async function printCheckinTicket() {
      if (!currentCheckin) return;

      try {
        // 更新列印次數
        await supabaseClient
          .from('checkin_records')
          .update({
            print_count: currentCheckin.print_count + 1,
            last_print_time: new Date().toISOString()
          })
          .eq('id', currentCheckin.id);

        // 記錄列印動作
        await logKioskAction('print_ticket', currentCheckin.checkin_no, currentCheckin.tracking_no);

        // 生成列印內容
        const printContent = generatePrintContent();
        const printWindow = window.open('', '_blank', 'width=300,height=600');
        printWindow.document.write(printContent);
        printWindow.document.close();
        setTimeout(() => {
          printWindow.print();
        }, 500);

      } catch (error) {
        console.error('列印失敗：', error);
        alert('列印失敗，請聯繫櫃檯人員');
      }
    }

    // 生成列印內容
    function generatePrintContent() {
      return `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>報到單</title>
          <style>
            @page { size: 58mm auto; margin: 0; }
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
              width: 58mm;
              font-family: "Microsoft JhengHei", monospace;
              font-size: 10pt;
              padding: 5mm;
              line-height: 1.4;
            }
            .center { text-align: center; }
            .header { font-size: 16pt; font-weight: bold; margin-bottom: 3mm; }
            .divider { border-top: 1px dashed #000; margin: 3mm 0; }
            .number { font-size: 32pt; font-weight: bold; margin: 4mm 0; }
            .row { display: flex; justify-content: space-between; margin: 2mm 0; }
            .label { font-weight: bold; }
            .amount { font-size: 20pt; font-weight: bold; color: #000; margin: 3mm 0; }
            .note { font-size: 9pt; margin: 2mm 0; }
          </style>
        </head>
        <body>
          <div class="center header">★ 報到單 ★</div>
          <div class="center" style="font-size: 12pt; font-weight: bold; margin-bottom: 3mm;">
            ${CONFIG.UI.PRINT.COMPANY.NAME}
          </div>
          <div class="divider"></div>
          
          <div class="row">
            <span class="label">報到號碼：</span>
          </div>
          <div class="center number">${currentCheckin.checkin_no}</div>
          
          <div class="divider"></div>
          
          <div class="row">
            <span class="label">取件單號：</span>
            <span>${currentCheckin.tracking_no}</span>
          </div>
          <div class="row">
            <span class="label">報到時間：</span>
            <span>${new Date().toLocaleString('zh-TW', { 
              hour: '2-digit', 
              minute: '2-digit' 
            })}</span>
          </div>
          
          <div class="divider"></div>
          
          ${currentCheckin.cod_amount > 0 ? `
            <div class="center">
              <div class="label">代收金額</div>
              <div class="amount">$${currentCheckin.cod_amount}</div>
            </div>
            <div class="center note">請先備妥您的現金</div>
            <div class="divider"></div>
          ` : ''}
          
          <div class="center note">
            請稍待叫號<br>
            準備包裹中...
          </div>
          
          <div class="divider"></div>
          <div class="center" style="font-size: 8pt; margin-top: 3mm;">
            ${CONFIG.UI.PRINT.COMPANY.PHONE}
          </div>
        </body>
        </html>
      `;
    }

    // 記錄 Kiosk 操作
    async function logKioskAction(action, checkinNo, trackingNo, phone) {
      try {
        await supabaseClient
          .from('kiosk_logs')
          .insert({
            action,
            checkin_no: checkinNo,
            tracking_no: trackingNo,
            phone_number: phone,
            store_code: storeCode,
            device_id: navigator.userAgent,
            details: {
              timestamp: new Date().toISOString(),
              screen_resolution: `${window.screen.width}x${window.screen.height}`
            }
          });
      } catch (error) {
        console.error('記錄日誌失敗：', error);
      }
    }

    // 切換畫面
    function switchScreen(screenNum) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      
      document.getElementById(`screen${screenNum}`).classList.add('active');
      document.getElementById(`step${screenNum}`).classList.add('active');
    }

    // 返回輸入
    function backToInput() {
      switchScreen(1);
    }

    // 重置 Kiosk
    function resetKiosk() {
      phoneNumber = '';
      currentShipment = null;
      currentCheckin = null;
      updatePhoneDisplay();
      switchScreen(1);
      
      // 清除訊息
      document.querySelectorAll('.message').forEach(m => m.remove());
    }

    // 顯示訊息
    function showMessage(text, type, screenId) {
      const screen = document.getElementById(screenId);
      const existing = screen.querySelector('.message');
      if (existing) existing.remove();
      
      const message = document.createElement('div');
      message.className = `message ${type}`;
      message.textContent = text;
      screen.insertBefore(message, screen.firstChild);
      
      setTimeout(() => message.remove(), 5000);
    }

    // 顯示載入
    function showLoading(screenId) {
      const screen = document.getElementById(screenId);
      const loading = document.createElement('div');
      loading.className = 'loading';
      loading.id = 'loadingIndicator';
      loading.innerHTML = '<div class="spinner"></div><div>處理中...</div>';
      screen.appendChild(loading);
    }

    // 隱藏載入
    function hideLoading(screenId) {
      const loading = document.getElementById('loadingIndicator');
      if (loading) loading.remove();
    }

    // 初始化
    function init() {
      updatePhoneDisplay();
      
      // 監聽鍵盤輸入
      document.addEventListener('keydown', (e) => {
        if (document.getElementById('screen1').classList.contains('active')) {
          if (e.key >= '0' && e.key <= '9') {
            inputNumber(e.key);
          } else if (e.key === 'Backspace') {
            deleteNumber();
          } else if (e.key === 'Enter') {
            searchByPhone();
          }
        }
      });
    }

    init();
  </script>
</body>
</html>

