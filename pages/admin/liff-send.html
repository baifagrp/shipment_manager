<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LINE è¨Šæ¯ç™¼é€ - BaiFa.GRP</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #ffffff 0%, #6b7280 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
      font-size: 14px;
    }

    .content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      padding: 30px;
    }

    .section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 25px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #2d3748;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #4a5568;
      margin-bottom: 8px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
      font-family: inherit;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-textarea {
      resize: vertical;
      min-height: 200px;
      font-family: 'Courier New', monospace;
    }

    .customer-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      border: 2px solid #e2e8f0;
      margin-top: 10px;
    }

    .customer-card.active {
      border-color: #667eea;
      background: #f7faff;
    }

    .customer-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .customer-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      font-weight: bold;
    }

    .customer-details {
      flex: 1;
    }

    .customer-name {
      font-weight: 600;
      font-size: 16px;
      color: #2d3748;
      margin-bottom: 5px;
    }

    .customer-meta {
      font-size: 13px;
      color: #718096;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary {
      background: #e2e8f0;
      color: #4a5568;
    }

    .btn-secondary:hover {
      background: #cbd5e0;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .message-type-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .type-option {
      flex: 1;
      padding: 15px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .type-option:hover {
      border-color: #cbd5e0;
    }

    .type-option.active {
      border-color: #667eea;
      background: #f7faff;
    }

    .type-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .type-label {
      font-size: 14px;
      font-weight: 600;
      color: #2d3748;
    }

    .preview-area {
      background: white;
      border-radius: 8px;
      padding: 20px;
      min-height: 300px;
      border: 2px solid #e2e8f0;
    }

    .preview-title {
      font-size: 14px;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .message-bubble {
      background: #06c755;
      color: white;
      padding: 12px 16px;
      border-radius: 18px;
      display: inline-block;
      max-width: 80%;
      word-wrap: break-word;
      white-space: pre-wrap;
      margin-top: 10px;
    }

    .flex-preview {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      overflow: hidden;
      margin-top: 10px;
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }

    .template-selector {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .template-btn {
      padding: 8px 12px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .template-btn:hover {
      border-color: #667eea;
      background: #f7faff;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .search-results {
      margin-top: 10px;
      max-height: 300px;
      overflow-y: auto;
    }

    .search-result-item {
      padding: 12px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .search-result-item:hover {
      border-color: #667eea;
      background: #f7faff;
    }

    @media (max-width: 1024px) {
      .content {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“© LINE è¨Šæ¯ç™¼é€</h1>
      <p>å‘å·²ç¶å®šçš„é¡§å®¢ç™¼é€é€šçŸ¥ã€å„ªæƒ åˆ¸æˆ–å–ä»¶æé†’</p>
    </div>

    <div class="content">
      <!-- å·¦å´ï¼šç·¨è¼¯å€ -->
      <div>
        <!-- æœå°‹é¡§å®¢ -->
        <div class="section">
          <div class="section-title">
            ğŸ” æœå°‹é¡§å®¢
          </div>

          <div class="form-group">
            <label class="form-label">è¼¸å…¥é¡§å®¢å§“åæˆ–æ‰‹æ©Ÿè™Ÿ</label>
            <input 
              type="text" 
              class="form-input" 
              id="searchInput" 
              placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜ æˆ– 0912345678"
              oninput="searchCustomer()"
            >
          </div>

          <div class="search-results" id="searchResults"></div>

          <div id="selectedCustomer" style="display: none;">
            <div class="customer-card active">
              <div class="customer-info">
                <div class="customer-avatar" id="customerAvatar">?</div>
                <div class="customer-details">
                  <div class="customer-name" id="customerName">æœªé¸æ“‡</div>
                  <div class="customer-meta">
                    ğŸ“± <span id="customerPhone">-</span><br>
                    ğŸ†” <span id="customerLineId">-</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- è¨Šæ¯é¡å‹ -->
        <div class="section">
          <div class="section-title">
            ğŸ“„ è¨Šæ¯é¡å‹
          </div>

          <div class="message-type-selector">
            <div class="type-option active" onclick="selectMessageType('text')">
              <div class="type-icon">ğŸ’¬</div>
              <div class="type-label">æ–‡å­—è¨Šæ¯</div>
            </div>
            <div class="type-option" onclick="selectMessageType('flex')">
              <div class="type-icon">ğŸ“±</div>
              <div class="type-label">Flex Message</div>
            </div>
          </div>

          <!-- æ–‡å­—è¨Šæ¯ç·¨è¼¯å€ -->
          <div id="textEditor" class="form-group">
            <label class="form-label">è¨Šæ¯å…§å®¹</label>
            <textarea 
              class="form-textarea" 
              id="textContent" 
              placeholder="è¼¸å…¥è¦ç™¼é€çš„æ–‡å­—è¨Šæ¯..."
              oninput="updatePreview()"
              style="min-height: 150px;"
            ></textarea>
          </div>

          <!-- Flex Message ç·¨è¼¯å€ -->
          <div id="flexEditor" class="form-group" style="display: none;">
            <label class="form-label">Flex JSON</label>
            <div class="template-selector">
              <button class="template-btn" onclick="loadTemplate('arrival')">ğŸ“¦ åˆ°åº—é€šçŸ¥</button>
              <button class="template-btn" onclick="loadTemplate('coupon')">ğŸ« å„ªæƒ åˆ¸</button>
              <button class="template-btn" onclick="loadTemplate('reminder')">â° å–ä»¶æé†’</button>
            </div>
            <textarea 
              class="form-textarea" 
              id="flexContent" 
              placeholder='{"type": "bubble", ...}'
              oninput="updatePreview()"
            ></textarea>
          </div>

          <!-- ç™¼é€æŒ‰éˆ• -->
          <div class="btn-group">
            <button class="btn btn-primary" onclick="sendMessage()" id="sendBtn" disabled>
              ğŸš€ ç«‹å³ç™¼é€
            </button>
            <button class="btn btn-secondary" onclick="clearContent()">
              ğŸ”„ æ¸…é™¤å…§å®¹
            </button>
          </div>
        </div>
      </div>

      <!-- å³å´ï¼šé è¦½å€ -->
      <div>
        <div class="section">
          <div class="section-title">
            ğŸ‘€ è¨Šæ¯é è¦½
          </div>

          <div class="preview-area">
            <div class="preview-title">
              ğŸ’¬ LINE é¡¯ç¤ºæ•ˆæœ
            </div>
            <div id="previewContent">
              <p style="color: #a0aec0; text-align: center; padding: 40px 0;">
                è«‹è¼¸å…¥è¨Šæ¯å…§å®¹ä»¥æŸ¥çœ‹é è¦½
              </p>
            </div>
          </div>

          <!-- ç™¼é€ç‹€æ…‹ -->
          <div id="statusAlert" style="margin-top: 20px;"></div>

          <!-- è¼‰å…¥ä¸­ -->
          <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>ç™¼é€ä¸­...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="../../config.js"></script>
  <script>
    // åˆå§‹åŒ– Supabase
    const supabaseClient = supabase.createClient(
      CONFIG.SUPABASE.URL,
      CONFIG.SUPABASE.ANON_KEY
    );

    let currentUser = null;
    let selectedCustomer = null;
    let currentMessageType = 'text';

    // æª¢æŸ¥ç™»å…¥èˆ‡æ¬Šé™
    async function checkAuth() {
      const { data: { user }, error } = await supabaseClient.auth.getUser();
      
      if (error || !user) {
        alert('è«‹å…ˆç™»å…¥');
        window.location.href = '../../index.html';
        return false;
      }

      currentUser = user;
      console.log('âœ… å·²ç™»å…¥:', user.email);
      return true;
    }

    // æœå°‹é¡§å®¢
    let searchTimeout;
    async function searchCustomer() {
      clearTimeout(searchTimeout);
      
      const keyword = document.getElementById('searchInput').value.trim();
      const resultsDiv = document.getElementById('searchResults');
      
      if (keyword.length < 2) {
        resultsDiv.innerHTML = '';
        return;
      }

      searchTimeout = setTimeout(async () => {
        try {
          console.log('ğŸ” æœå°‹é¡§å®¢:', keyword);
          
          const { data, error } = await supabaseClient
            .from('line_bindings')
            .select('*')
            .or(`phone.ilike.%${keyword}%`)
            .limit(10);

          if (error) throw error;

          console.log('æŸ¥è©¢çµæœ:', data);

          if (data && data.length > 0) {
            resultsDiv.innerHTML = data.map(customer => `
              <div class="search-result-item" onclick='selectCustomer(${JSON.stringify(customer)})'>
                <strong>${customer.phone}</strong><br>
                <small style="color: #718096;">LINE ID: ${customer.line_user_id}</small>
              </div>
            `).join('');
          } else {
            resultsDiv.innerHTML = '<p style="color: #a0aec0; padding: 10px;">æŸ¥ç„¡çµæœ</p>';
          }
        } catch (error) {
          console.error('âŒ æœå°‹å¤±æ•—:', error);
          resultsDiv.innerHTML = '<p style="color: #e53e3e; padding: 10px;">æœå°‹å¤±æ•—</p>';
        }
      }, 300);
    }

    // é¸æ“‡é¡§å®¢
    function selectCustomer(customer) {
      selectedCustomer = customer;
      
      document.getElementById('selectedCustomer').style.display = 'block';
      document.getElementById('searchResults').innerHTML = '';
      document.getElementById('searchInput').value = customer.phone;
      
      // æ›´æ–°é¡¯ç¤º
      const firstChar = customer.phone ? customer.phone[0] : '?';
      document.getElementById('customerAvatar').textContent = firstChar;
      document.getElementById('customerName').textContent = customer.phone;
      document.getElementById('customerPhone').textContent = customer.phone;
      document.getElementById('customerLineId').textContent = customer.line_user_id;
      
      // å•Ÿç”¨ç™¼é€æŒ‰éˆ•
      updateSendButton();
      
      console.log('âœ… å·²é¸æ“‡é¡§å®¢:', customer);
    }

    // åˆ‡æ›è¨Šæ¯é¡å‹
    function selectMessageType(type) {
      currentMessageType = type;
      
      // æ›´æ–° UI
      document.querySelectorAll('.type-option').forEach(el => el.classList.remove('active'));
      event.target.closest('.type-option').classList.add('active');
      
      // åˆ‡æ›ç·¨è¼¯å€
      document.getElementById('textEditor').style.display = type === 'text' ? 'block' : 'none';
      document.getElementById('flexEditor').style.display = type === 'flex' ? 'block' : 'none';
      
      updatePreview();
    }

    // æ›´æ–°é è¦½
    function updatePreview() {
      const previewDiv = document.getElementById('previewContent');
      
      if (currentMessageType === 'text') {
        const text = document.getElementById('textContent').value;
        if (text.trim()) {
          previewDiv.innerHTML = `<div class="message-bubble">${escapeHtml(text)}</div>`;
        } else {
          previewDiv.innerHTML = '<p style="color: #a0aec0; text-align: center; padding: 40px 0;">è«‹è¼¸å…¥æ–‡å­—è¨Šæ¯</p>';
        }
      } else {
        const flexJson = document.getElementById('flexContent').value;
        if (flexJson.trim()) {
          try {
            const flexData = JSON.parse(flexJson);
            // æ¸²æŸ“ Flex Message è¦–è¦ºé è¦½
            const flexHtml = renderFlexMessage(flexData.contents || flexData);
            previewDiv.innerHTML = `
              <div class="flex-preview">
                <div style="background: #e9ecef; padding: 20px;">
                  <p style="color: #4a5568; font-size: 12px; margin-bottom: 10px;">âœ… Flex Message é è¦½</p>
                  ${flexHtml}
                </div>
              </div>
            `;
          } catch (e) {
            previewDiv.innerHTML = `<p style="color: #e53e3e; padding: 20px;">âŒ JSON æ ¼å¼éŒ¯èª¤ï¼š${e.message}</p>`;
          }
        } else {
          previewDiv.innerHTML = '<p style="color: #a0aec0; text-align: center; padding: 40px 0;">è«‹è¼¸å…¥ Flex JSON</p>';
        }
      }
      
      updateSendButton();
    }

    // HTML è·³è„«
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // æ¸²æŸ“ Flex Message è¦–è¦ºæ•ˆæœ
    function renderFlexMessage(flex) {
      if (flex.type === 'bubble') {
        return renderBubble(flex);
      } else if (flex.type === 'carousel') {
        return `<div style="display: flex; gap: 10px; overflow-x: auto;">${flex.contents.map(renderBubble).join('')}</div>`;
      }
      return '<p style="color: #718096;">ä¸æ”¯æ´çš„ Flex é¡å‹</p>';
    }

    // æ¸²æŸ“ Bubble
    function renderBubble(bubble) {
      let html = '<div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 300px; margin: 0 auto;">';
      
      // Hero
      if (bubble.hero) {
        const heroBg = bubble.hero.backgroundColor || '#06c755';
        const heroPadding = bubble.hero.paddingAll || '20px';
        html += `<div style="background: ${heroBg}; padding: ${heroPadding};">`;
        html += renderBox(bubble.hero);
        html += '</div>';
      }
      
      // Body
      if (bubble.body) {
        const bodyPadding = bubble.body.paddingAll || '20px';
        html += `<div style="padding: ${bodyPadding};">`;
        html += renderBox(bubble.body);
        html += '</div>';
      }
      
      // Footer
      if (bubble.footer) {
        const footerPadding = bubble.footer.paddingAll || '20px';
        html += `<div style="padding: ${footerPadding}; border-top: 1px solid #e9ecef;">`;
        html += renderBox(bubble.footer);
        html += '</div>';
      }
      
      html += '</div>';
      return html;
    }

    // æ¸²æŸ“ Box
    function renderBox(box) {
      if (!box.contents) return '';
      
      const layout = box.layout || 'vertical';
      const spacing = box.spacing || 'none';
      const margin = box.margin || 'none';
      const bg = box.backgroundColor || 'transparent';
      const padding = box.paddingAll || '0';
      const cornerRadius = box.cornerRadius ? `${box.cornerRadius}px` : '0';
      
      const spacingMap = { none: '0', xs: '4px', sm: '8px', md: '12px', lg: '16px', xl: '20px', xxl: '24px' };
      const marginMap = { none: '0', xs: '4px', sm: '8px', md: '12px', lg: '16px', xl: '20px', xxl: '24px' };
      
      const flexDirection = layout === 'vertical' ? 'column' : 'row';
      const gap = spacingMap[spacing] || spacing;
      const marginValue = marginMap[margin] || margin;
      
      let html = `<div style="display: flex; flex-direction: ${flexDirection}; gap: ${gap}; margin-top: ${marginValue}; background: ${bg}; padding: ${padding}; border-radius: ${cornerRadius};">`;
      
      box.contents.forEach(item => {
        if (item.type === 'text') {
          html += renderText(item);
        } else if (item.type === 'box') {
          html += renderBox(item);
        } else if (item.type === 'button') {
          html += renderButton(item);
        } else if (item.type === 'separator') {
          html += '<hr style="border: none; border-top: 1px solid #e9ecef; margin: 8px 0;">';
        } else if (item.type === 'spacer') {
          const size = item.size || 'md';
          const sizeMap = { xs: '4px', sm: '8px', md: '12px', lg: '16px', xl: '20px' };
          html += `<div style="height: ${sizeMap[size] || size};"></div>`;
        }
      });
      
      html += '</div>';
      return html;
    }

    // æ¸²æŸ“æ–‡å­—
    function renderText(text) {
      const sizeMap = { xxs: '10px', xs: '12px', sm: '14px', md: '16px', lg: '18px', xl: '20px', xxl: '24px', '3xl': '28px', '4xl': '32px', '5xl': '36px' };
      const weightMap = { regular: 'normal', bold: 'bold' };
      const alignMap = { start: 'left', center: 'center', end: 'right' };
      
      const fontSize = sizeMap[text.size] || text.size || '14px';
      const fontWeight = weightMap[text.weight] || text.weight || 'normal';
      const color = text.color || '#000000';
      const textAlign = alignMap[text.align] || text.align || 'left';
      const margin = text.margin || 'none';
      const marginMap = { none: '0', xs: '4px', sm: '8px', md: '12px', lg: '16px', xl: '20px' };
      const marginValue = marginMap[margin] || margin;
      const flex = text.flex || 'auto';
      const wrap = text.wrap ? 'normal' : 'nowrap';
      
      return `<div style="font-size: ${fontSize}; font-weight: ${fontWeight}; color: ${color}; text-align: ${textAlign}; margin-top: ${marginValue}; flex: ${flex}; white-space: ${wrap === 'normal' ? 'pre-wrap' : 'nowrap'}; overflow: ${wrap === 'nowrap' ? 'hidden' : 'visible'}; text-overflow: ${wrap === 'nowrap' ? 'ellipsis' : 'clip'};">${escapeHtml(text.text)}</div>`;
    }

    // æ¸²æŸ“æŒ‰éˆ•
    function renderButton(button) {
      const style = button.style || 'primary';
      const height = button.height || 'md';
      
      const styleMap = {
        primary: 'background: #06c755; color: white;',
        secondary: 'background: #e9ecef; color: #2d3748;',
        link: 'background: transparent; color: #0a84ff; text-decoration: underline;'
      };
      
      const heightMap = { sm: '32px', md: '40px' };
      
      const buttonStyle = styleMap[style] || styleMap.primary;
      const buttonHeight = heightMap[height] || height;
      
      return `<button style="${buttonStyle} height: ${buttonHeight}; border: none; border-radius: 4px; padding: 0 16px; cursor: pointer; font-size: 14px; font-weight: bold; width: 100%;">${escapeHtml(button.action?.label || 'Button')}</button>`;
    }

    // æ›´æ–°ç™¼é€æŒ‰éˆ•ç‹€æ…‹
    function updateSendButton() {
      const sendBtn = document.getElementById('sendBtn');
      const hasCustomer = selectedCustomer !== null;
      const hasContent = currentMessageType === 'text' 
        ? document.getElementById('textContent').value.trim().length > 0
        : document.getElementById('flexContent').value.trim().length > 0;
      
      sendBtn.disabled = !(hasCustomer && hasContent);
    }

    // è¼‰å…¥ç¯„æœ¬
    function loadTemplate(type) {
      const templates = {
        arrival: {
          type: 'flex',
          altText: 'ğŸ“¦ æ‚¨çš„åŒ…è£¹å·²åˆ°åº—',
          contents: {
            type: 'bubble',
            hero: {
              type: 'box',
              layout: 'vertical',
              contents: [
                { type: 'text', text: 'ğŸ“¦ åŒ…è£¹åˆ°åº—é€šçŸ¥', weight: 'bold', size: 'xl', color: '#ffffff' }
              ],
              backgroundColor: '#0a84ff',
              paddingAll: '20px'
            },
            body: {
              type: 'box',
              layout: 'vertical',
              contents: [
                { type: 'text', text: 'æ‚¨çš„åŒ…è£¹å·²é€é”é–€å¸‚', size: 'md', color: '#2d3748' },
                { type: 'text', text: 'è«‹ç›¡å¿«å–ä»¶', size: 'sm', color: '#718096', margin: 'md' }
              ]
            }
          }
        },
        coupon: {
          type: 'flex',
          altText: 'ğŸ« å°ˆå±¬å„ªæƒ åˆ¸',
          contents: {
            type: 'bubble',
            hero: {
              type: 'box',
              layout: 'vertical',
              contents: [
                { type: 'text', text: 'ğŸ« å°ˆå±¬å„ªæƒ åˆ¸', weight: 'bold', size: 'xl', color: '#ffffff' }
              ],
              backgroundColor: '#ff6b6b',
              paddingAll: '20px'
            },
            body: {
              type: 'box',
              layout: 'vertical',
              contents: [
                { type: 'text', text: 'é™æ™‚å„ªæƒ ', size: 'lg', weight: 'bold' },
                { type: 'text', text: 'ç«‹å³ä½¿ç”¨äº« 9 æŠ˜å„ªæƒ ', size: 'sm', color: '#718096', margin: 'md' }
              ]
            }
          }
        },
        reminder: {
          type: 'flex',
          altText: 'â° å–ä»¶æé†’',
          contents: {
            type: 'bubble',
            hero: {
              type: 'box',
              layout: 'vertical',
              contents: [
                { type: 'text', text: 'â° å–ä»¶æé†’', weight: 'bold', size: 'xl', color: '#ffffff' }
              ],
              backgroundColor: '#ffa500',
              paddingAll: '20px'
            },
            body: {
              type: 'box',
              layout: 'vertical',
              contents: [
                { type: 'text', text: 'æ‚¨çš„åŒ…è£¹é‚„æœªå–ä»¶', size: 'md' },
                { type: 'text', text: 'è«‹æ–¼ 3 æ—¥å…§å®Œæˆå–ä»¶', size: 'sm', color: '#718096', margin: 'md' }
              ]
            }
          }
        }
      };

      const template = templates[type];
      if (template) {
        document.getElementById('flexContent').value = JSON.stringify(template, null, 2);
        if (currentMessageType !== 'flex') {
          selectMessageType('flex');
          document.querySelectorAll('.type-option')[1].click();
        }
        updatePreview();
      }
    }

    // ç™¼é€è¨Šæ¯
    async function sendMessage() {
      if (!selectedCustomer) {
        alert('è«‹å…ˆé¸æ“‡é¡§å®¢');
        return;
      }

      const loading = document.getElementById('loading');
      const statusAlert = document.getElementById('statusAlert');
      
      try {
        loading.classList.add('active');
        statusAlert.innerHTML = '';

        let message;
        if (currentMessageType === 'text') {
          message = {
            type: 'text',
            text: document.getElementById('textContent').value
          };
        } else {
          message = JSON.parse(document.getElementById('flexContent').value);
        }

        console.log('ğŸ“¤ æº–å‚™ç™¼é€è¨Šæ¯:', message);

        // å‘¼å« Supabase RPC
        const { data, error } = await supabaseClient.rpc('send_line_notification', {
          p_line_user_id: selectedCustomer.line_user_id,
          p_message: message
        });

        if (error) throw error;

        console.log('âœ… ç™¼é€æˆåŠŸ:', data);

        // è¨˜éŒ„åˆ° line_notifications
        await supabaseClient.from('line_notifications').insert({
          line_user_id: selectedCustomer.line_user_id,
          phone: selectedCustomer.phone,
          notification_type: 'manual',
          message_content: currentMessageType === 'text' ? message.text : 'Flex Message',
          flex_message: currentMessageType === 'flex' ? message : null,
          status: 'sent'
        });

        statusAlert.innerHTML = `
          <div class="alert alert-success">
            âœ… è¨Šæ¯ç™¼é€æˆåŠŸï¼
          </div>
        `;

        // æ¸…é™¤å…§å®¹
        setTimeout(() => {
          clearContent();
        }, 2000);

      } catch (error) {
        console.error('âŒ ç™¼é€å¤±æ•—:', error);
        statusAlert.innerHTML = `
          <div class="alert alert-error">
            âŒ ç™¼é€å¤±æ•—ï¼š${error.message}
          </div>
        `;
      } finally {
        loading.classList.remove('active');
      }
    }

    // æ¸…é™¤å…§å®¹
    function clearContent() {
      document.getElementById('textContent').value = '';
      document.getElementById('flexContent').value = '';
      updatePreview();
    }

    // åˆå§‹åŒ–
    async function init() {
      const authOk = await checkAuth();
      if (!authOk) return;

      console.log('âœ… LINE è¨Šæ¯ç™¼é€é é¢å·²è¼‰å…¥');
    }

    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

